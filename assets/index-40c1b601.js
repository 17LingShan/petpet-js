var Nr=Object.defineProperty;var qr=(e,t,r)=>t in e?Nr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>(qr(e,typeof t!="symbol"?t+"":t,r),r),ot=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var c=(e,t,r)=>(ot(e,t,"read from private field"),r?r.call(e):t.get(e)),_=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},T=(e,t,r,a)=>(ot(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r);var ge=(e,t,r)=>(ot(e,t,"access private method"),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function r(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(i){if(i.ep)return;i.ep=!0;const n=r(i);fetch(i.href,n)}})();const Wr={server:["https://raw.githubusercontent.com/Dituon/petpet/main"]};const We=()=>document.createElement("div");var Be,Z,Ve,_r;class wr{constructor(t){_(this,Ve);_(this,Be,void 0);_(this,Z,void 0);T(this,Be,t)}show(){if(c(this,Z))return;const t=We();t.className="loading",t.append(We(),We(),We()),c(this,Be).appendChild(t),t.addEventListener("click",ge(this,Ve,_r)),T(this,Z,t)}hide(){c(this,Z)&&(c(this,Z).remove(),T(this,Z,null))}error(){let t="加载失败";throw c(this,Z).innerHTML=`<span>${t}</span>`,new Error(t)}}Be=new WeakMap,Z=new WeakMap,Ve=new WeakSet,_r=function(t){t.stopPropagation()};const lt=new class{constructor(){v(this,"element");v(this,"showing");v(this,"timer");this.element=document.createElement("div"),this.element.id="mask",document.body.appendChild(this.element),this.showing=!1}set onclick(e){this.timer||this.element.addEventListener("click",e)}show(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.element.style.pointerEvents="auto",this.element.style.display="block",setTimeout(()=>this.element.style.opacity="0.5",10)}hide(){this.element.style.opacity="0",this.element.style.pointerEvents="none",this.timer=setTimeout(()=>this.element.style.display="none",1e3)}toggle(){this.showing?this.hide():this.show()}};function De(e,t="h3"){const r=document.createElement(t);return r.textContent=e,r}var W,Le,ze,we,_e;class Gr{constructor(t){_(this,W,void 0);_(this,Le,void 0);_(this,ze,new Map);_(this,we,void 0);_(this,_e,void 0);t&&(this.templates=t)}set templates(t){T(this,W,document.createElement("div")),c(this,W).className="modal-select",T(this,Le,t);const r=document.createElement("div");r.className="index-list",T(this,we,r);for(const i of t){const n=document.createElement("div"),s=document.createElement("img");s.src=`${i.url}/0.png`,s.alt=i.key,s.loading="lazy";const o=De(i.key);i.alias&&i.alias.forEach(l=>o.appendChild(De(l,"span"))),n.append(s,o),n.addEventListener("click",async l=>{c(this,_e).call(this,await Xr(i)),this.hide()}),c(this,ze).set(i,n),r.appendChild(n)}const a=document.createElement("input");a.placeholder="🔍 type to search",a.addEventListener("change",i=>{this.search(a.value.trim())}),c(this,W).append(a,r),lt.onclick=()=>{this.hide(),c(this,_e).call(this,null)},c(this,W).classList.add("hide"),document.body.appendChild(c(this,W))}hide(){lt.hide(),c(this,W).classList.add("hide")}async show(){return c(this,Le)?(lt.show(),c(this,W)&&c(this,W).classList.remove("hide"),new Promise(t=>T(this,_e,t))):null}search(t){c(this,we).innerHTML="";for(let[r,a]of c(this,ze).entries()){const{key:i,alias:n}=r;!i.includes(t)&&!(n&&n.find(s=>s.includes(t)))||c(this,we).appendChild(a)}}}W=new WeakMap,Le=new WeakMap,ze=new WeakMap,we=new WeakMap,_e=new WeakMap;async function Xr(e){if(e.type)return e;const t=await fetch(e.url+"/data.json").then(r=>r.json());return{...e,...t}}var K,Ee,Me;class Hr{constructor(t){_(this,K,document.createElement("div"));_(this,Ee,void 0);v(this,"loading",new wr(c(this,K)));_(this,Me,void 0);if(T(this,Ee,new Gr(t)),c(this,K).id="template-chooser",c(this,K).textContent="Not Selected",c(this,K).addEventListener("click",async()=>{const r=this.showModal();c(this,Me)&&c(this,Me).call(this,r)}),!t){this.loading.show();return}this.templates=t}set templates(t){this.loading.hide(),c(this,Ee).templates=t}render(){const t=document.createElement("div");return t.append(De("Select Template"),c(this,K)),t}async showModal(){const t=await c(this,Ee).show();return t&&(c(this,K).textContent=t.key),t}set onchange(t){T(this,Me,t)}}K=new WeakMap,Ee=new WeakMap,Me=new WeakMap;class Vr{static from(){throw new Error}}function me(e,t){if(e.length!==t)throw new Error("array.length != "+t);return e}function mt(e,t=!1){const r=document.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:t});return r.width=e.width,r.height=e.height,a.drawImage(e,0,0),r}async function Er(e){return new Promise((t,r)=>{const a=new Image;a.onload=()=>t(a),a.onerror=i=>r(i),a.src=URL.createObjectURL(e)})}function Yr(e="#ffffff00"){if(typeof e=="string")return e.length<<2?"#"+e:e;if(e.length&&e.length>=3&&e.length<=4){const[t,r,a,i=1]=e;return`rgba(${t}, ${r}, ${a}, ${i})`}throw new Error("cannot load color "+e)}function Zr(e,t,r=!1){const a=document.createElement("canvas"),i=a.getContext("2d"),[n,s,o,l]=t.length===2?[0,0,t[0],t[1]]:t,u=r?o/100*e.width:o,d=r?l/100*e.height:l;return a.width=u,a.height=d,i.drawImage(e,n,s,u,d,0,0,u,d),a}function Kr(e){const t=document.createElement("canvas"),r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.translate(0,e.height),r.scale(1,-1),r.drawImage(e,0,0),t}function Qr(e){const t=document.createElement("canvas"),r=t.getContext("2d");t.width=e.width,t.height=e.height,r.drawImage(e,0,0);const a=r.getImageData(0,0,t.width,t.height),i=a.data;for(let n=0;n<i.length;n+=4){const s=i[n],o=i[n+1],l=i[n+2],u=(s+o+l)/3;i[n]=u,i[n+1]=u,i[n+2]=u}return r.putImageData(a,0,0),t}var Mr={},P={},yt={};Object.defineProperty(yt,"__esModule",{value:!0});var Jr=function(){function e(t,r){for(var a=0;a<r.length;a++){var i=r[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}();function jr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ea=function(){function e(t){jr(this,e);var r=t.length;this.xa=[],this.ya=[],this.u=[],this.y2=[],t.sort(function(l,u){return l[0]-u[0]});for(var a=0;a<r;a++)this.xa.push(t[a][0]),this.ya.push(t[a][1]);this.u[0]=0,this.y2[0]=0;for(var a=1;a<r-1;++a){var i=this.xa[a+1]-this.xa[a-1],n=(this.xa[a]-this.xa[a-1])/i,s=n*this.y2[a-1]+2;this.y2[a]=(n-1)/s;var o=(this.ya[a+1]-this.ya[a])/(this.xa[a+1]-this.xa[a])-(this.ya[a]-this.ya[a-1])/(this.xa[a]-this.xa[a-1]);this.u[a]=(6*o/i-n*this.u[a-1])/s}this.y2[r-1]=0;for(var a=r-2;a>=0;--a)this.y2[a]=this.y2[a]*this.y2[a+1]+this.u[a]}return Jr(e,[{key:"interpolate",value:function(r){for(var a=this.ya.length,i=0,n=a-1;n-i>1;){var s=n+i>>1;this.xa[s]>r?n=s:i=s}var o=this.xa[n]-this.xa[i],l=(this.xa[n]-r)/o,u=(r-this.xa[i])/o;return l*this.ya[i]+u*this.ya[n]+((l*l*l-l)*this.y2[i]+(u*u*u-u)*this.y2[n])*(o*o)/6}}]),e}();yt.default=ea;Object.defineProperty(P,"__esModule",{value:!0});P.simpleShader=ia;P.clamp=Tr;P.splineInterpolate=na;var ta=yt,ra=aa(ta);function aa(e){return e&&e.__esModule?e:{default:e}}function ia(e,t,r,a){(r||this._.texture).use(),this._.spareTexture.drawTo(function(){e.uniforms(t).drawRect()}),this._.spareTexture.swapWith(a||this._.texture)}function Tr(e,t,r){return Math.max(e,Math.min(t,r))}function na(e){for(var t=new ra.default(e),r=[],a=0;a<256;a++)r.push(Tr(0,Math.floor(t.interpolate(a/255)*256),255));return r}var A={};Object.defineProperty(A,"__esModule",{value:!0});A.set=sa;A.get=oa;var pt={};function sa(e){pt=Object.assign(pt,e)}function oa(e){return pt[e]}var xt={},O={};Object.defineProperty(O,"__esModule",{value:!0});var Jt=function(){function e(t,r){for(var a=0;a<r.length;a++){var i=r[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),la=A,oe=ua(la);function ua(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ha(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ca="attribute vec2 vertex;attribute vec2 _texCoord;varying vec2 texCoord;void main() {  texCoord = _texCoord;  gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);}",fa="uniform sampler2D texture;varying vec2 texCoord;void main() {  gl_FragColor = texture2D(texture, texCoord);}",da=function(){Jt(e,null,[{key:"getDefaultShader",value:function(){var r=oe.get("gl");return r.defaultShader=r.defaultShader||new e,r.defaultShader}}]);function e(t,r){ha(this,e);var a=oe.get("gl");if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=a.createProgram(),t=t||ca,r=r||fa,r="precision highp float;"+r,a.attachShader(this.program,jt(a.VERTEX_SHADER,t)),a.attachShader(this.program,jt(a.FRAGMENT_SHADER,r)),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program)}return Jt(e,[{key:"destroy",value:function(){var r=oe.get("gl");r.deleteProgram(this.program),this.program=null}},{key:"uniforms",value:function(r){var a=oe.get("gl");a.useProgram(this.program);for(var i in r)if(r.hasOwnProperty(i)){var n=a.getUniformLocation(this.program,i);if(n!==null){var s=r[i];if(pa(s))switch(s.length){case 1:a.uniform1fv(n,new Float32Array(s));break;case 2:a.uniform2fv(n,new Float32Array(s));break;case 3:a.uniform3fv(n,new Float32Array(s));break;case 4:a.uniform4fv(n,new Float32Array(s));break;case 9:a.uniformMatrix3fv(n,!1,new Float32Array(s));break;case 16:a.uniformMatrix4fv(n,!1,new Float32Array(s));break;default:throw`dont't know how to load uniform "`+i+'" of length '+s.length}else if(va(s))a.uniform1f(n,s);else throw'attempted to set uniform "'+i+'" to invalid value '+(s||"undefined").toString()}}return this}},{key:"textures",value:function(r){var a=oe.get("gl");a.useProgram(this.program);for(var i in r)r.hasOwnProperty(i)&&a.uniform1i(a.getUniformLocation(this.program,i),r[i]);return this}},{key:"drawRect",value:function(r,a,i,n){var s=oe.get("gl"),o=s.getParameter(s.VIEWPORT);a=a!==void 0?(a-o[1])/o[3]:0,r=r!==void 0?(r-o[0])/o[2]:0,i=i!==void 0?(i-o[0])/o[2]:1,n=n!==void 0?(n-o[1])/o[3]:1,s.vertexBuffer==null&&(s.vertexBuffer=s.createBuffer()),s.bindBuffer(s.ARRAY_BUFFER,s.vertexBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([r,a,r,n,i,a,i,n]),s.STATIC_DRAW),s.texCoordBuffer==null&&(s.texCoordBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,s.texCoordBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),s.STATIC_DRAW)),this.vertexAttribute==null&&(this.vertexAttribute=s.getAttribLocation(this.program,"vertex"),s.enableVertexAttribArray(this.vertexAttribute)),this.texCoordAttribute==null&&(this.texCoordAttribute=s.getAttribLocation(this.program,"_texCoord"),s.enableVertexAttribArray(this.texCoordAttribute)),s.useProgram(this.program),s.bindBuffer(s.ARRAY_BUFFER,s.vertexBuffer),s.vertexAttribPointer(this.vertexAttribute,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,s.texCoordBuffer),s.vertexAttribPointer(this.texCoordAttribute,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4)}}]),e}();O.default=da;function pa(e){return Object.prototype.toString.call(e)=="[object Array]"}function va(e){return Object.prototype.toString.call(e)=="[object Number]"}function jt(e,t){var r=oe.get("gl"),a=r.createShader(e);if(r.shaderSource(a,t),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS))throw"compile error: "+r.getShaderInfoLog(a);return a}Object.defineProperty(xt,"__esModule",{value:!0});var er=function(){function e(t,r){for(var a=0;a<r.length;a++){var i=r[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),ga=A,q=wa(ga),ma=O,ya=xa(ma);function xa(e){return e&&e.__esModule?e:{default:e}}function wa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function _a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Y=null,Ea=function(){er(e,null,[{key:"fromElement",value:function(r){var a=q.get("gl"),i=new e(0,0,a.RGBA,a.UNSIGNED_BYTE);return i.loadContentsOf(r),i}}]);function e(t,r,a,i){_a(this,e);var n=q.get("gl");this.gl=n,this.id=n.createTexture(),this.width=t,this.height=r,this.format=a,this.type=i,n.bindTexture(n.TEXTURE_2D,this.id),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),t&&r&&n.texImage2D(n.TEXTURE_2D,0,this.format,t,r,0,this.format,this.type,null)}return er(e,[{key:"loadContentsOf",value:function(r){var a=q.get("gl");this.width=r.width||r.videoWidth,this.height=r.height||r.videoHeight,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,this.format,this.format,this.type,r)}},{key:"initFromBytes",value:function(r,a,i){var n=q.get("gl");this.width=r,this.height=a,this.format=n.RGBA,this.type=n.UNSIGNED_BYTE,n.bindTexture(n.TEXTURE_2D,this.id),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,r,a,0,n.RGBA,this.type,new Uint8Array(i))}},{key:"destroy",value:function(){var r=q.get("gl");r.deleteTexture(this.id),this.id=null}},{key:"use",value:function(r){var a=q.get("gl");a.activeTexture(a.TEXTURE0+(r||0)),a.bindTexture(a.TEXTURE_2D,this.id)}},{key:"unuse",value:function(r){var a=q.get("gl");a.activeTexture(a.TEXTURE0+(r||0)),a.bindTexture(a.TEXTURE_2D,null)}},{key:"ensureFormat",value:function(r,a,i,n){if(arguments.length==1){var s=arguments[0];r=s.width,a=s.height,i=s.format,n=s.type}if(r!=this.width||a!=this.height||i!=this.format||n!=this.type){var o=q.get("gl");this.width=r,this.height=a,this.format=i,this.type=n,o.bindTexture(o.TEXTURE_2D,this.id),o.texImage2D(o.TEXTURE_2D,0,this.format,r,a,0,this.format,this.type,null)}}},{key:"drawTo",value:function(r){var a=q.get("gl");if(a.framebuffer=a.framebuffer||a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,a.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.id,0),a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");a.viewport(0,0,this.width,this.height),r(),a.bindFramebuffer(a.FRAMEBUFFER,null)}},{key:"fillUsingCanvas",value:function(r){r(tr(this));var a=q.get("gl");return this.format=a.RGBA,this.type=a.UNSIGNED_BYTE,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,Y),this}},{key:"toImage",value:function(r){this.use(),ya.default.getDefaultShader().drawRect();var a=q.get("gl"),i=this.width*this.height*4,n=new Uint8Array(i),s=tr(this),o=s.createImageData(this.width,this.height);a.readPixels(0,0,this.width,this.height,a.RGBA,a.UNSIGNED_BYTE,n);for(var l=0;l<i;l++)o.data[l]=n[l];s.putImageData(o,0,0),r.src=Y.toDataURL()}},{key:"swapWith",value:function(r){var a;a=r.id,r.id=this.id,this.id=a,a=r.width,r.width=this.width,this.width=a,a=r.height,r.height=this.height,this.height=a,a=r.format,r.format=this.format,this.format=a}}]),e}();xt.default=Ea;function tr(e){Y==null&&(Y=document.createElement("canvas")),Y.width=e.width,Y.height=e.height;var t=Y.getContext("2d");return t.clearRect(0,0,Y.width,Y.height),t}var Ar={},wt={};Object.defineProperty(wt,"__esModule",{value:!0});wt.default=function(e,t){var r=Ca.get("gl");return r.brightnessContrast=r.brightnessContrast||new Ta.default(null,"    uniform sampler2D texture;    uniform float brightness;    uniform float contrast;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color.rgb += brightness;      if (contrast > 0.0) {        color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;      } else {        color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;      }      gl_FragColor = color;    }  "),ut.simpleShader.call(this,r.brightnessContrast,{brightness:(0,ut.clamp)(-1,e,1),contrast:(0,ut.clamp)(-1,t,1)}),this};var Ma=O,Ta=Sa(Ma),ut=P,Aa=A,Ca=Pa(Aa);function Pa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Sa(e){return e&&e.__esModule?e:{default:e}}var _t={};Object.defineProperty(_t,"__esModule",{value:!0});_t.default=function(e,t,r){var a=ka.get("gl");e=(0,Ge.splineInterpolate)(e),arguments.length==1?t=r=e:(t=(0,Ge.splineInterpolate)(t),r=(0,Ge.splineInterpolate)(r));for(var i=[],n=0;n<256;n++)i.splice(i.length,0,e[n],t[n],r[n],255);return this._.extraTexture.initFromBytes(256,1,i),this._.extraTexture.use(1),a.curves=a.curves||new ba.default(null,"    uniform sampler2D texture;    uniform sampler2D map;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color.r = texture2D(map, vec2(color.r)).r;      color.g = texture2D(map, vec2(color.g)).g;      color.b = texture2D(map, vec2(color.b)).b;      gl_FragColor = color;    }  "),a.curves.textures({map:1}),Ge.simpleShader.call(this,a.curves,{}),this};var Oa=O,ba=Ia(Oa),Ge=P,Ra=A,ka=$a(Ra);function $a(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ia(e){return e&&e.__esModule?e:{default:e}}var Et={};Object.defineProperty(Et,"__esModule",{value:!0});Et.default=function(e){var t=za.get("gl");t.denoise=t.denoise||new Fa.default(null,"    uniform sampler2D texture;    uniform float exponent;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec4 center = texture2D(texture, texCoord);      vec4 color = vec4(0.0);      float total = 0.0;      for (float x = -4.0; x <= 4.0; x += 1.0) {        for (float y = -4.0; y <= 4.0; y += 1.0) {          vec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);          float weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));          weight = pow(weight, exponent);          color += sample * weight;          total += weight;        }      }      gl_FragColor = color / total;    }  ");for(var r=0;r<2;r++)Ba.simpleShader.call(this,t.denoise,{exponent:Math.max(0,e),texSize:[this.width,this.height]});return this};var Da=O,Fa=Na(Da),Ba=P,La=A,za=Ua(La);function Ua(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Na(e){return e&&e.__esModule?e:{default:e}}var Mt={};Object.defineProperty(Mt,"__esModule",{value:!0});Mt.default=function(e,t){var r=Xa.get("gl");return r.hueSaturation=r.hueSaturation||new Wa.default(null,"    uniform sampler2D texture;    uniform float hue;    uniform float saturation;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);            /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */      float angle = hue * 3.14159265;      float s = sin(angle), c = cos(angle);      vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;      float len = length(color.rgb);      color.rgb = vec3(        dot(color.rgb, weights.xyz),        dot(color.rgb, weights.zxy),        dot(color.rgb, weights.yzx)      );            /* saturation adjustment */      float average = (color.r + color.g + color.b) / 3.0;      if (saturation > 0.0) {        color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));      } else {        color.rgb += (average - color.rgb) * (-saturation);      }            gl_FragColor = color;    }  "),ht.simpleShader.call(this,r.hueSaturation,{hue:(0,ht.clamp)(-1,e,1),saturation:(0,ht.clamp)(-1,t,1)}),this};var qa=O,Wa=Va(qa),ht=P,Ga=A,Xa=Ha(Ga);function Ha(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Va(e){return e&&e.__esModule?e:{default:e}}var Tt={};Object.defineProperty(Tt,"__esModule",{value:!0});Tt.default=function(e){var t=Qa.get("gl");return t.noise=t.noise||new Za.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    float rand(vec2 co) {      return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);    }    void main() {      vec4 color = texture2D(texture, texCoord);            float diff = (rand(texCoord) - 0.5) * amount;      color.r += diff;      color.g += diff;      color.b += diff;            gl_FragColor = color;    }  "),rr.simpleShader.call(this,t.noise,{amount:(0,rr.clamp)(0,e,1)}),this};var Ya=O,Za=ja(Ya),rr=P,Ka=A,Qa=Ja(Ka);function Ja(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ja(e){return e&&e.__esModule?e:{default:e}}var At={};Object.defineProperty(At,"__esModule",{value:!0});At.default=function(e){var t=ai.get("gl");return t.sepia=t.sepia||new ti.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      float r = color.r;      float g = color.g;      float b = color.b;            color.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));      color.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));      color.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));            gl_FragColor = color;    }  "),ar.simpleShader.call(this,t.sepia,{amount:(0,ar.clamp)(0,e,1)}),this};var ei=O,ti=ni(ei),ar=P,ri=A,ai=ii(ri);function ii(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ni(e){return e&&e.__esModule?e:{default:e}}var Ct={};Object.defineProperty(Ct,"__esModule",{value:!0});Ct.default=function(e,t){var r=ui.get("gl");return r.unsharpMask=r.unsharpMask||new ir.default(null,"    uniform sampler2D blurredTexture;    uniform sampler2D originalTexture;    uniform float strength;    uniform float threshold;    varying vec2 texCoord;    void main() {      vec4 blurred = texture2D(blurredTexture, texCoord);      vec4 original = texture2D(originalTexture, texCoord);      gl_FragColor = mix(blurred, original, 1.0 + strength);    }  "),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo(function(){ir.default.getDefaultShader().drawRect()}),this._.extraTexture.use(1),this.triangleBlur(e),r.unsharpMask.textures({originalTexture:1}),oi.simpleShader.call(this,r.unsharpMask,{strength:t}),this._.extraTexture.unuse(1),this};var si=O,ir=ci(si),oi=P,li=A,ui=hi(li);function hi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ci(e){return e&&e.__esModule?e:{default:e}}var Pt={};Object.defineProperty(Pt,"__esModule",{value:!0});Pt.default=function(e){var t=vi.get("gl");return t.vibrance=t.vibrance||new di.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      float average = (color.r + color.g + color.b) / 3.0;      float mx = max(color.r, max(color.g, color.b));      float amt = (mx - average) * (-amount * 3.0);      color.rgb = mix(color.rgb, vec3(mx), amt);      gl_FragColor = color;    }  "),nr.simpleShader.call(this,t.vibrance,{amount:(0,nr.clamp)(-1,e,1)}),this};var fi=O,di=mi(fi),nr=P,pi=A,vi=gi(pi);function gi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function mi(e){return e&&e.__esModule?e:{default:e}}var St={};Object.defineProperty(St,"__esModule",{value:!0});St.default=function(e,t){var r=_i.get("gl");return r.vignette=r.vignette||new xi.default(null,"    uniform sampler2D texture;    uniform float size;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);            float dist = distance(texCoord, vec2(0.5, 0.5));      color.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));            gl_FragColor = color;    }  "),ct.simpleShader.call(this,r.vignette,{size:(0,ct.clamp)(0,e,1),amount:(0,ct.clamp)(0,t,1)}),this};var yi=O,xi=Mi(yi),ct=P,wi=A,_i=Ei(wi);function Ei(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Mi(e){return e&&e.__esModule?e:{default:e}}var Ot={},N={};Object.defineProperty(N,"__esModule",{value:!0});N.randomShaderFunc=void 0;N.warpShader=Pi;var Ti=O,Ai=Ci(Ti);function Ci(e){return e&&e.__esModule?e:{default:e}}function Pi(e,t){return new Ai.default(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 coord = texCoord * texSize;      "+t+"      gl_FragColor = texture2D(texture, coord / texSize);      vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);      if (coord != clampedCoord) {        /* fade to transparent if we are outside the image */        gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));      }    }")}N.randomShaderFunc="  float random(vec3 scale, float seed) {    /* use the fragment position for a different seed per-pixel */    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);  }";Object.defineProperty(Ot,"__esModule",{value:!0});Ot.default=function(e,t,r){var a=Ri.get("gl");a.lensBlurPrePass=a.lensBlurPrePass||new Xe.default(null,"    uniform sampler2D texture;    uniform float power;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color = pow(color, vec4(power));      gl_FragColor = vec4(color);    }  ");var i="    uniform sampler2D texture0;    uniform sampler2D texture1;    uniform vec2 delta0;    uniform vec2 delta1;    uniform float power;    varying vec2 texCoord;    "+Oi.randomShaderFunc+"    vec4 sample(vec2 delta) {      /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(delta, 151.7182), 0.0);            vec4 color = vec4(0.0);      float total = 0.0;      for (float t = 0.0; t <= 30.0; t++) {        float percent = (t + offset) / 30.0;        color += texture2D(texture0, texCoord + delta * percent);        total += 1.0;      }      return color / total;    }  ";a.lensBlur0=a.lensBlur0||new Xe.default(null,i+"    void main() {      gl_FragColor = sample(delta0);    }  "),a.lensBlur1=a.lensBlur1||new Xe.default(null,i+"    void main() {      gl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;    }  "),a.lensBlur2=a.lensBlur2||new Xe.default(null,i+"    void main() {      vec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;      gl_FragColor = pow(color, vec4(power));    }  ").textures({texture1:1});for(var n=[],s=0;s<3;s++){var o=r+s*Math.PI*2/3;n.push([e*Math.sin(o)/this.width,e*Math.cos(o)/this.height])}var l=Math.pow(10,(0,ye.clamp)(-1,t,1));return ye.simpleShader.call(this,a.lensBlurPrePass,{power:l}),this._.extraTexture.ensureFormat(this._.texture),ye.simpleShader.call(this,a.lensBlur0,{delta0:n[0]},this._.texture,this._.extraTexture),ye.simpleShader.call(this,a.lensBlur1,{delta0:n[1],delta1:n[2]},this._.extraTexture,this._.extraTexture),ye.simpleShader.call(this,a.lensBlur0,{delta0:n[1]}),this._.extraTexture.use(1),ye.simpleShader.call(this,a.lensBlur2,{power:1/l,delta0:n[2]}),this};var Si=O,Xe=$i(Si),ye=P,Oi=N,bi=A,Ri=ki(bi);function ki(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function $i(e){return e&&e.__esModule?e:{default:e}}var bt={};Object.defineProperty(bt,"__esModule",{value:!0});bt.default=function(e,t,r,a,i,n){var s=Li.get("gl");s.tiltShift=s.tiltShift||new Di.default(null,"    uniform sampler2D texture;    uniform float blurRadius;    uniform float gradientRadius;    uniform vec2 start;    uniform vec2 end;    uniform vec2 delta;    uniform vec2 texSize;    varying vec2 texCoord;    "+Fi.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));      float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;      for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  ");var o=r-e,l=a-t,u=Math.sqrt(o*o+l*l);return sr.simpleShader.call(this,s.tiltShift,{blurRadius:i,gradientRadius:n,start:[e,t],end:[r,a],delta:[o/u,l/u],texSize:[this.width,this.height]}),sr.simpleShader.call(this,s.tiltShift,{blurRadius:i,gradientRadius:n,start:[e,t],end:[r,a],delta:[-l/u,o/u],texSize:[this.width,this.height]}),this};var Ii=O,Di=Ui(Ii),sr=P,Fi=N,Bi=A,Li=zi(Bi);function zi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ui(e){return e&&e.__esModule?e:{default:e}}var Rt={};Object.defineProperty(Rt,"__esModule",{value:!0});Rt.default=function(e){var t=Xi.get("gl");return t.triangleBlur=t.triangleBlur||new qi.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+Wi.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec4 sample = texture2D(texture, texCoord + delta * percent);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  "),or.simpleShader.call(this,t.triangleBlur,{delta:[e/this.width,0]}),or.simpleShader.call(this,t.triangleBlur,{delta:[0,e/this.height]}),this};var Ni=O,qi=Vi(Ni),or=P,Wi=N,Gi=A,Xi=Hi(Gi);function Hi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Vi(e){return e&&e.__esModule?e:{default:e}}var kt={};Object.defineProperty(kt,"__esModule",{value:!0});kt.default=function(e,t,r){var a=ji.get("gl");return a.zoomBlur=a.zoomBlur||new Zi.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    "+Qi.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;      vec2 toCenter = center - texCoord * texSize;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = 0.0; t <= 40.0; t++) {        float percent = (t + offset) / 40.0;        float weight = 4.0 * (percent - percent * percent);        vec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  "),Ki.simpleShader.call(this,a.zoomBlur,{center:[e,t],strength:r,texSize:[this.width,this.height]}),this};var Yi=O,Zi=tn(Yi),Ki=P,Qi=N,Ji=A,ji=en(Ji);function en(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function tn(e){return e&&e.__esModule?e:{default:e}}var $t={};Object.defineProperty($t,"__esModule",{value:!0});$t.default=function(e,t,r,a){var i=on.get("gl");return i.colorHalftone=i.colorHalftone||new an.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float angle;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;        float pattern(float angle) {      float s = sin(angle), c = cos(angle);      vec2 tex = texCoord * texSize - center;      vec2 point = vec2(        c * tex.x - s * tex.y,        s * tex.x + c * tex.y      ) * scale;      return (sin(point.x) * sin(point.y)) * 4.0;    }        void main() {      vec4 color = texture2D(texture, texCoord);      vec3 cmy = 1.0 - color.rgb;      float k = min(cmy.x, min(cmy.y, cmy.z));      cmy = (cmy - k) / (1.0 - k);      cmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);      k = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);      gl_FragColor = vec4(1.0 - cmy - k, color.a);    }  "),nn.simpleShader.call(this,i.colorHalftone,{center:[e,t],angle:r,scale:Math.PI/a,texSize:[this.width,this.height]}),this};var rn=O,an=un(rn),nn=P,sn=A,on=ln(sn);function ln(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function un(e){return e&&e.__esModule?e:{default:e}}var It={};Object.defineProperty(It,"__esModule",{value:!0});It.default=function(e,t,r,a){var i=pn.get("gl");return i.dotScreen=i.dotScreen||new cn.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float angle;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;        float pattern() {      float s = sin(angle), c = cos(angle);      vec2 tex = texCoord * texSize - center;      vec2 point = vec2(        c * tex.x - s * tex.y,        s * tex.x + c * tex.y      ) * scale;      return (sin(point.x) * sin(point.y)) * 4.0;    }        void main() {      vec4 color = texture2D(texture, texCoord);      float average = (color.r + color.g + color.b) / 3.0;      gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);    }  "),fn.simpleShader.call(this,i.dotScreen,{center:[e,t],angle:r,scale:Math.PI/a,texSize:[this.width,this.height]}),this};var hn=O,cn=gn(hn),fn=P,dn=A,pn=vn(dn);function vn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function gn(e){return e&&e.__esModule?e:{default:e}}var Dt={};Object.defineProperty(Dt,"__esModule",{value:!0});Dt.default=function(e){var t=xn.get("gl");return t.edgeWork1=t.edgeWork1||new lr.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+hr.randomShaderFunc+"    void main() {      vec2 color = vec2(0.0);      vec2 total = vec2(0.0);            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec3 sample = texture2D(texture, texCoord + delta * percent).rgb;        float average = (sample.r + sample.g + sample.b) / 3.0;        color.x += average * weight;        total.x += weight;        if (abs(t) < 15.0) {          weight = weight * 2.0 - 1.0;          color.y += average * weight;          total.y += weight;        }      }      gl_FragColor = vec4(color / total, 0.0, 1.0);    }  "),t.edgeWork2=t.edgeWork2||new lr.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+hr.randomShaderFunc+"    void main() {      vec2 color = vec2(0.0);      vec2 total = vec2(0.0);            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec2 sample = texture2D(texture, texCoord + delta * percent).xy;        color.x += sample.x * weight;        total.x += weight;        if (abs(t) < 15.0) {          weight = weight * 2.0 - 1.0;          color.y += sample.y * weight;          total.y += weight;        }      }      float c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);      gl_FragColor = vec4(c, c, c, 1.0);    }  "),ur.simpleShader.call(this,t.edgeWork1,{delta:[e/this.width,0]}),ur.simpleShader.call(this,t.edgeWork2,{delta:[0,e/this.height]}),this};var mn=O,lr=_n(mn),ur=P,hr=N,yn=A,xn=wn(yn);function wn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function _n(e){return e&&e.__esModule?e:{default:e}}var Ft={};Object.defineProperty(Ft,"__esModule",{value:!0});Ft.default=function(e,t,r){var a=Cn.get("gl");return a.hexagonalPixelate=a.hexagonalPixelate||new Mn.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 tex = (texCoord * texSize - center) / scale;      tex.y /= 0.866025404;      tex.x -= tex.y * 0.5;            vec2 a;      if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));      else a = vec2(ceil(tex.x), ceil(tex.y));      vec2 b = vec2(ceil(tex.x), floor(tex.y));      vec2 c = vec2(floor(tex.x), ceil(tex.y));            vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);      vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);      vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);      vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);            float alen = length(TEX - A);      float blen = length(TEX - B);      float clen = length(TEX - C);            vec2 choice;      if (alen < blen) {        if (alen < clen) choice = a;        else choice = c;      } else {        if (blen < clen) choice = b;        else choice = c;      }            choice.x += choice.y * 0.5;      choice.y *= 0.866025404;      choice *= scale / texSize;      gl_FragColor = texture2D(texture, choice + center / texSize);    }  "),Tn.simpleShader.call(this,a.hexagonalPixelate,{center:[e,t],scale:r,texSize:[this.width,this.height]}),this};var En=O,Mn=Sn(En),Tn=P,An=A,Cn=Pn(An);function Pn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Sn(e){return e&&e.__esModule?e:{default:e}}var Bt={};Object.defineProperty(Bt,"__esModule",{value:!0});Bt.default=function(e){var t=$n.get("gl");return t.ink=t.ink||new bn.default(null,"    uniform sampler2D texture;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 dx = vec2(1.0 / texSize.x, 0.0);      vec2 dy = vec2(0.0, 1.0 / texSize.y);      vec4 color = texture2D(texture, texCoord);      float bigTotal = 0.0;      float smallTotal = 0.0;      vec3 bigAverage = vec3(0.0);      vec3 smallAverage = vec3(0.0);      for (float x = -2.0; x <= 2.0; x += 1.0) {        for (float y = -2.0; y <= 2.0; y += 1.0) {          vec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;          bigAverage += sample;          bigTotal += 1.0;          if (abs(x) + abs(y) < 2.0) {            smallAverage += sample;            smallTotal += 1.0;          }        }      }      vec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);      gl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);    }  "),Rn.simpleShader.call(this,t.ink,{strength:e*e*e*e*e,texSize:[this.width,this.height]}),this};var On=O,bn=Dn(On),Rn=P,kn=A,$n=In(kn);function In(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Dn(e){return e&&e.__esModule?e:{default:e}}var Lt={};Object.defineProperty(Lt,"__esModule",{value:!0});Lt.default=function(e,t,r,a){var i=Ln.get("gl");return i.bulgePinch=i.bulgePinch||(0,Fn.warpShader)("    uniform float radius;    uniform float strength;    uniform vec2 center;  ","    coord -= center;    float distance = length(coord);    if (distance < radius) {      float percent = distance / radius;      if (strength > 0.0) {        coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);      } else {        coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);      }    }    coord += center;  "),cr.simpleShader.call(this,i.bulgePinch,{radius:r,strength:(0,cr.clamp)(-1,a,1),center:[e,t],texSize:[this.width,this.height]}),this};var Fn=N,cr=P,Bn=A,Ln=zn(Bn);function zn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var zt={},Re={};Object.defineProperty(Re,"__esModule",{value:!0});Re.getSquareToQuad=Un;Re.getInverse=Nn;Re.multiply=qn;function Un(e,t,r,a,i,n,s,o){var l=r-i,u=a-n,d=s-i,g=o-n,h=e-r+i-s,m=t-a+n-o,x=l*g-d*u,M=(h*g-d*m)/x,k=(l*m-h*u)/x;return[r-e+M*r,a-t+M*a,M,s-e+k*s,o-t+k*o,k,e,t,1]}function Nn(e){var t=e[0],r=e[1],a=e[2],i=e[3],n=e[4],s=e[5],o=e[6],l=e[7],u=e[8],d=t*n*u-t*s*l-r*i*u+r*s*o+a*i*l-a*n*o;return[(n*u-s*l)/d,(a*l-r*u)/d,(r*s-a*n)/d,(s*o-i*u)/d,(t*u-a*o)/d,(a*i-t*s)/d,(i*l-n*o)/d,(r*o-t*l)/d,(t*n-r*i)/d]}function qn(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}Object.defineProperty(zt,"__esModule",{value:!0});zt.default=function(e,t,r){var a=Vn.get("gl");if(a.matrixWarp=a.matrixWarp||(0,Wn.warpShader)("    uniform mat3 matrix;    uniform bool useTextureSpace;  ","    if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;    vec3 warp = matrix * vec3(coord, 1.0);    coord = warp.xy / warp.z;    if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;  "),e=Array.prototype.concat.apply([],e),e.length==4)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(e.length!=9)throw"can only warp with 2x2 or 3x3 matrix";return Xn.simpleShader.call(this,a.matrixWarp,{matrix:t?(0,Gn.getInverse)(e):e,texSize:[this.width,this.height],useTextureSpace:r|0}),this};var Wn=N,Gn=Re,Xn=P,Hn=A,Vn=Yn(Hn);function Yn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var Ut={};Object.defineProperty(Ut,"__esModule",{value:!0});Ut.default=function(e,t){var r=He.getSquareToQuad.apply(null,t),a=He.getSquareToQuad.apply(null,e),i=(0,He.multiply)((0,He.getInverse)(r),a);return this.matrixWarp(i)};var He=Re,Nt={};Object.defineProperty(Nt,"__esModule",{value:!0});Nt.default=function(e,t,r,a){var i=Jn.get("gl");return i.swirl=i.swirl||(0,Zn.warpShader)("    uniform float radius;    uniform float angle;    uniform vec2 center;  ","    coord -= center;    float distance = length(coord);    if (distance < radius) {      float percent = (radius - distance) / radius;      float theta = percent * percent * angle;      float s = sin(theta);      float c = cos(theta);      coord = vec2(        coord.x * c - coord.y * s,        coord.x * s + coord.y * c      );    }    coord += center;  "),Kn.simpleShader.call(this,i.swirl,{radius:r,center:[e,t],angle:a,texSize:[this.width,this.height]}),this};var Zn=N,Kn=P,Qn=A,Jn=jn(Qn);function jn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=wt;Object.defineProperty(e,"brightnessContrast",{enumerable:!0,get:function(){return y(t).default}});var r=_t;Object.defineProperty(e,"curves",{enumerable:!0,get:function(){return y(r).default}});var a=Et;Object.defineProperty(e,"denoise",{enumerable:!0,get:function(){return y(a).default}});var i=Mt;Object.defineProperty(e,"hueSaturation",{enumerable:!0,get:function(){return y(i).default}});var n=Tt;Object.defineProperty(e,"noise",{enumerable:!0,get:function(){return y(n).default}});var s=At;Object.defineProperty(e,"sepia",{enumerable:!0,get:function(){return y(s).default}});var o=Ct;Object.defineProperty(e,"unsharpMask",{enumerable:!0,get:function(){return y(o).default}});var l=Pt;Object.defineProperty(e,"vibrance",{enumerable:!0,get:function(){return y(l).default}});var u=St;Object.defineProperty(e,"vignette",{enumerable:!0,get:function(){return y(u).default}});var d=Ot;Object.defineProperty(e,"lensBlur",{enumerable:!0,get:function(){return y(d).default}});var g=bt;Object.defineProperty(e,"tiltShift",{enumerable:!0,get:function(){return y(g).default}});var h=Rt;Object.defineProperty(e,"triangleBlur",{enumerable:!0,get:function(){return y(h).default}});var m=kt;Object.defineProperty(e,"zoomBlur",{enumerable:!0,get:function(){return y(m).default}});var x=$t;Object.defineProperty(e,"colorHalftone",{enumerable:!0,get:function(){return y(x).default}});var M=It;Object.defineProperty(e,"dotScreen",{enumerable:!0,get:function(){return y(M).default}});var k=Dt;Object.defineProperty(e,"edgeWork",{enumerable:!0,get:function(){return y(k).default}});var I=Ft;Object.defineProperty(e,"hexagonalPixelate",{enumerable:!0,get:function(){return y(I).default}});var B=Bt;Object.defineProperty(e,"ink",{enumerable:!0,get:function(){return y(B).default}});var D=Lt;Object.defineProperty(e,"bulgePinch",{enumerable:!0,get:function(){return y(D).default}});var w=zt;Object.defineProperty(e,"matrixWarp",{enumerable:!0,get:function(){return y(w).default}});var $=Ut;Object.defineProperty(e,"perspective",{enumerable:!0,get:function(){return y($).default}});var f=Nt;Object.defineProperty(e,"swirl",{enumerable:!0,get:function(){return y(f).default}});function y(p){return p&&p.__esModule?p:{default:p}}})(Ar);(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.splineInterpolate=void 0;var t=P;Object.defineProperty(e,"splineInterpolate",{enumerable:!0,get:function(){return t.splineInterpolate}}),e.canvas=$;var r=A,a=g(r),i=xt,n=d(i),s=O,o=d(s),l=Ar,u=g(l);function d(f){return f&&f.__esModule?f:{default:f}}function g(f){if(f&&f.__esModule)return f;var y={};if(f!=null)for(var p in f)Object.prototype.hasOwnProperty.call(f,p)&&(y[p]=f[p]);return y.default=f,y}function h(f){return{_:f,loadContentsOf:function(p){a.set({gl:this._.gl}),this._.loadContentsOf(p)},destroy:function(){a.set({gl:this._.gl}),this._.destroy()}}}function m(f){return h(n.default.fromElement(f))}function x(f,y){var p=a.get("gl"),L=p.UNSIGNED_BYTE;if(p.getExtension("OES_texture_float")&&p.getExtension("OES_texture_float_linear")){var se=new n.default(100,100,p.RGBA,p.FLOAT);try{se.drawTo(function(){L=p.FLOAT})}catch{}se.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=f,this.height=y,this._.texture=new n.default(f,y,p.RGBA,L),this._.spareTexture=new n.default(f,y,p.RGBA,L),this._.extraTexture=this._.extraTexture||new n.default(0,0,p.RGBA,L),this._.flippedShader=this._.flippedShader||new o.default(null,"	    uniform sampler2D texture;	    varying vec2 texCoord;	    void main() {	      gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));	    }	  "),this._.isInitialized=!0}function M(f,y,p){return(!this._.isInitialized||f._.width!=this.width||f._.height!=this.height)&&x.call(this,y||f._.width,p||f._.height),f._.use(),this._.texture.drawTo(function(){o.default.getDefaultShader().drawRect()}),this}function k(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function I(f){return f.parentNode.insertBefore(this,f),f.parentNode.removeChild(f),this}function B(){var f=a.get("gl"),y=new n.default(this._.texture.width,this._.texture.height,f.RGBA,f.UNSIGNED_BYTE);return this._.texture.use(),y.drawTo(function(){o.default.getDefaultShader().drawRect()}),h(y)}function D(){var f=a.get("gl"),y=this._.texture.width,p=this._.texture.height,L=new Uint8Array(y*p*4);return this._.texture.drawTo(function(){f.readPixels(0,0,y,p,f.RGBA,f.UNSIGNED_BYTE,L)}),L}function w(f){return function(){return a.set({gl:this._.gl}),f.apply(this,arguments)}}function $(){var f=arguments.length>0&&arguments[0]!==void 0?arguments[0]:document.createElement("canvas");try{a.set({gl:f.getContext("experimental-webgl",{premultipliedAlpha:!1})})}catch{a.set({gl:null})}var y=a.get("gl");if(!y)throw"This browser does not support WebGL";return f._={gl:y,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},f.texture=w(m),f.draw=w(M),f.update=w(k),f.replace=w(I),f.contents=w(B),f.getPixelArray=w(D),f.brightnessContrast=w(u.brightnessContrast),f.hexagonalPixelate=w(u.hexagonalPixelate),f.hueSaturation=w(u.hueSaturation),f.colorHalftone=w(u.colorHalftone),f.triangleBlur=w(u.triangleBlur),f.unsharpMask=w(u.unsharpMask),f.perspective=w(u.perspective),f.matrixWarp=w(u.matrixWarp),f.bulgePinch=w(u.bulgePinch),f.tiltShift=w(u.tiltShift),f.dotScreen=w(u.dotScreen),f.edgeWork=w(u.edgeWork),f.lensBlur=w(u.lensBlur),f.zoomBlur=w(u.zoomBlur),f.noise=w(u.noise),f.denoise=w(u.denoise),f.curves=w(u.curves),f.swirl=w(u.swirl),f.ink=w(u.ink),f.vignette=w(u.vignette),f.vibrance=w(u.vibrance),f.sepia=w(u.sepia),f}})(Mr);class es{constructor(t=!0){v(this,"fxCanvas",Mr.canvas());v(this,"textureMap",new Map);v(this,"cache");this.cache=t}draw(t,r,a){const i=this.cache&&this.textureMap.has(r)?this.textureMap.get(r):this.fxCanvas.texture(r);this.cache&&!this.textureMap.has(r)&&this.textureMap.set(r,i);let[n,s]=a[0],[o,l]=a[1],[u,d]=a[2],[g,h]=a[3];const[m,x]=a[4];n+=m,o+=m,u+=m,g+=m,s+=x,l+=x,d+=x,h+=x;const M=t.canvas;this.fxCanvas.draw(i,M.width,M.height).perspective([0,0,M.width,0,0,M.height,M.width,M.height],[n,s,g,h,o,l,u,d]).update(),t.drawImage(this.fxCanvas,0,0),this.cache||i.destroy()}destroy(){if(this.cache)for(const t of[...this.textureMap.values()])t.destroy()}}function ts(e){const t=document.createElement("canvas"),r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.translate(e.width,0),r.scale(-1,1),r.drawImage(e,0,0),t}function rs(e){const t=document.createElement("canvas"),r=t.getContext("2d"),a=e.width,i=e.height;t.width=a,t.height=i,r.drawImage(e,0,0);const n=r.getImageData(0,0,a,i),s=n.data;for(let o=0;o<s.length;o+=4){const l=s[o],u=s[o+1],d=s[o+2];l+u+d>383?(s[o]=255,s[o+1]=255,s[o+2]=255):(s[o]=0,s[o+1]=0,s[o+2]=0)}return r.putImageData(n,0,0),t}function as(e){const t=document.createElement("canvas"),r=t.getContext("2d"),a=Math.min(e.width,e.height)/2;return t.width=a*2,t.height=a*2,r.save(),r.beginPath(),r.arc(a,a,a,0,2*Math.PI),r.closePath(),r.clip(),r.drawImage(e,a-e.width/2,a-e.height/2),r.restore(),t}function is(e,t){const r=Math.abs(Math.sin(t*Math.PI/180)),a=Math.abs(Math.cos(t*Math.PI/180)),i=e.width,n=e.height,s=Math.floor(i*a+n*r),o=Math.floor(n*a+i*r),l=document.createElement("canvas"),u=l.getContext("2d");return l.width=s,l.height=o,u.translate(s/2,o/2),u.rotate(t*Math.PI/180),u.drawImage(e,-i/2,-n/2),l}var U="INUMBER",ke="IOP1",$e="IOP2",Ie="IOP3",ee="IVAR",pe="IVARNAME",Se="IFUNCALL",je="IFUNDEF",F="IEXPR",qt="IEXPREVAL",ve="IMEMBER",et="IENDSTATEMENT",Oe="IARRAY";function E(e,t){this.type=e,this.value=t??0}E.prototype.toString=function(){switch(this.type){case U:case ke:case $e:case Ie:case ee:case pe:case et:return this.value;case Se:return"CALL "+this.value;case je:return"DEF "+this.value;case Oe:return"ARRAY "+this.value;case ve:return"."+this.value;default:return"Invalid Instruction"}};function tt(e){return new E(ke,e)}function ae(e){return new E($e,e)}function Cr(e){return new E(Ie,e)}function vt(e,t,r,a,i){for(var n=[],s=[],o,l,u,d,g=0;g<e.length;g++){var h=e[g],m=h.type;if(m===U||m===pe)Array.isArray(h.value)?n.push.apply(n,vt(h.value.map(function(x){return new E(U,x)}).concat(new E(Oe,h.value.length)),t,r,a,i)):n.push(h);else if(m===ee&&i.hasOwnProperty(h.value))h=new E(U,i[h.value]),n.push(h);else if(m===$e&&n.length>1)l=n.pop(),o=n.pop(),d=r[h.value],h=new E(U,d(o.value,l.value)),n.push(h);else if(m===Ie&&n.length>2)u=n.pop(),l=n.pop(),o=n.pop(),h.value==="?"?n.push(o.value?l.value:u.value):(d=a[h.value],h=new E(U,d(o.value,l.value,u.value)),n.push(h));else if(m===ke&&n.length>0)o=n.pop(),d=t[h.value],h=new E(U,d(o.value)),n.push(h);else if(m===F){for(;n.length>0;)s.push(n.shift());s.push(new E(F,vt(h.value,t,r,a,i)))}else if(m===ve&&n.length>0)o=n.pop(),n.push(new E(U,o.value[h.value]));else{for(;n.length>0;)s.push(n.shift());s.push(h)}}for(;n.length>0;)s.push(n.shift());return s}function Pr(e,t,r){for(var a=[],i=0;i<e.length;i++){var n=e[i],s=n.type;if(s===ee&&n.value===t)for(var o=0;o<r.tokens.length;o++){var l=r.tokens[o],u;l.type===ke?u=tt(l.value):l.type===$e?u=ae(l.value):l.type===Ie?u=Cr(l.value):u=new E(l.type,l.value),a.push(u)}else s===F?a.push(new E(F,Pr(n.value,t,r))):a.push(n)}return a}function le(e,t,r){var a=[],i,n,s,o,l,u;if(Wt(e))return V(e,r);for(var d=e.length,g=0;g<d;g++){var h=e[g],m=h.type;if(m===U||m===pe)a.push(h.value);else if(m===$e)n=a.pop(),i=a.pop(),h.value==="and"?a.push(i?!!le(n,t,r):!1):h.value==="or"?a.push(i?!0:!!le(n,t,r)):h.value==="="?(o=t.binaryOps[h.value],a.push(o(i,le(n,t,r),r))):(o=t.binaryOps[h.value],a.push(o(V(i,r),V(n,r))));else if(m===Ie)s=a.pop(),n=a.pop(),i=a.pop(),h.value==="?"?a.push(le(i?n:s,t,r)):(o=t.ternaryOps[h.value],a.push(o(V(i,r),V(n,r),V(s,r))));else if(m===ee)if(h.value in t.functions)a.push(t.functions[h.value]);else if(h.value in t.unaryOps&&t.parser.isOperatorEnabled(h.value))a.push(t.unaryOps[h.value]);else{var x=r[h.value];if(x!==void 0)a.push(x);else throw new Error("undefined variable: "+h.value)}else if(m===ke)i=a.pop(),o=t.unaryOps[h.value],a.push(o(V(i,r)));else if(m===Se){for(u=h.value,l=[];u-- >0;)l.unshift(V(a.pop(),r));if(o=a.pop(),o.apply&&o.call)a.push(o.apply(void 0,l));else throw new Error(o+" is not a function")}else if(m===je)a.push(function(){for(var M=a.pop(),k=[],I=h.value;I-- >0;)k.unshift(a.pop());var B=a.pop(),D=function(){for(var w=Object.assign({},r),$=0,f=k.length;$<f;$++)w[k[$]]=arguments[$];return le(M,t,w)};return Object.defineProperty(D,"name",{value:B,writable:!1}),r[B]=D,D}());else if(m===F)a.push(ns(h,t));else if(m===qt)a.push(h);else if(m===ve)i=a.pop(),a.push(i[h.value]);else if(m===et)a.pop();else if(m===Oe){for(u=h.value,l=[];u-- >0;)l.unshift(a.pop());a.push(l)}else throw new Error("invalid Expression")}if(a.length>1)throw new Error("invalid Expression (parity)");return a[0]===0?0:V(a[0],r)}function ns(e,t,r){return Wt(e)?e:{type:qt,value:function(a){return le(e.value,t,a)}}}function Wt(e){return e&&e.type===qt}function V(e,t){return Wt(e)?e.value(t):e}function Gt(e,t){for(var r=[],a,i,n,s,o,l,u=0;u<e.length;u++){var d=e[u],g=d.type;if(g===U)typeof d.value=="number"&&d.value<0?r.push("("+d.value+")"):Array.isArray(d.value)?r.push("["+d.value.map(fr).join(", ")+"]"):r.push(fr(d.value));else if(g===$e)i=r.pop(),a=r.pop(),s=d.value,t?s==="^"?r.push("Math.pow("+a+", "+i+")"):s==="and"?r.push("(!!"+a+" && !!"+i+")"):s==="or"?r.push("(!!"+a+" || !!"+i+")"):s==="||"?r.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+a+"),("+i+")))"):s==="=="?r.push("("+a+" === "+i+")"):s==="!="?r.push("("+a+" !== "+i+")"):s==="["?r.push(a+"[("+i+") | 0]"):r.push("("+a+" "+s+" "+i+")"):s==="["?r.push(a+"["+i+"]"):r.push("("+a+" "+s+" "+i+")");else if(g===Ie)if(n=r.pop(),i=r.pop(),a=r.pop(),s=d.value,s==="?")r.push("("+a+" ? "+i+" : "+n+")");else throw new Error("invalid Expression");else if(g===ee||g===pe)r.push(d.value);else if(g===ke)a=r.pop(),s=d.value,s==="-"||s==="+"?r.push("("+s+a+")"):t?s==="not"?r.push("(!"+a+")"):s==="!"?r.push("fac("+a+")"):r.push(s+"("+a+")"):s==="!"?r.push("("+a+"!)"):r.push("("+s+" "+a+")");else if(g===Se){for(l=d.value,o=[];l-- >0;)o.unshift(r.pop());s=r.pop(),r.push(s+"("+o.join(", ")+")")}else if(g===je){for(i=r.pop(),l=d.value,o=[];l-- >0;)o.unshift(r.pop());a=r.pop(),t?r.push("("+a+" = function("+o.join(", ")+") { return "+i+" })"):r.push("("+a+"("+o.join(", ")+") = "+i+")")}else if(g===ve)a=r.pop(),r.push(a+"."+d.value);else if(g===Oe){for(l=d.value,o=[];l-- >0;)o.unshift(r.pop());r.push("["+o.join(", ")+"]")}else if(g===F)r.push("("+Gt(d.value,t)+")");else if(g!==et)throw new Error("invalid Expression")}return r.length>1&&(t?r=[r.join(",")]:r=[r.join(";")]),String(r[0])}function fr(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function xe(e,t){for(var r=0;r<e.length;r++)if(e[r]===t)return!0;return!1}function Xt(e,t,r){r=r||{};for(var a=!!r.withMembers,i=null,n=0;n<e.length;n++){var s=e[n];s.type===ee||s.type===pe?!a&&!xe(t,s.value)?t.push(s.value):(i!==null&&(xe(t,i)||t.push(i)),i=s.value):s.type===ve&&a&&i!==null?i+="."+s.value:s.type===F?Xt(s.value,t,r):i!==null&&(xe(t,i)||t.push(i),i=null)}i!==null&&!xe(t,i)&&t.push(i)}function X(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}X.prototype.simplify=function(e){return e=e||{},new X(vt(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};X.prototype.substitute=function(e,t){return t instanceof X||(t=this.parser.parse(String(t))),new X(Pr(this.tokens,e,t),this.parser)};X.prototype.evaluate=function(e){return e=e||{},le(this.tokens,this,e)};X.prototype.toString=function(){return Gt(this.tokens,!1)};X.prototype.symbols=function(e){e=e||{};var t=[];return Xt(this.tokens,t,e),t};X.prototype.variables=function(e){e=e||{};var t=[];Xt(this.tokens,t,e);var r=this.functions;return t.filter(function(a){return!(a in r)})};X.prototype.toJSFunction=function(e,t){var r=this,a=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Gt(this.simplify(t).tokens,!0)+"; }");return function(){return a.apply(r,arguments)}};var Fe="TEOF",C="TOP",rt="TNUMBER",Sr="TSTRING",te="TPAREN",be="TBRACKET",at="TCOMMA",Ht="TNAME",Vt="TSEMICOLON";function Or(e,t,r){this.type=e,this.value=t,this.index=r}Or.prototype.toString=function(){return this.type+": "+this.value};function b(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}b.prototype.newToken=function(e,t,r){return new Or(e,t,r??this.pos)};b.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};b.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};b.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(Fe,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};b.prototype.isString=function(){var e=!1,t=this.pos,r=this.expression.charAt(t);if(r==="'"||r==='"')for(var a=this.expression.indexOf(r,t+1);a>=0&&this.pos<this.expression.length;){if(this.pos=a+1,this.expression.charAt(a-1)!=="\\"){var i=this.expression.substring(t+1,a);this.current=this.newToken(Sr,this.unescape(i),t),e=!0;break}a=this.expression.indexOf(r,a+1)}return e};b.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(te,e),this.pos++,!0):!1};b.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(be,e),this.pos++,!0):!1};b.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(at,","),this.pos++,!0):!1};b.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(Vt,";"),this.pos++,!0):!1};b.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&r!=="."&&(r<"0"||r>"9")))break}if(t>e){var a=this.expression.substring(e,t);if(a in this.consts)return this.current=this.newToken(rt,this.consts[a]),this.pos+=a.length,!0}return!1};b.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&(r<"0"||r>"9")))break}if(t>e){var a=this.expression.substring(e,t);if(this.isOperatorEnabled(a)&&(a in this.binaryOps||a in this.unaryOps||a in this.ternaryOps))return this.current=this.newToken(C,a),this.pos+=a.length,!0}return!1};b.prototype.isName=function(){for(var e=this.pos,t=e,r=!1;t<this.expression.length;t++){var a=this.expression.charAt(t);if(a.toUpperCase()===a.toLowerCase()){if(t===this.pos&&(a==="$"||a==="_")){a==="_"&&(r=!0);continue}else if(t===this.pos||!r||a!=="_"&&(a<"0"||a>"9"))break}else r=!0}if(r){var i=this.expression.substring(e,t);return this.current=this.newToken(Ht,i),this.pos+=i.length,!0}return!1};b.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var ss=/^[0-9a-f]{4}$/i;b.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var r=e.substring(0,t);t>=0;){var a=e.charAt(++t);switch(a){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+=`
`;break;case"r":r+="\r";break;case"t":r+="	";break;case"u":var i=e.substring(t+1,t+5);ss.test(i)||this.parseError("Illegal escape sequence: \\u"+i),r+=String.fromCharCode(parseInt(i,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+a+'"')}++t;var n=e.indexOf("\\",t);r+=e.substring(t,n<0?e.length:n),t=n}return r};b.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};b.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,r;if(this.expression.charAt(e)==="x")t=16,r=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,r=/^[01]$/i,++e;else return!1;for(var a=!1,i=e;e<this.expression.length;){var n=this.expression.charAt(e);if(r.test(n))e++,a=!0;else break}return a&&(this.current=this.newToken(rt,parseInt(this.expression.substring(i,e),t)),this.pos=e),a};b.prototype.isNumber=function(){for(var e=!1,t=this.pos,r=t,a=t,i=!1,n=!1,s;t<this.expression.length&&(s=this.expression.charAt(t),s>="0"&&s<="9"||!i&&s===".");)s==="."?i=!0:n=!0,t++,e=n;if(e&&(a=t),s==="e"||s==="E"){t++;for(var o=!0,l=!1;t<this.expression.length;){if(s=this.expression.charAt(t),o&&(s==="+"||s==="-"))o=!1;else if(s>="0"&&s<="9")l=!0,o=!1;else break;t++}l||(t=a)}return e?(this.current=this.newToken(rt,parseFloat(this.expression.substring(r,t))),this.pos=t):this.pos=a,e};b.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(C,t);else if(t==="∙"||t==="•")this.current=this.newToken(C,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,">="),this.pos++):this.current=this.newToken(C,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,"<="),this.pos++):this.current=this.newToken(C,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(C,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,"=="),this.pos++):this.current=this.newToken(C,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,"!="),this.pos++):this.current=this.newToken(C,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};b.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};b.prototype.getCoordinates=function(){var e=0,t,r=-1;do e++,t=this.pos-r,r=this.expression.indexOf(`
`,r+1);while(r>=0&&r<this.pos);return{line:e,column:t}};b.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function S(e,t,r){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=r.allowMemberAccess!==!1}S.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};S.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?xe(t,e.value):typeof t=="function"?t(e):e.value===t};S.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};S.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};S.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};S.prototype.expect=function(e,t){if(!this.accept(e,t)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(t||e))}};S.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.accept(Ht)||this.accept(C,r))e.push(new E(ee,this.current.value));else if(this.accept(rt))e.push(new E(U,this.current.value));else if(this.accept(Sr))e.push(new E(U,this.current.value));else if(this.accept(te,"("))this.parseExpression(e),this.expect(te,")");else if(this.accept(be,"["))if(this.accept(be,"]"))e.push(new E(Oe,0));else{var a=this.parseArrayList(e);e.push(new E(Oe,a))}else throw new Error("unexpected "+this.nextToken)};S.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};S.prototype.pushExpression=function(e,t){for(var r=0,a=t.length;r<a;r++)e.push(t[r])};S.prototype.parseUntilEndStatement=function(e,t){return this.accept(Vt)?(this.nextToken&&this.nextToken.type!==Fe&&!(this.nextToken.type===te&&this.nextToken.value===")")&&t.push(new E(et)),this.nextToken.type!==Fe&&this.parseExpression(t),e.push(new E(F,t)),!0):!1};S.prototype.parseArrayList=function(e){for(var t=0;!this.accept(be,"]");)for(this.parseExpression(e),++t;this.accept(at);)this.parseExpression(e),++t;return t};S.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(C,"=");){var t=e.pop(),r=[],a=e.length-1;if(t.type===Se){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var i=0,n=t.value+1;i<n;i++){var s=a-i;e[s].type===ee&&(e[s]=new E(pe,e[s].value))}this.parseVariableAssignmentExpression(r),e.push(new E(F,r)),e.push(new E(je,t.value));continue}if(t.type!==ee&&t.type!==ve)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),e.push(new E(pe,t.value)),e.push(new E(F,r)),e.push(ae("="))}};S.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(C,"?");){var t=[],r=[];this.parseConditionalExpression(t),this.expect(C,":"),this.parseConditionalExpression(r),e.push(new E(F,t)),e.push(new E(F,r)),e.push(Cr("?"))}};S.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(C,"or");){var t=[];this.parseAndExpression(t),e.push(new E(F,t)),e.push(ae("or"))}};S.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(C,"and");){var t=[];this.parseComparison(t),e.push(new E(F,t)),e.push(ae("and"))}};var os=["==","!=","<","<=",">=",">","in"];S.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(C,os);){var t=this.current;this.parseAddSub(e),e.push(ae(t.value))}};var ls=["+","-","||"];S.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(C,ls);){var t=this.current;this.parseTerm(e),e.push(ae(t.value))}};var us=["*","/","%"];S.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(C,us);){var t=this.current;this.parseFactor(e),e.push(ae(t.value))}};S.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.save(),this.accept(C,r)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===te&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===Vt||this.nextToken.type===at||this.nextToken.type===Fe||this.nextToken.type===te&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var a=this.current;this.parseFactor(e),e.push(tt(a.value))}else this.parseExponential(e)};S.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(C,"^");)this.parseFactor(e),e.push(ae("^"))};S.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(C,"!");)e.push(tt("!"))};S.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function r(n){return n.value in t}if(this.accept(C,r)){var a=this.current;this.parseAtom(e),e.push(tt(a.value))}else for(this.parseMemberExpression(e);this.accept(te,"(");)if(this.accept(te,")"))e.push(new E(Se,0));else{var i=this.parseArgumentList(e);e.push(new E(Se,i))}};S.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(te,")");)for(this.parseExpression(e),++t;this.accept(at);)this.parseExpression(e),++t;return t};S.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(C,".")||this.accept(be,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Ht),e.push(new E(ve,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(be,"]"),e.push(ae("["))}else throw new Error("unexpected symbol: "+t.value)}};function hs(e,t){return Number(e)+Number(t)}function cs(e,t){return e-t}function fs(e,t){return e*t}function ds(e,t){return e/t}function ps(e,t){return e%t}function vs(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function gs(e,t){return e===t}function ms(e,t){return e!==t}function ys(e,t){return e>t}function xs(e,t){return e<t}function ws(e,t){return e>=t}function _s(e,t){return e<=t}function Es(e,t){return!!(e&&t)}function Ms(e,t){return!!(e||t)}function Ts(e,t){return xe(t,e)}function As(e){return(Math.exp(e)-Math.exp(-e))/2}function Cs(e){return(Math.exp(e)+Math.exp(-e))/2}function Ps(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function Ss(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function Os(e){return Math.log(e+Math.sqrt(e*e-1))}function bs(e){return Math.log((1+e)/(1-e))/2}function dr(e){return Math.log(e)*Math.LOG10E}function Rs(e){return-e}function ks(e){return!e}function $s(e){return e<0?Math.ceil(e):Math.floor(e)}function Is(e){return Math.random()*(e||1)}function pr(e){return Yt(e+1)}function Ds(e){return isFinite(e)&&e===Math.round(e)}var Fs=4.7421875,ft=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Yt(e){var t,r;if(Ds(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var a=e-2,i=e-1;a>1;)i*=a,a--;return i===0&&(i=1),i}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*Yt(1-e));if(e>=171.35)return 1/0;if(e>85){var n=e*e,s=n*e,o=s*e,l=o*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*n)-139/(51840*s)-571/(2488320*o)+163879/(209018880*l)+5246819/(75246796800*l*e))}--e,r=ft[0];for(var u=1;u<ft.length;++u)r+=ft[u]/(e+u);return t=e+Fs+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*r}function Bs(e){return Array.isArray(e)?e.length:String(e).length}function vr(){for(var e=0,t=0,r=0;r<arguments.length;r++){var a=Math.abs(arguments[r]),i;t<a?(i=t/a,e=e*i*i+1,t=a):a>0?(i=a/t,e+=i*i):e+=a}return t===1/0?1/0:t*Math.sqrt(e)}function gr(e,t,r){return e?t:r}function Ls(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function zs(e,t,r){return r&&(r[e]=t),t}function Us(e,t){return e[t|0]}function Ns(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function qs(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function Ws(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(r,a){return e(r,a)})}function Gs(e,t,r){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce(function(a,i,n){return e(a,i,n)},t)}function Xs(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(r,a){return e(r,a)})}function Hs(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function Vs(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function Ys(e){return(e>0)-(e<0)||+e}var mr=1/3;function Zs(e){return e<0?-Math.pow(-e,mr):Math.pow(e,mr)}function Ks(e){return Math.exp(e)-1}function Qs(e){return Math.log(1+e)}function Js(e){return Math.log(e)/Math.LN2}function re(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||As,cosh:Math.cosh||Cs,tanh:Math.tanh||Ps,asinh:Math.asinh||Ss,acosh:Math.acosh||Os,atanh:Math.atanh||bs,sqrt:Math.sqrt,cbrt:Math.cbrt||Zs,log:Math.log,log2:Math.log2||Js,ln:Math.log,lg:Math.log10||dr,log10:Math.log10||dr,expm1:Math.expm1||Ks,log1p:Math.log1p||Qs,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||$s,"-":Rs,"+":Number,exp:Math.exp,not:ks,length:Bs,"!":pr,sign:Math.sign||Ys},this.binaryOps={"+":hs,"-":cs,"*":fs,"/":ds,"%":ps,"^":Math.pow,"||":vs,"==":gs,"!=":ms,">":ys,"<":xs,">=":ws,"<=":_s,and:Es,or:Ms,in:Ts,"=":zs,"[":Us},this.ternaryOps={"?":gr},this.functions={random:Is,fac:pr,min:qs,max:Ns,hypot:Math.hypot||vr,pyt:Math.hypot||vr,pow:Math.pow,atan2:Math.atan2,if:gr,gamma:Yt,roundTo:Ls,map:Ws,fold:Gs,filter:Xs,indexOf:Hs,join:Vs},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}re.prototype.parse=function(e){var t=[],r=new S(this,new b(this,e),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(t),r.expect(Fe,"EOF"),new X(t,this)};re.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var br=new re;re.parse=function(e){return br.parse(e)};re.evaluate=function(e,t){return br.parse(e).evaluate(t)};var yr={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function js(e){return yr.hasOwnProperty(e)?yr[e]:e}re.prototype.isOperatorEnabled=function(e){var t=js(e),r=this.options.operators||{};return!(t in r)||!!r[t]};var de={},Rr={},j={};Object.defineProperty(j,"__esModule",{value:!0});j.loop=j.conditional=j.parse=void 0;var eo=function e(t,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:a;if(Array.isArray(r))r.forEach(function(s){return e(t,s,a,i)});else if(typeof r=="function")r(t,a,i,e);else{var n=Object.keys(r)[0];Array.isArray(r[n])?(i[n]={},e(t,r[n],a,i[n])):i[n]=r[n](t,a,i,e)}return a};j.parse=eo;var to=function(t,r){return function(a,i,n,s){r(a,i,n)&&s(a,t,i,n)}};j.conditional=to;var ro=function(t,r){return function(a,i,n,s){for(var o=[],l=a.pos;r(a,i,n);){var u={};if(s(a,t,i,u),a.pos===l)break;l=a.pos,o.push(u)}return o}};j.loop=ro;var R={};Object.defineProperty(R,"__esModule",{value:!0});R.readBits=R.readArray=R.readUnsigned=R.readString=R.peekBytes=R.readBytes=R.peekByte=R.readByte=R.buildStream=void 0;var ao=function(t){return{data:t,pos:0}};R.buildStream=ao;var kr=function(){return function(t){return t.data[t.pos++]}};R.readByte=kr;var io=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(r){return r.data[r.pos+t]}};R.peekByte=io;var it=function(t){return function(r){return r.data.subarray(r.pos,r.pos+=t)}};R.readBytes=it;var no=function(t){return function(r){return r.data.subarray(r.pos,r.pos+t)}};R.peekBytes=no;var so=function(t){return function(r){return Array.from(it(t)(r)).map(function(a){return String.fromCharCode(a)}).join("")}};R.readString=so;var oo=function(t){return function(r){var a=it(2)(r);return t?(a[1]<<8)+a[0]:(a[0]<<8)+a[1]}};R.readUnsigned=oo;var lo=function(t,r){return function(a,i,n){for(var s=typeof r=="function"?r(a,i,n):r,o=it(t),l=new Array(s),u=0;u<s;u++)l[u]=o(a);return l}};R.readArray=lo;var uo=function(t,r,a){for(var i=0,n=0;n<a;n++)i+=t[r+n]&&Math.pow(2,a-n-1);return i},ho=function(t){return function(r){for(var a=kr()(r),i=new Array(8),n=0;n<8;n++)i[7-n]=!!(a&1<<n);return Object.keys(t).reduce(function(s,o){var l=t[o];return l.length?s[o]=uo(i,l.index,l.length):s[o]=i[l.index],s},{})}};R.readBits=ho;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=j,r=R,a={blocks:function(h){for(var m=0,x=[],M=h.data.length,k=0,I=(0,r.readByte)()(h);I!==m&&I;I=(0,r.readByte)()(h)){if(h.pos+I>=M){var B=M-h.pos;x.push((0,r.readBytes)(B)(h)),k+=B;break}x.push((0,r.readBytes)(I)(h)),k+=I}for(var D=new Uint8Array(k),w=0,$=0;$<x.length;$++)D.set(x[$],w),w+=x[$].length;return D}},i=(0,t.conditional)({gce:[{codes:(0,r.readBytes)(2)},{byteSize:(0,r.readByte)()},{extras:(0,r.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,r.readUnsigned)(!0)},{transparentColorIndex:(0,r.readByte)()},{terminator:(0,r.readByte)()}]},function(g){var h=(0,r.peekBytes)(2)(g);return h[0]===33&&h[1]===249}),n=(0,t.conditional)({image:[{code:(0,r.readByte)()},{descriptor:[{left:(0,r.readUnsigned)(!0)},{top:(0,r.readUnsigned)(!0)},{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{lct:(0,r.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,t.conditional)({lct:(0,r.readArray)(3,function(g,h,m){return Math.pow(2,m.descriptor.lct.size+1)})},function(g,h,m){return m.descriptor.lct.exists}),{data:[{minCodeSize:(0,r.readByte)()},a]}]},function(g){return(0,r.peekByte)()(g)===44}),s=(0,t.conditional)({text:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{preData:function(h,m,x){return(0,r.readBytes)(x.text.blockSize)(h)}},a]},function(g){var h=(0,r.peekBytes)(2)(g);return h[0]===33&&h[1]===1}),o=(0,t.conditional)({application:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{id:function(h,m,x){return(0,r.readString)(x.blockSize)(h)}},a]},function(g){var h=(0,r.peekBytes)(2)(g);return h[0]===33&&h[1]===255}),l=(0,t.conditional)({comment:[{codes:(0,r.readBytes)(2)},a]},function(g){var h=(0,r.peekBytes)(2)(g);return h[0]===33&&h[1]===254}),u=[{header:[{signature:(0,r.readString)(3)},{version:(0,r.readString)(3)}]},{lsd:[{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{gct:(0,r.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,r.readByte)()},{pixelAspectRatio:(0,r.readByte)()}]},(0,t.conditional)({gct:(0,r.readArray)(3,function(g,h){return Math.pow(2,h.lsd.gct.size+1)})},function(g,h){return h.lsd.gct.exists}),{frames:(0,t.loop)([i,o,l,n,s],function(g){var h=(0,r.peekByte)()(g);return h===33||h===44})}],d=u;e.default=d})(Rr);var nt={};Object.defineProperty(nt,"__esModule",{value:!0});nt.deinterlace=void 0;var co=function(t,r){for(var a=new Array(t.length),i=t.length/r,n=function(h,m){var x=t.slice(m*r,(m+1)*r);a.splice.apply(a,[h*r,r].concat(x))},s=[0,4,2,1],o=[8,8,4,2],l=0,u=0;u<4;u++)for(var d=s[u];d<i;d+=o[u])n(d,l),l++;return a};nt.deinterlace=co;var st={};Object.defineProperty(st,"__esModule",{value:!0});st.lzw=void 0;var fo=function(t,r,a){var i=4096,n=-1,s=a,o,l,u,d,g,h,m,f,x,M,$,k,y,p,se,L,I=new Array(a),B=new Array(i),D=new Array(i),w=new Array(i+1);for(k=t,l=1<<k,g=l+1,o=l+2,m=n,d=k+1,u=(1<<d)-1,x=0;x<l;x++)B[x]=0,D[x]=x;var $,f,y,p,L,se;for($=f=y=p=L=se=0,M=0;M<s;){if(p===0){if(f<d){$+=r[se]<<f,f+=8,se++;continue}if(x=$&u,$>>=d,f-=d,x>o||x==g)break;if(x==l){d=k+1,u=(1<<d)-1,o=l+2,m=n;continue}if(m==n){w[p++]=D[x],m=x,y=x;continue}for(h=x,x==o&&(w[p++]=y,x=m);x>l;)w[p++]=D[x],x=B[x];y=D[x]&255,w[p++]=y,o<i&&(B[o]=m,D[o]=y,o++,!(o&u)&&o<i&&(d++,u+=o)),m=h}p--,I[L++]=w[p],M++}for(M=L;M<s;M++)I[M]=0;return I};st.lzw=fo;Object.defineProperty(de,"__esModule",{value:!0});var $r=de.decompressFrames=de.decompressFrame=Ir=de.parseGIF=void 0,po=xo(Rr),vo=j,go=R,mo=nt,yo=st;function xo(e){return e&&e.__esModule?e:{default:e}}var wo=function(t){var r=new Uint8Array(t);return(0,vo.parse)((0,go.buildStream)(r),po.default)},Ir=de.parseGIF=wo,_o=function(t){for(var r=t.pixels.length,a=new Uint8ClampedArray(r*4),i=0;i<r;i++){var n=i*4,s=t.pixels[i],o=t.colorTable[s]||[0,0,0];a[n]=o[0],a[n+1]=o[1],a[n+2]=o[2],a[n+3]=s!==t.transparentIndex?255:0}return a},Dr=function(t,r,a){if(!t.image){console.warn("gif frame does not have associated image.");return}var i=t.image,n=i.descriptor.width*i.descriptor.height,s=(0,yo.lzw)(i.data.minCodeSize,i.data.blocks,n);i.descriptor.lct.interlaced&&(s=(0,mo.deinterlace)(s,i.descriptor.width));var o={pixels:s,dims:{top:t.image.descriptor.top,left:t.image.descriptor.left,width:t.image.descriptor.width,height:t.image.descriptor.height}};return i.descriptor.lct&&i.descriptor.lct.exists?o.colorTable=i.lct:o.colorTable=r,t.gce&&(o.delay=(t.gce.delay||10)*10,o.disposalType=t.gce.extras.disposal,t.gce.extras.transparentColorGiven&&(o.transparentIndex=t.gce.transparentColorIndex)),a&&(o.patch=_o(o)),o};de.decompressFrame=Dr;var Eo=function(t,r){return t.frames.filter(function(a){return a.image}).map(function(a){return Dr(a,t.gct,r)})};$r=de.decompressFrames=Eo;function Mo(e){const t=Ir(e),r=$r(t,!0),a=[];for(let i of r){const{width:n,height:s,left:o,top:l}=i.dims,u=document.createElement("canvas"),d=u.getContext("2d");u.width=n,u.height=s,d.putImageData(new ImageData(i.patch,n,s),o,l),a.push(u)}return a}async function To(e){const t=new ImageDecoder({data:e,type:"image/gif"});await t.tracks.ready,await t.completed;const r=t.tracks.selectedTrack.frameCount,a=[];for(let i=0;i<r;i++){const n=(await t.decode({frameIndex:i})).image;n.width=n.codedWidth,n.height=n.codedHeight,a.push(mt(n)),n.close()}return a}async function Ao(e){const t=await e.arrayBuffer();return window.ImageDecoder?To(t):Mo(t)}const Co={frameCount:0,startTime:0};class Po{constructor(t,r=1){v(this,"blob");v(this,"video");v(this,"length");v(this,"frames");v(this,"initPromise");this.blob=t,this.length=r,this.initPromise=this.init()}setFrameCount(t){return this.length=t,this.initPromise=this.init(),this}async init(){this.frames=[];const t=document.createElement("video");t.src=URL.createObjectURL(this.blob)+"#t=0.0001",await new Promise(i=>t.addEventListener("loadeddata",i));const{startTime:r}=Co,a=(this.video.duration-r)/this.length;for(let i=0;i<this.length;i++)this.video.currentTime=i*a+r,await new Promise(n=>this.video.oncanplay=n),this.frames[i]=mt(this.video)}async getFrames(){return await this.initPromise,this.frames}}async function So(e,t){if(t=t,t<0)throw new Error(`video frame count ${t} must >1`);return new Po(e,t).getFrames()}const Oo={type:void 0,pos:void 0,posType:"ZOOM",crop:null,cropType:"NONE",style:[],round:!1,rotate:!1,avatarOnTop:!0,antialias:!0,resampling:!1,angle:0,opacity:1};function bo(e){if(e.compiled)return e;const t={...Oo,...e},r=t.pos;let a;switch(t.posType){case"ZOOM":a=typeof r[0]!="object"?[me(r,4)]:r.map(i=>me(i,4)),t.pos=a.map(i=>i.map(n=>typeof n=="number"?n:re.parse(n)));break;case"DEFORM":try{a=r.map(i=>me(i,5).map(n=>me(n,2)))}catch{a=[me(r,5).map(n=>me(n,2))]}t.pos=a.map(i=>i.map(n=>n.map(s=>typeof s=="number"?s:re.parse(s))));break}return t.compiled=!0,t}class Ro extends Vr{constructor(r,a){super();v(this,"type");v(this,"template");v(this,"originBlob");v(this,"frames");v(this,"pos");v(this,"initPromise");v(this,"deformer");if(this.template=bo(r),this.type=r.type,this.originBlob=a[this.type.toString().toLowerCase()],!this.originBlob)throw new Error(`no ${this.type} image`);this.initPromise=this.init()}async init(){await this.loadFile(),await this.setCrop(),await this.setStyle(),await this.setRound(),await this.setPos()}async loadFile(){const r=this.originBlob;if(r.type.startsWith("video/"))this.frames=await So(r,this.template.pos.length);else if(!r.type.startsWith("image"))throw new Error("不支持的格式: "+r.type);r.type==="image/gif"?this.frames=await Ao(r):this.frames=[await Er(r)]}setCrop(){const r=this.template.cropType;r!=="NONE"&&(this.frames=this.frames.map(a=>Zr(a,this.template.crop,r==="PERCENT")))}setStyle(){for(const r of this.template.style)switch(r){case"FLIP":this.frames=this.frames.map(Kr);break;case"MIRROR":this.frames=this.frames.map(ts);break;case"GRAY":this.frames=this.frames.map(Qr);break;case"BINARIZATION":this.frames=this.frames.map(rs);break;default:throw new Error("unknown style "+r)}}setRound(){this.template.round&&(this.frames=this.frames.map(as))}async setPos(){switch(this.template.posType){case"ZOOM":this.pos=this.template.pos.map(r=>r.map(this.evalExpression));break;case"DEFORM":this.deformer=new es,this.pos=this.template.pos.map(r=>r.map(a=>a.map(this.evalExpression)));break}}evalExpression(r){return typeof r=="number"?r:r.evaluate({height:this.frames[0].height,width:this.frames[0].width})}getFrame(r){return r<this.frames.length?this.frames[r]:this.frames.at(-1)}getPos(r){return r<this.pos.length?this.pos[r]:this.pos.at(-1)}async getLength(){return await this.initPromise,{posLength:this.pos.length,frameLength:this.frames.length}}async draw(r,a=0){await this.initPromise;let i=this.getFrame(a);const n=this.getPos(a);let{angle:s,opacity:o,rotate:l}=this.template;switch(r.globalAlpha=o,l&&(s+=360/n.length*a),this.template.posType){case"ZOOM":s&&(i=is(i,s)),r.drawImage(i,...n);break;case"DEFORM":this.deformer.draw(r,i,n);break}r.globalAlpha=1}get onTop(){return this.template.avatarOnTop}async getSize(){await this.initPromise;const r=this.frames[0];return{width:r.width,height:r.height}}}class Zt{constructor(t){v(this,"arr");v(this,"initPromise");v(this,"topAvatars",[]);v(this,"bottomAvatars",[]);v(this,"sizeMap",Object.create(null));v(this,"maxLength");this.arr=t,this.initPromise=this.init()}async init(){return Promise.all(this.arr.map(async(t,r)=>{t.onTop?this.topAvatars.push(t):this.bottomAvatars.push(t);const a=await t.getSize();this.sizeMap[`avatar${r}Width`]=a.width,this.sizeMap[`avatar${r}Height`]=a.height,this.maxLength=await t.getLength()}))}async getSizeMap(){return await this.initPromise,this.sizeMap}async getMaxLength(){return await this.initPromise,this.maxLength}static createFrom(t,r){return new Zt(t.map(a=>new Ro(a,r)))}}const dt=e=>{e.stopPropagation(),e.preventDefault()};var z,Te,Ae,Ue,Ye;class ko{constructor(t){v(this,"type");_(this,z,void 0);_(this,Te,void 0);_(this,Ae,void 0);_(this,Ue,void 0);_(this,Ye,new Promise(t=>T(this,Ue,t)));this.type=t,T(this,z,document.createElement("label")),c(this,z).setAttribute("type",t),c(this,z).addEventListener("dragenter",dt,!1),c(this,z).addEventListener("dragover",dt,!1),c(this,z).addEventListener("drop",a=>{dt(a),this.setFiles(a.dataTransfer.files)},!1);const r=document.createElement("input");r.type="file",r.accept="image/*",r.addEventListener("change",()=>this.setFiles(r.files)),c(this,z).appendChild(r)}render(){return c(this,z)}set onchange(t){T(this,Ae,t)}get file(){return c(this,Te)}async waitFile(){return await c(this,Ye),c(this,Te)}setFiles(t){let r=t.item(0);if(r){if(!r.type.startsWith("image"))throw new Error("仅支持图片格式");c(this,z).style.backgroundImage=`url(${URL.createObjectURL(r)})`,c(this,z).style.backgroundSize="cover",T(this,Te,r),c(this,Ue).call(this),c(this,Ae)&&c(this,Ae).call(this,this)}}}z=new WeakMap,Te=new WeakMap,Ae=new WeakMap,Ue=new WeakMap,Ye=new WeakMap;const xr=["FROM","TO","BOT","GROUP"];var Q,Ne,ue,gt;class Fr{constructor(){_(this,Q,void 0);_(this,Ne,new Map(xr.map(t=>[t,new ko(t)])));_(this,ue,void 0);_(this,gt,void 0);T(this,Q,document.createElement("div")),c(this,Q).className="avatar-uploader"}set types(t){if(!t||t.length===0){c(this,Q).innerHTML="No Avatar";return}c(this,Q).innerHTML="",T(this,ue,t.map(r=>c(this,Ne).get(r))),c(this,Q).append(...c(this,ue).map(r=>r.render()))}render(){const t=document.createElement("div");return t.append(De("Upload Avatar"),c(this,Q)),t}get ready(){return c(this,ue).some(t=>t.file)}set onchange(t){for(const r of c(this,Ne).values())r.onchange=()=>this.ready&&t(this)}get data(){const t={};for(const r of c(this,ue))t[r.type.toLowerCase()]=r.file;return t}}Q=new WeakMap,Ne=new WeakMap,ue=new WeakMap,gt=new WeakMap,v(Fr,"types",xr);var he,H,ie,Ce,ce,Ze,Br,Ke,Lr;class $o{constructor(){_(this,Ze);_(this,Ke);_(this,he,void 0);_(this,H,void 0);_(this,ie,void 0);_(this,Ce,void 0);_(this,ce,void 0);T(this,he,document.createElement("div")),T(this,H,document.createElement("div")),c(this,H).id="result-area",c(this,he).append(De("Result"),c(this,H)),T(this,ie,document.createElement("canvas")),ge(this,Ze,Br).call(this),c(this,H).appendChild(c(this,ie)),T(this,ce,new wr(c(this,H))),c(this,ce).show()}set canvas(t){c(this,ce).show(),c(this,H).innerHTML="",T(this,ie,t),c(this,H).appendChild(t),ge(this,Ke,Lr).call(this),c(this,ce).hide()}set setting(t){c(this,Ce)&&c(this,Ce).remove(),T(this,Ce,t),c(this,he).appendChild(t)}render(){return c(this,he)}}he=new WeakMap,H=new WeakMap,ie=new WeakMap,Ce=new WeakMap,ce=new WeakMap,Ze=new WeakSet,Br=function(){c(this,ie).classList.add("hide")},Ke=new WeakSet,Lr=function(){c(this,ie).classList.remove("hide")};class Kt{constructor(t){v(this,"obj");v(this,"container");this.obj=t,this.container=document.createElement("div"),this.container.classList.add("setting-container")}createInput(t,r){const a=document.createElement("div"),i=document.createElement("span");i.textContent=t,a.appendChild(i);let n=typeof r;switch(n){case"object":const s=new Kt(r).render();a.appendChild(s);break;case"function":const o=document.createElement("button");o.textContent=t,o.addEventListener("click",async()=>{o.disabled=!0,await r(),o.disabled=!1}),a.appendChild(o);break;default:const l=document.createElement("input");let u=()=>this.obj[t]=l.value;switch(typeof r){case"number":u=()=>this.obj[t]=parseFloat(l.value);break;case"string":n=/^#([A-Fa-f0-9]{6})$/.test(r)?"color":"text";break;case"boolean":n="checkbox",u=()=>this.obj[t]=l.value==="true";break}l.type=n,l.value=r.toString(),l.addEventListener("change",u),a.appendChild(l);break}return a}render(){for(const[t,r]of Object.entries(this.obj)){const a=this.createInput(t,r);this.container.appendChild(a)}return this.container}}const Io=6;class Qt{constructor(t){v(this,"hasTemplate",!1);v(this,"width");v(this,"height");v(this,"color");v(this,"frames");v(this,"loadingPromise");t&&([this.width,this.height]=t.size.map(r=>typeof r=="number"?r:re.parse(r)),this.color=Yr(this.color),this.hasTemplate=!0)}set url(t){this.loadingPromise=Qt.fetchImages(t).then(r=>this.frames=r)}set images(t){this.frames=t}async generate(t){if(await this.loadingPromise,this.frames)return this.hasTemplate?this.frames.map(r=>{const a=this.getCtx(t);return a.drawImage(r,0,0),a.canvas}):this.frames;if(this.hasTemplate)return[this.getCtx(t).canvas];throw new Error("can not load background")}getCtx(t){const r=document.createElement("canvas"),a=n=>typeof n=="number"?n:n.evaluate(t);r.width=a(this.width),r.height=a(this.height);const i=r.getContext("2d");return i.fillStyle=this.color,i.fillRect(0,0,r.width,r.height),i}static async fetchImages(t){let r=!1;const a=new Set,i=[];let n=0;for(;!r;){a.size>=Io&&await Promise.race(a);const s=n++,l=fetch(`${t}/${s}.png`).then(u=>u.blob()).then(Er).then(u=>{i[s]=u}).catch(()=>r=!0).then(()=>a.delete(l));a.add(l)}return await Promise.all(a),i}}const Do={type:void 0,avatar:[],text:[],background:null,delay:65,alias:[],inRandomList:!0,reverse:!1,hidden:!1};class Fo{constructor(t,r){v(this,"type");v(this,"template");v(this,"initPromise");v(this,"avatarList");v(this,"backgroundModel");this.template={...Do,...t},this.type=t.type,this.backgroundModel=new Qt(this.template.background),r&&(this.background=r),this.initPromise=this.init()}set background(t){if(typeof t=="string")this.backgroundModel.url=t;else if(Array.isArray(t))this.backgroundModel.images=t;else throw new Error("unknown background",t)}async init(){}async generate(t){const r=Zt.createFrom(this.template.avatar,t),a=await r.getSizeMap(),i=await this.backgroundModel.generate(a);return new Bo(this.template,i,r)}}class Bo{constructor(t,r,a){v(this,"template");v(this,"canvas");v(this,"ctx");v(this,"backgrounds");v(this,"avatars");v(this,"length");v(this,"intervalId");v(this,"initPromise");v(this,"userDelay");v(this,"i",0);v(this,"framesCache",[]);v(this,"resolveFramesCachedPromise");v(this,"framesCachedPromise",new Promise(t=>this.resolveFramesCachedPromise=t));const i=document.createElement("canvas");this.canvas=i,i.width=r[0].width,i.height=r[0].height,this.ctx=i.getContext("2d"),this.template=t,this.backgrounds=r,this.avatars=a,this.initPromise=this.init()}async init(){const{posLength:t,frameLength:r}=await this.avatars.getMaxLength();this.length=this.template.type==="IMG"?r:this.backgrounds.length}async play(){if(await this.stop(),this.template.reverse)return this.playReverse();this.intervalId=setInterval(()=>{this.drawCache(this.i++%this.length)},this.userDelay??this.template.delay)}playReverse(){this.intervalId=setInterval(()=>{this.drawCache(this.length-this.i++%this.length)},this.delay)}async stop(){await this.initPromise,clearInterval(this.intervalId)}set delay(t){if(!t){this.stop();return}this.userDelay=Math.abs(t),t>0?this.stop().then(()=>this.play()):this.stop().then(()=>this.playReverse())}get delay(){return this.userDelay||this.template.delay}getBackground(t){return t<this.backgrounds.length?this.backgrounds[t]:this.backgrounds.at(-1)}async getFrames(){return await this.framesCachedPromise,this.framesCache}async drawCache(t){if(this.framesCache[t]){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.framesCache[t],0,0);return}await this.draw(t),this.framesCache[t]=mt(this.canvas,!0),this.framesCache.length===this.length&&this.resolveFramesCachedPromise()}async draw(t){await this.initPromise,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const r of this.avatars.bottomAvatars)await r.draw(this.ctx,t);this.ctx.drawImage(this.getBackground(t),0,0);for(const r of this.avatars.topAvatars)await r.draw(this.ctx,t)}get settingObject(){const t=this;return{set delay(r){t.delay=r},get delay(){return t.delay},play:()=>t.play(),stop:()=>t.stop()}}}const Lo="index.json",zo="/data/xmmt.dituon.petpet";class Uo{constructor(t){v(this,"urls");v(this,"urlSet",new Set);v(this,"initPromise");v(this,"idMap");v(this,"fonts");this.urls=t,this.initPromise=this.init()}async init(){const t=new Map,r=new Map;await Promise.all(this.urls.map(async a=>{const i=await fetch(`${a}/${Lo}`).then(l=>l.json()),{dataPath:n=zo,dataList:s,fontList:o}=i;for(const l of s)t.has(l)||t.set(l,`${a}${n}/${l}`);for(const l of o)r.has(l)||r.set(l,`${a}${n}/fonts/${l}`);this.urlSet.add(a)})),this.idMap=t,this.fonts=[...r.values()]}async getIdMap(){return await this.initPromise,this.idMap}async getFonts(){return await this.initPromise,this.fonts}async getUrlSet(){return await this.initPromise,this.urlSet}}var fe,Pe,J,G,ne,Qe,zr,Je,Ur,qe;class No{constructor(t){_(this,Qe);_(this,Je);_(this,fe,void 0);_(this,Pe,void 0);_(this,J,void 0);_(this,G,void 0);_(this,ne,void 0);_(this,qe,async t=>{t&&(t=await t,T(this,Pe,t),c(this,G)||(T(this,G,new Fr),c(this,G).onchange=()=>this.generate(),c(this,fe).appendChild(c(this,G).render())),c(this,G).types=[...new Set(t.avatar.map(r=>r.type))],await this.generate())});ge(this,Qe,zr).call(this,t)}async generate(){if(!c(this,G)||!c(this,G).ready)return;c(this,ne)||(T(this,ne,new $o),c(this,fe).appendChild(c(this,ne).render()));const r=await new Fo(c(this,Pe),c(this,Pe).url).generate(c(this,G).data);await r.play(),c(this,ne).canvas=r.canvas;const a=new Kt(r.settingObject);c(this,ne).setting=a.render()}}fe=new WeakMap,Pe=new WeakMap,J=new WeakMap,G=new WeakMap,ne=new WeakMap,Qe=new WeakSet,zr=async function(t){T(this,fe,document.getElementById(t)),T(this,J,new Hr),c(this,fe).appendChild(c(this,J).render()),await ge(this,Je,Ur).call(this);const r=await c(this,J).showModal();c(this,J).onchange=async a=>c(this,qe).call(this,a),await c(this,qe).call(this,r)},Je=new WeakSet,Ur=async function(){const t=new Uo(Wr.server),r=await t.getIdMap(),a=[];for(const[i,n]of r.entries())a.push({key:i,url:n});return c(this,J).templates=a,(await t.getUrlSet()).size||c(this,J).loading.error(),!0},qe=new WeakMap;new No("app");
