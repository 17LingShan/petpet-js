var Jt=Object.defineProperty;var jt=(e,t,r)=>t in e?Jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var p=(e,t,r)=>(jt(e,typeof t!="symbol"?t+"":t,r),r);function er(e,t="h3"){const r=document.createElement(t);return r.textContent=e,r}const tr={selectTemplate:"Select template",uploadAvatar:"Upload avatar",setText:"Set text",result:"Result",typeToSearch:"Type to search",cancel:"Cancel",save:"Save",add:"Add",x:"X",y:"Y",text:"Text",color:"Color",size:"Size",font:"Font",fontStyle:"Font Style",strokeSize:"Stroke Size",strokeColor:"Stroke Color",hidden:"Hidden",delete:"Delete",delay:"Delay",play:"Play",stop:"Stop",workers:"Workers",quality:"Quality",background:"Background",dither:"Dither",download:"Download",copy:"Copy",share:"Share",notSelected:"Not Selected",noAvatar:"No Avatar",rightClickOrLongPress:"Right Click or Long Press",type:"Type",deform:"Deform",round:"Round",rotate:"Rotate",avatarOnTop:"Avatar on Top",opacity:"Opacity",fit:"Fit",style:"Style",FLIP:"Flip",MIRROR:"Mirror",GRAY:"Gray",BINARIZATION:"Binarization"},rr={selectTemplate:"選擇模板",uploadAvatar:"上傳頭像",setText:"設置文字",result:"結果",typeToSearch:"檢索文字",cancel:"取消",save:"保存",add:"添加",x:"X",y:"Y",text:"文字",color:"顏色",size:"大小",font:"字型",fontStyle:"字型風格",strokeSize:"描邊大小",strokeColor:"描邊顏色",hidden:"隱藏",delete:"刪除",delay:"延遲",play:"播放",stop:"停止",workers:"線程數",quality:"質量",background:"背景",dither:"抖動",download:"下載",copy:"複製",share:"分享",notSelected:"未選擇",noAvatar:"無頭像",rightClickOrLongPress:"右鍵或長按",type:"類型",deform:"變形",round:"圓形",rotate:"旋轉",avatarOnTop:"頭像置顶",opacity:"透明度",fit:"適應",style:"風格",FLIP:"翻轉",MIRROR:"鏡像",GRAY:"灰階",BINARIZATION:"二值化"},ar={selectTemplate:"选择模板",uploadAvatar:"上传头像",setText:"设置文字",result:"结果",typeToSearch:"搜索文字",cancel:"取消",save:"保存",add:"添加",x:"X",y:"Y",text:"文字",color:"颜色",size:"大小",font:"字体",fontStyle:"字体风格",strokeSize:"描边大小",strokeColor:"描边颜色",hidden:"隐藏",delete:"删除",delay:"延迟",play:"播放",stop:"停止",workers:"线程数",quality:"质量",background:"背景",dither:"抖动",download:"下载",copy:"复制",share:"分享",notSelected:"未选择",noAvatar:"无头像",rightClickOrLongPress:"右键或长按",type:"类型",deform:"变形",round:"圆形",rotate:"旋转",avatarOnTop:"头像置顶",opacity:"透明度",fit:"适应",style:"风格",FLIP:"翻转",MIRROR:"镜像",GRAY:"灰阶",BINARIZATION:"二值化"},nr={selectTemplate:"Template auswählen",uploadAvatar:"Avatar hochladen",setText:"Text setzen",result:"Ergebnis",typeToSearch:"Suche",cancel:"Abbrechen",save:"Speichern",add:"Hinzufügen",x:"X",y:"Y",text:"Text",color:"Farbe",size:"Größe",font:"Schriftart",fontStyle:"Schriftstil",strokeSize:"Konturgröße",strokeColor:"Konturfarbe",hidden:"Verstecken",delete:"Löschen",delay:"Verzögerung",play:"Abspielen",stop:"Stoppen",workers:"Anzahl der Threads",quality:"Qualität",background:"Hintergrund",dither:"Dither",download:"Download",copy:"Kopieren",share:"Teilen",notSelected:"Nicht ausgewählt",noAvatar:"Keine Avatar",rightClickOrLongPress:"Rechtsklick oder Doppelklick",type:"Typ",deform:"Verformung",round:"Rund",rotate:"Drehen",avatarOnTop:"Avatar oben",opacity:"Deckkraft",fit:"Anpassen",style:"Stil",FLIP:"Umdrehen",MIRROR:"Spiegeln",GRAY:"Grau",BINARIZATION:"Binarisierung"},ir={selectTemplate:"テンプレートを選択",uploadAvatar:"アバターをアップロード",setText:"テキストを設定",result:"結果",typeToSearch:"検索",cancel:"キャンセル",save:"保存",add:"追加",x:"X",y:"Y",text:"テキスト",color:"色",size:"サイズ",font:"フォント",fontStyle:"フォントスタイル",strokeSize:"線の太さ",strokeColor:"線の色",hidden:"隠す",delete:"削除",delay:"遅延",play:"再生",stop:"停止",workers:"線程数",quality:"質量",background:"背景色",dither:"抖動",download:"ダウンロード",copy:"コピー",share:"シェア",notSelected:"未選択",noAvatar:"アバターなし",rightClickOrLongPress:"右クリックまたは長押し",type:"タイプ",deform:"変形",round:"ラウンド",rotate:"回転",avatarOnTop:"上にアバター",opacity:"不透明度",fit:"フィット",style:"スタイル",FLIP:"反転",MIRROR:"ミラー",GRAY:"グレー",BINARIZATION:"二値化"},sr={selectTemplate:"템플릿 선택",uploadAvatar:"아바타 업로드",setText:"텍스트 설정",result:"결과",typeToSearch:"검색",cancel:"취소",save:"저장",add:"추가",x:"X",y:"Y",text:"텍스트",color:"색",size:"크기",font:"글꼴",fontStyle:"글꼴 스타일",strokeSize:"선 굵기",strokeColor:"선 색상",hidden:"숨김",delete:"삭제",delay:"연속",play:"재생",stop:"중지",workers:"쓰레드 수",quality:"질량",background:"배경색",dither:"쓰레드",download:"다운로드",copy:"복사",share:"공유",notSelected:"선택되지 않음",noAvatar:"아바타 없음",rightClickOrLongPress:"마우스 오른쪽클릭",type:"유형",deform:"변형",round:"둥근",rotate:"회전",avatarOnTop:"상단 아바타",opacity:"불투명도",fit:"맞춤",style:"스타일",FLIP:"뒤집기",MIRROR:"거울상",GRAY:"그레이",BINARIZATION:"이진화"},or={selectTemplate:"Выберите шаблон",uploadAvatar:"Загрузить аватар",setText:"Установить текст",result:"Результат",typeToSearch:"Поиск",cancel:"Отмена",save:"Сохранить",add:"Добавить",x:"X",y:"Y",text:"Текст",color:"Цвет",size:"Размер",font:"Шрифт",fontStyle:"Стиль шрифта",strokeSize:"Толщина обводки",strokeColor:"Цвет обводки",hidden:"Скрыть",delete:"Удалить",delay:"Задержка",play:"Воспроизведение",stop:"Остановить",workers:"Количество нитей",quality:"Качество",background:"Фон",dither:"Контроль",download:"Скачать",copy:"Копировать",share:"Поделиться",notSelected:"Не выбрано",noAvatar:"Нет аватара",rightClickOrLongPress:"Кликните или перетащите мышкой",type:"Тип",deform:"Деформация",round:"Круглый",rotate:"Поворот",avatarOnTop:"Аватар сверху",opacity:"Непрозрачность",fit:"Подгонка",style:"Стиль",FLIP:"Перевернуть",MIRROR:"Зеркало",GRAY:"Серый",BINARIZATION:"Бинаризация"},lr={selectTemplate:"Sélectionnez un modèle",uploadAvatar:"Télécharger avatar",setText:"Définir le texte",result:"Résultat",typeToSearch:"Rechercher",cancel:"Annuler",save:"Enregistrer",add:"Ajouter",x:"X",y:"Y",text:"Texte",color:"Couleur",size:"Taille",font:"Police",fontStyle:"Style de police",strokeSize:"Taille du contour",strokeColor:"Couleur du contour",hidden:"Cacher",delete:"Supprimer",delay:"Délai",play:"Lecture",stop:"Arrêter",workers:"Nombre de nœuds",quality:"Qualité",background:"Fond",dither:"Dither",download:"Télécharger",copy:"Copier",share:"Partager",notSelected:"Non sélectionné",noAvatar:"Aucun avatar",rightClickOrLongPress:"Cliquer ou longue-cliquer pour sélectionner",type:"Type",deform:"Déformation",round:"Rond",rotate:"Rotation",avatarOnTop:"Avatar en haut",opacity:"Opacité",fit:"Ajustement",style:"Style",FLIP:"Retourner",MIRROR:"Miroir",GRAY:"Gris",BINARIZATION:"Binarisation"},ur={selectTemplate:"烟弹口味",uploadAvatar:"动物朋友的相片",setText:"自调烟油",result:"试抽一下",typeToSearch:"找一找",cancel:"不",save:"好了",add:"多一个",x:"左右",y:"上下",text:"藏话",color:"烟油颜色",size:"烟嘴尺寸",font:"雾化器",fontStyle:"雾化湿度",strokeSize:"烟杆长度",strokeColor:"烟杆颜色",hidden:"低欧姆雾化",delete:"不抽了",delay:"吐圈速度",play:"开溜",stop:"等会",workers:"线程数",quality:"质量",background:"背景",dither:"抖动",download:"下载",copy:"复制",share:"分享",notSelected:"芋泥波波",noAvatar:"雪豹已失联",rightClickOrLongPress:"右键或长按",type:"类型",deform:"变形",round:"圆形",rotate:"旋转",avatarOnTop:"头像置顶",opacity:"透明度",fit:"适应",style:"风格",FLIP:"翻转",MIRROR:"镜像",GRAY:"灰阶",BINARIZATION:"二值化"},hr={server:[window.location.origin+window.location.pathname,"https://d2n.moe/petpet-js","https://d2n.moe/petpet"],lang:void 0,template:void 0},cr=fr();function fr(){let e={...hr,...JSON.parse(localStorage.getItem("config"))||{}};function t(){localStorage.setItem("config",JSON.stringify(e))}return e.save=t,e=new Proxy(e,{set(r,a,n){return Array.isArray(r[a])?r[a]=new Proxy(n,{set(i,s,o){return i[s]=o,t(),!0},deleteProperty(i,s){return i.splice(s,1),t(),!0}}):r[a]=n,t(),!0}}),e}const dr=[{id:"zh-CN",text:"简体中文",alias:["zh"]},{id:"zh-TW",text:"繁體中文",alias:["zh-HK","zh-SG"]},{id:"en-US",text:"English",alias:["en","en-EG","en-AU","en-GB","en-CA","en-NZ","en-IE","en-ZA","en-JM","en-BZ","en-TT"]},{id:"ru",text:"русский язык",alias:["ru-RU"]},{id:"de",text:"Deutsch",alias:["de-CH","de-AT","de-LU","de-LI"]},{id:"es",text:"español",alias:["es-AR","es-GT","es-CR","es-PA","es-DO","es-MX","es-VE","es-CO","es-PE","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"]},{id:"fr",text:"Français",alias:["fr-BE","fr-CA","fr-CH","fr-LU"]},{id:"ja",text:"日本語",alias:["ja-JP"]},{id:"ko",text:"한국어",alias:["ko-KR"]}],be={en_US:tr,zh_TW:rr,zh_CN:ar,de:nr,fr:lr,ja:ir,ko:sr,ru:or,zh_DZ:ur};let Se=be[cr.lang];function pr(){if(Se)return Se;const e=navigator.language;let t="en-US";for(const r of dr){if(e===r.id){t=r.id;break}r.alias.forEach(a=>{a===e&&(t=r.id)})}return t=t.replace("-","_"),Se=be[t],be[t]}class vr{static from(){throw new Error}}function re(e,t){if(e.length!==t)throw new Error("array.length != "+t);return e}function fe(e,t=!1){const r=document.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:t});return r.width=e.width,r.height=e.height,a.drawImage(e,0,0),r}async function uo(e){const t=await me(e);return fe(t)}async function me(e){return new Promise((t,r)=>{const a=new Image;a.onload=()=>t(a),a.onerror=n=>r(n),a.src=URL.createObjectURL(e)})}function Bt(e="#ffffff00"){if(typeof e=="string")return e.startsWith("#")?e:e.length<<2?"#"+e:e;if(e.length&&e.length>=3&&e.length<=4){const[t,r,a,n=1]=e;return`rgba(${t}, ${r}, ${a}, ${n})`}throw new Error("cannot load color "+e)}function pt(e,t,r=!1){const a=document.createElement("canvas"),n=a.getContext("2d"),[i,s,o,u]=t.length===2?[0,0,t[0],t[1]]:t;let l=r?(o-i)/100*e.width:o-i,h=r?(u-s)/100*e.height:u-s;return a.width=r?l/100*e.width:l,a.height=r?h/100*e.height:h,n.drawImage(e,i,s,l,h,0,0,l,h),a}function gr(e){const t=document.createElement("canvas"),r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.translate(0,e.height),r.scale(1,-1),r.drawImage(e,0,0),t}function mr(e){const t=document.createElement("canvas"),r=t.getContext("2d");t.width=e.width,t.height=e.height,r.drawImage(e,0,0);const a=r.getImageData(0,0,t.width,t.height),n=a.data;for(let i=0;i<n.length;i+=4){const s=n[i],o=n[i+1],u=n[i+2],l=(s+o+u)/3;n[i]=l,n[i+1]=l,n[i+2]=l}return r.putImageData(a,0,0),t}var ho=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function co(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function fo(e){if(e.__esModule)return e;var t=e.default;if(typeof t=="function"){var r=function a(){if(this instanceof a){var n=[null];n.push.apply(n,arguments);var i=Function.bind.apply(t,n);return new i}return t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(a){var n=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(r,a,n.get?n:{enumerable:!0,get:function(){return e[a]}})}),r}var zt={},E={},Fe={};Object.defineProperty(Fe,"__esModule",{value:!0});var xr=function(){function e(t,r){for(var a=0;a<r.length;a++){var n=r[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}();function yr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var wr=function(){function e(t){yr(this,e);var r=t.length;this.xa=[],this.ya=[],this.u=[],this.y2=[],t.sort(function(u,l){return u[0]-l[0]});for(var a=0;a<r;a++)this.xa.push(t[a][0]),this.ya.push(t[a][1]);this.u[0]=0,this.y2[0]=0;for(var a=1;a<r-1;++a){var n=this.xa[a+1]-this.xa[a-1],i=(this.xa[a]-this.xa[a-1])/n,s=i*this.y2[a-1]+2;this.y2[a]=(i-1)/s;var o=(this.ya[a+1]-this.ya[a])/(this.xa[a+1]-this.xa[a])-(this.ya[a]-this.ya[a-1])/(this.xa[a]-this.xa[a-1]);this.u[a]=(6*o/n-i*this.u[a-1])/s}this.y2[r-1]=0;for(var a=r-2;a>=0;--a)this.y2[a]=this.y2[a]*this.y2[a+1]+this.u[a]}return xr(e,[{key:"interpolate",value:function(r){for(var a=this.ya.length,n=0,i=a-1;i-n>1;){var s=i+n>>1;this.xa[s]>r?i=s:n=s}var o=this.xa[i]-this.xa[n],u=(this.xa[i]-r)/o,l=(r-this.xa[n])/o;return u*this.ya[n]+l*this.ya[i]+((u*u*u-u)*this.y2[n]+(l*l*l-l)*this.y2[i])*(o*o)/6}}]),e}();Fe.default=wr;Object.defineProperty(E,"__esModule",{value:!0});E.simpleShader=Ar;E.clamp=Nt;E.splineInterpolate=Er;var _r=Fe,Tr=Cr(_r);function Cr(e){return e&&e.__esModule?e:{default:e}}function Ar(e,t,r,a){(r||this._.texture).use(),this._.spareTexture.drawTo(function(){e.uniforms(t).drawRect()}),this._.spareTexture.swapWith(a||this._.texture)}function Nt(e,t,r){return Math.max(e,Math.min(t,r))}function Er(e){for(var t=new Tr.default(e),r=[],a=0;a<256;a++)r.push(Nt(0,Math.floor(t.interpolate(a/255)*256),255));return r}var T={};Object.defineProperty(T,"__esModule",{value:!0});T.set=Sr;T.get=Mr;var ke={};function Sr(e){ke=Object.assign(ke,e)}function Mr(e){return ke[e]}var De={},M={};Object.defineProperty(M,"__esModule",{value:!0});var vt=function(){function e(t,r){for(var a=0;a<r.length;a++){var n=r[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),Or=T,Z=Rr(Or);function Rr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Pr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var br="attribute vec2 vertex;attribute vec2 _texCoord;varying vec2 texCoord;void main() {  texCoord = _texCoord;  gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);}",kr="uniform sampler2D texture;varying vec2 texCoord;void main() {  gl_FragColor = texture2D(texture, texCoord);}",Ir=function(){vt(e,null,[{key:"getDefaultShader",value:function(){var r=Z.get("gl");return r.defaultShader=r.defaultShader||new e,r.defaultShader}}]);function e(t,r){Pr(this,e);var a=Z.get("gl");if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=a.createProgram(),t=t||br,r=r||kr,r="precision highp float;"+r,a.attachShader(this.program,gt(a.VERTEX_SHADER,t)),a.attachShader(this.program,gt(a.FRAGMENT_SHADER,r)),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program)}return vt(e,[{key:"destroy",value:function(){var r=Z.get("gl");r.deleteProgram(this.program),this.program=null}},{key:"uniforms",value:function(r){var a=Z.get("gl");a.useProgram(this.program);for(var n in r)if(r.hasOwnProperty(n)){var i=a.getUniformLocation(this.program,n);if(i!==null){var s=r[n];if(Fr(s))switch(s.length){case 1:a.uniform1fv(i,new Float32Array(s));break;case 2:a.uniform2fv(i,new Float32Array(s));break;case 3:a.uniform3fv(i,new Float32Array(s));break;case 4:a.uniform4fv(i,new Float32Array(s));break;case 9:a.uniformMatrix3fv(i,!1,new Float32Array(s));break;case 16:a.uniformMatrix4fv(i,!1,new Float32Array(s));break;default:throw`dont't know how to load uniform "`+n+'" of length '+s.length}else if(Dr(s))a.uniform1f(i,s);else throw'attempted to set uniform "'+n+'" to invalid value '+(s||"undefined").toString()}}return this}},{key:"textures",value:function(r){var a=Z.get("gl");a.useProgram(this.program);for(var n in r)r.hasOwnProperty(n)&&a.uniform1i(a.getUniformLocation(this.program,n),r[n]);return this}},{key:"drawRect",value:function(r,a,n,i){var s=Z.get("gl"),o=s.getParameter(s.VIEWPORT);a=a!==void 0?(a-o[1])/o[3]:0,r=r!==void 0?(r-o[0])/o[2]:0,n=n!==void 0?(n-o[0])/o[2]:1,i=i!==void 0?(i-o[1])/o[3]:1,s.vertexBuffer==null&&(s.vertexBuffer=s.createBuffer()),s.bindBuffer(s.ARRAY_BUFFER,s.vertexBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([r,a,r,i,n,a,n,i]),s.STATIC_DRAW),s.texCoordBuffer==null&&(s.texCoordBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,s.texCoordBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),s.STATIC_DRAW)),this.vertexAttribute==null&&(this.vertexAttribute=s.getAttribLocation(this.program,"vertex"),s.enableVertexAttribArray(this.vertexAttribute)),this.texCoordAttribute==null&&(this.texCoordAttribute=s.getAttribLocation(this.program,"_texCoord"),s.enableVertexAttribArray(this.texCoordAttribute)),s.useProgram(this.program),s.bindBuffer(s.ARRAY_BUFFER,s.vertexBuffer),s.vertexAttribPointer(this.vertexAttribute,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,s.texCoordBuffer),s.vertexAttribPointer(this.texCoordAttribute,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4)}}]),e}();M.default=Ir;function Fr(e){return Object.prototype.toString.call(e)=="[object Array]"}function Dr(e){return Object.prototype.toString.call(e)=="[object Number]"}function gt(e,t){var r=Z.get("gl"),a=r.createShader(e);if(r.shaderSource(a,t),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS))throw"compile error: "+r.getShaderInfoLog(a);return a}Object.defineProperty(De,"__esModule",{value:!0});var mt=function(){function e(t,r){for(var a=0;a<r.length;a++){var n=r[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),$r=T,z=Lr($r),Br=M,zr=Nr(Br);function Nr(e){return e&&e.__esModule?e:{default:e}}function Lr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ur(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var q=null,qr=function(){mt(e,null,[{key:"fromElement",value:function(r){var a=z.get("gl"),n=new e(0,0,a.RGBA,a.UNSIGNED_BYTE);return n.loadContentsOf(r),n}}]);function e(t,r,a,n){Ur(this,e);var i=z.get("gl");this.gl=i,this.id=i.createTexture(),this.width=t,this.height=r,this.format=a,this.type=n,i.bindTexture(i.TEXTURE_2D,this.id),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),t&&r&&i.texImage2D(i.TEXTURE_2D,0,this.format,t,r,0,this.format,this.type,null)}return mt(e,[{key:"loadContentsOf",value:function(r){var a=z.get("gl");this.width=r.width||r.videoWidth,this.height=r.height||r.videoHeight,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,this.format,this.format,this.type,r)}},{key:"initFromBytes",value:function(r,a,n){var i=z.get("gl");this.width=r,this.height=a,this.format=i.RGBA,this.type=i.UNSIGNED_BYTE,i.bindTexture(i.TEXTURE_2D,this.id),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,r,a,0,i.RGBA,this.type,new Uint8Array(n))}},{key:"destroy",value:function(){var r=z.get("gl");r.deleteTexture(this.id),this.id=null}},{key:"use",value:function(r){var a=z.get("gl");a.activeTexture(a.TEXTURE0+(r||0)),a.bindTexture(a.TEXTURE_2D,this.id)}},{key:"unuse",value:function(r){var a=z.get("gl");a.activeTexture(a.TEXTURE0+(r||0)),a.bindTexture(a.TEXTURE_2D,null)}},{key:"ensureFormat",value:function(r,a,n,i){if(arguments.length==1){var s=arguments[0];r=s.width,a=s.height,n=s.format,i=s.type}if(r!=this.width||a!=this.height||n!=this.format||i!=this.type){var o=z.get("gl");this.width=r,this.height=a,this.format=n,this.type=i,o.bindTexture(o.TEXTURE_2D,this.id),o.texImage2D(o.TEXTURE_2D,0,this.format,r,a,0,this.format,this.type,null)}}},{key:"drawTo",value:function(r){var a=z.get("gl");if(a.framebuffer=a.framebuffer||a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,a.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.id,0),a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");a.viewport(0,0,this.width,this.height),r(),a.bindFramebuffer(a.FRAMEBUFFER,null)}},{key:"fillUsingCanvas",value:function(r){r(xt(this));var a=z.get("gl");return this.format=a.RGBA,this.type=a.UNSIGNED_BYTE,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,q),this}},{key:"toImage",value:function(r){this.use(),zr.default.getDefaultShader().drawRect();var a=z.get("gl"),n=this.width*this.height*4,i=new Uint8Array(n),s=xt(this),o=s.createImageData(this.width,this.height);a.readPixels(0,0,this.width,this.height,a.RGBA,a.UNSIGNED_BYTE,i);for(var u=0;u<n;u++)o.data[u]=i[u];s.putImageData(o,0,0),r.src=q.toDataURL()}},{key:"swapWith",value:function(r){var a;a=r.id,r.id=this.id,this.id=a,a=r.width,r.width=this.width,this.width=a,a=r.height,r.height=this.height,this.height=a,a=r.format,r.format=this.format,this.format=a}}]),e}();De.default=qr;function xt(e){q==null&&(q=document.createElement("canvas")),q.width=e.width,q.height=e.height;var t=q.getContext("2d");return t.clearRect(0,0,q.width,q.height),t}var Lt={},$e={};Object.defineProperty($e,"__esModule",{value:!0});$e.default=function(e,t){var r=Yr.get("gl");return r.brightnessContrast=r.brightnessContrast||new Wr.default(null,"    uniform sampler2D texture;    uniform float brightness;    uniform float contrast;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color.rgb += brightness;      if (contrast > 0.0) {        color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;      } else {        color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;      }      gl_FragColor = color;    }  "),Me.simpleShader.call(this,r.brightnessContrast,{brightness:(0,Me.clamp)(-1,e,1),contrast:(0,Me.clamp)(-1,t,1)}),this};var Gr=M,Wr=Vr(Gr),Me=E,Xr=T,Yr=Hr(Xr);function Hr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Vr(e){return e&&e.__esModule?e:{default:e}}var Be={};Object.defineProperty(Be,"__esModule",{value:!0});Be.default=function(e,t,r){var a=Jr.get("gl");e=(0,pe.splineInterpolate)(e),arguments.length==1?t=r=e:(t=(0,pe.splineInterpolate)(t),r=(0,pe.splineInterpolate)(r));for(var n=[],i=0;i<256;i++)n.splice(n.length,0,e[i],t[i],r[i],255);return this._.extraTexture.initFromBytes(256,1,n),this._.extraTexture.use(1),a.curves=a.curves||new Kr.default(null,"    uniform sampler2D texture;    uniform sampler2D map;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color.r = texture2D(map, vec2(color.r)).r;      color.g = texture2D(map, vec2(color.g)).g;      color.b = texture2D(map, vec2(color.b)).b;      gl_FragColor = color;    }  "),a.curves.textures({map:1}),pe.simpleShader.call(this,a.curves,{}),this};var Zr=M,Kr=ea(Zr),pe=E,Qr=T,Jr=jr(Qr);function jr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ea(e){return e&&e.__esModule?e:{default:e}}var ze={};Object.defineProperty(ze,"__esModule",{value:!0});ze.default=function(e){var t=ia.get("gl");t.denoise=t.denoise||new ra.default(null,"    uniform sampler2D texture;    uniform float exponent;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec4 center = texture2D(texture, texCoord);      vec4 color = vec4(0.0);      float total = 0.0;      for (float x = -4.0; x <= 4.0; x += 1.0) {        for (float y = -4.0; y <= 4.0; y += 1.0) {          vec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);          float weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));          weight = pow(weight, exponent);          color += sample * weight;          total += weight;        }      }      gl_FragColor = color / total;    }  ");for(var r=0;r<2;r++)aa.simpleShader.call(this,t.denoise,{exponent:Math.max(0,e),texSize:[this.width,this.height]});return this};var ta=M,ra=oa(ta),aa=E,na=T,ia=sa(na);function sa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function oa(e){return e&&e.__esModule?e:{default:e}}var Ne={};Object.defineProperty(Ne,"__esModule",{value:!0});Ne.default=function(e,t){var r=ca.get("gl");return r.hueSaturation=r.hueSaturation||new ua.default(null,"    uniform sampler2D texture;    uniform float hue;    uniform float saturation;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);            /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */      float angle = hue * 3.14159265;      float s = sin(angle), c = cos(angle);      vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;      float len = length(color.rgb);      color.rgb = vec3(        dot(color.rgb, weights.xyz),        dot(color.rgb, weights.zxy),        dot(color.rgb, weights.yzx)      );            /* saturation adjustment */      float average = (color.r + color.g + color.b) / 3.0;      if (saturation > 0.0) {        color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));      } else {        color.rgb += (average - color.rgb) * (-saturation);      }            gl_FragColor = color;    }  "),Oe.simpleShader.call(this,r.hueSaturation,{hue:(0,Oe.clamp)(-1,e,1),saturation:(0,Oe.clamp)(-1,t,1)}),this};var la=M,ua=da(la),Oe=E,ha=T,ca=fa(ha);function fa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function da(e){return e&&e.__esModule?e:{default:e}}var Le={};Object.defineProperty(Le,"__esModule",{value:!0});Le.default=function(e){var t=ma.get("gl");return t.noise=t.noise||new va.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    float rand(vec2 co) {      return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);    }    void main() {      vec4 color = texture2D(texture, texCoord);            float diff = (rand(texCoord) - 0.5) * amount;      color.r += diff;      color.g += diff;      color.b += diff;            gl_FragColor = color;    }  "),yt.simpleShader.call(this,t.noise,{amount:(0,yt.clamp)(0,e,1)}),this};var pa=M,va=ya(pa),yt=E,ga=T,ma=xa(ga);function xa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ya(e){return e&&e.__esModule?e:{default:e}}var Ue={};Object.defineProperty(Ue,"__esModule",{value:!0});Ue.default=function(e){var t=Ca.get("gl");return t.sepia=t.sepia||new _a.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      float r = color.r;      float g = color.g;      float b = color.b;            color.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));      color.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));      color.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));            gl_FragColor = color;    }  "),wt.simpleShader.call(this,t.sepia,{amount:(0,wt.clamp)(0,e,1)}),this};var wa=M,_a=Ea(wa),wt=E,Ta=T,Ca=Aa(Ta);function Aa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ea(e){return e&&e.__esModule?e:{default:e}}var qe={};Object.defineProperty(qe,"__esModule",{value:!0});qe.default=function(e,t){var r=Ra.get("gl");return r.unsharpMask=r.unsharpMask||new _t.default(null,"    uniform sampler2D blurredTexture;    uniform sampler2D originalTexture;    uniform float strength;    uniform float threshold;    varying vec2 texCoord;    void main() {      vec4 blurred = texture2D(blurredTexture, texCoord);      vec4 original = texture2D(originalTexture, texCoord);      gl_FragColor = mix(blurred, original, 1.0 + strength);    }  "),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo(function(){_t.default.getDefaultShader().drawRect()}),this._.extraTexture.use(1),this.triangleBlur(e),r.unsharpMask.textures({originalTexture:1}),Ma.simpleShader.call(this,r.unsharpMask,{strength:t}),this._.extraTexture.unuse(1),this};var Sa=M,_t=ba(Sa),Ma=E,Oa=T,Ra=Pa(Oa);function Pa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ba(e){return e&&e.__esModule?e:{default:e}}var Ge={};Object.defineProperty(Ge,"__esModule",{value:!0});Ge.default=function(e){var t=Da.get("gl");return t.vibrance=t.vibrance||new Ia.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      float average = (color.r + color.g + color.b) / 3.0;      float mx = max(color.r, max(color.g, color.b));      float amt = (mx - average) * (-amount * 3.0);      color.rgb = mix(color.rgb, vec3(mx), amt);      gl_FragColor = color;    }  "),Tt.simpleShader.call(this,t.vibrance,{amount:(0,Tt.clamp)(-1,e,1)}),this};var ka=M,Ia=Ba(ka),Tt=E,Fa=T,Da=$a(Fa);function $a(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ba(e){return e&&e.__esModule?e:{default:e}}var We={};Object.defineProperty(We,"__esModule",{value:!0});We.default=function(e,t){var r=Ua.get("gl");return r.vignette=r.vignette||new Na.default(null,"    uniform sampler2D texture;    uniform float size;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);            float dist = distance(texCoord, vec2(0.5, 0.5));      color.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));            gl_FragColor = color;    }  "),Re.simpleShader.call(this,r.vignette,{size:(0,Re.clamp)(0,e,1),amount:(0,Re.clamp)(0,t,1)}),this};var za=M,Na=Ga(za),Re=E,La=T,Ua=qa(La);function qa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ga(e){return e&&e.__esModule?e:{default:e}}var Xe={},B={};Object.defineProperty(B,"__esModule",{value:!0});B.randomShaderFunc=void 0;B.warpShader=Ha;var Wa=M,Xa=Ya(Wa);function Ya(e){return e&&e.__esModule?e:{default:e}}function Ha(e,t){return new Xa.default(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 coord = texCoord * texSize;      "+t+"      gl_FragColor = texture2D(texture, coord / texSize);      vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);      if (coord != clampedCoord) {        /* fade to transparent if we are outside the image */        gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));      }    }")}B.randomShaderFunc="  float random(vec3 scale, float seed) {    /* use the fragment position for a different seed per-pixel */    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);  }";Object.defineProperty(Xe,"__esModule",{value:!0});Xe.default=function(e,t,r){var a=Qa.get("gl");a.lensBlurPrePass=a.lensBlurPrePass||new ve.default(null,"    uniform sampler2D texture;    uniform float power;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color = pow(color, vec4(power));      gl_FragColor = vec4(color);    }  ");var n="    uniform sampler2D texture0;    uniform sampler2D texture1;    uniform vec2 delta0;    uniform vec2 delta1;    uniform float power;    varying vec2 texCoord;    "+Za.randomShaderFunc+"    vec4 sample(vec2 delta) {      /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(delta, 151.7182), 0.0);            vec4 color = vec4(0.0);      float total = 0.0;      for (float t = 0.0; t <= 30.0; t++) {        float percent = (t + offset) / 30.0;        color += texture2D(texture0, texCoord + delta * percent);        total += 1.0;      }      return color / total;    }  ";a.lensBlur0=a.lensBlur0||new ve.default(null,n+"    void main() {      gl_FragColor = sample(delta0);    }  "),a.lensBlur1=a.lensBlur1||new ve.default(null,n+"    void main() {      gl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;    }  "),a.lensBlur2=a.lensBlur2||new ve.default(null,n+"    void main() {      vec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;      gl_FragColor = pow(color, vec4(power));    }  ").textures({texture1:1});for(var i=[],s=0;s<3;s++){var o=r+s*Math.PI*2/3;i.push([e*Math.sin(o)/this.width,e*Math.cos(o)/this.height])}var u=Math.pow(10,(0,ae.clamp)(-1,t,1));return ae.simpleShader.call(this,a.lensBlurPrePass,{power:u}),this._.extraTexture.ensureFormat(this._.texture),ae.simpleShader.call(this,a.lensBlur0,{delta0:i[0]},this._.texture,this._.extraTexture),ae.simpleShader.call(this,a.lensBlur1,{delta0:i[1],delta1:i[2]},this._.extraTexture,this._.extraTexture),ae.simpleShader.call(this,a.lensBlur0,{delta0:i[1]}),this._.extraTexture.use(1),ae.simpleShader.call(this,a.lensBlur2,{power:1/u,delta0:i[2]}),this};var Va=M,ve=ja(Va),ae=E,Za=B,Ka=T,Qa=Ja(Ka);function Ja(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ja(e){return e&&e.__esModule?e:{default:e}}var Ye={};Object.defineProperty(Ye,"__esModule",{value:!0});Ye.default=function(e,t,r,a,n,i){var s=nn.get("gl");s.tiltShift=s.tiltShift||new tn.default(null,"    uniform sampler2D texture;    uniform float blurRadius;    uniform float gradientRadius;    uniform vec2 start;    uniform vec2 end;    uniform vec2 delta;    uniform vec2 texSize;    varying vec2 texCoord;    "+rn.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));      float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;      for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  ");var o=r-e,u=a-t,l=Math.sqrt(o*o+u*u);return Ct.simpleShader.call(this,s.tiltShift,{blurRadius:n,gradientRadius:i,start:[e,t],end:[r,a],delta:[o/l,u/l],texSize:[this.width,this.height]}),Ct.simpleShader.call(this,s.tiltShift,{blurRadius:n,gradientRadius:i,start:[e,t],end:[r,a],delta:[-u/l,o/l],texSize:[this.width,this.height]}),this};var en=M,tn=on(en),Ct=E,rn=B,an=T,nn=sn(an);function sn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function on(e){return e&&e.__esModule?e:{default:e}}var He={};Object.defineProperty(He,"__esModule",{value:!0});He.default=function(e){var t=fn.get("gl");return t.triangleBlur=t.triangleBlur||new un.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+hn.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec4 sample = texture2D(texture, texCoord + delta * percent);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  "),At.simpleShader.call(this,t.triangleBlur,{delta:[e/this.width,0]}),At.simpleShader.call(this,t.triangleBlur,{delta:[0,e/this.height]}),this};var ln=M,un=pn(ln),At=E,hn=B,cn=T,fn=dn(cn);function dn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function pn(e){return e&&e.__esModule?e:{default:e}}var Ve={};Object.defineProperty(Ve,"__esModule",{value:!0});Ve.default=function(e,t,r){var a=wn.get("gl");return a.zoomBlur=a.zoomBlur||new gn.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    "+xn.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;      vec2 toCenter = center - texCoord * texSize;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = 0.0; t <= 40.0; t++) {        float percent = (t + offset) / 40.0;        float weight = 4.0 * (percent - percent * percent);        vec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  "),mn.simpleShader.call(this,a.zoomBlur,{center:[e,t],strength:r,texSize:[this.width,this.height]}),this};var vn=M,gn=Tn(vn),mn=E,xn=B,yn=T,wn=_n(yn);function _n(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Tn(e){return e&&e.__esModule?e:{default:e}}var Ze={};Object.defineProperty(Ze,"__esModule",{value:!0});Ze.default=function(e,t,r,a){var n=Mn.get("gl");return n.colorHalftone=n.colorHalftone||new An.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float angle;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;        float pattern(float angle) {      float s = sin(angle), c = cos(angle);      vec2 tex = texCoord * texSize - center;      vec2 point = vec2(        c * tex.x - s * tex.y,        s * tex.x + c * tex.y      ) * scale;      return (sin(point.x) * sin(point.y)) * 4.0;    }        void main() {      vec4 color = texture2D(texture, texCoord);      vec3 cmy = 1.0 - color.rgb;      float k = min(cmy.x, min(cmy.y, cmy.z));      cmy = (cmy - k) / (1.0 - k);      cmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);      k = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);      gl_FragColor = vec4(1.0 - cmy - k, color.a);    }  "),En.simpleShader.call(this,n.colorHalftone,{center:[e,t],angle:r,scale:Math.PI/a,texSize:[this.width,this.height]}),this};var Cn=M,An=Rn(Cn),En=E,Sn=T,Mn=On(Sn);function On(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Rn(e){return e&&e.__esModule?e:{default:e}}var Ke={};Object.defineProperty(Ke,"__esModule",{value:!0});Ke.default=function(e,t,r,a){var n=Fn.get("gl");return n.dotScreen=n.dotScreen||new bn.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float angle;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;        float pattern() {      float s = sin(angle), c = cos(angle);      vec2 tex = texCoord * texSize - center;      vec2 point = vec2(        c * tex.x - s * tex.y,        s * tex.x + c * tex.y      ) * scale;      return (sin(point.x) * sin(point.y)) * 4.0;    }        void main() {      vec4 color = texture2D(texture, texCoord);      float average = (color.r + color.g + color.b) / 3.0;      gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);    }  "),kn.simpleShader.call(this,n.dotScreen,{center:[e,t],angle:r,scale:Math.PI/a,texSize:[this.width,this.height]}),this};var Pn=M,bn=$n(Pn),kn=E,In=T,Fn=Dn(In);function Dn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function $n(e){return e&&e.__esModule?e:{default:e}}var Qe={};Object.defineProperty(Qe,"__esModule",{value:!0});Qe.default=function(e){var t=Nn.get("gl");return t.edgeWork1=t.edgeWork1||new Et.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+Mt.randomShaderFunc+"    void main() {      vec2 color = vec2(0.0);      vec2 total = vec2(0.0);            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec3 sample = texture2D(texture, texCoord + delta * percent).rgb;        float average = (sample.r + sample.g + sample.b) / 3.0;        color.x += average * weight;        total.x += weight;        if (abs(t) < 15.0) {          weight = weight * 2.0 - 1.0;          color.y += average * weight;          total.y += weight;        }      }      gl_FragColor = vec4(color / total, 0.0, 1.0);    }  "),t.edgeWork2=t.edgeWork2||new Et.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+Mt.randomShaderFunc+"    void main() {      vec2 color = vec2(0.0);      vec2 total = vec2(0.0);            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec2 sample = texture2D(texture, texCoord + delta * percent).xy;        color.x += sample.x * weight;        total.x += weight;        if (abs(t) < 15.0) {          weight = weight * 2.0 - 1.0;          color.y += sample.y * weight;          total.y += weight;        }      }      float c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);      gl_FragColor = vec4(c, c, c, 1.0);    }  "),St.simpleShader.call(this,t.edgeWork1,{delta:[e/this.width,0]}),St.simpleShader.call(this,t.edgeWork2,{delta:[0,e/this.height]}),this};var Bn=M,Et=Un(Bn),St=E,Mt=B,zn=T,Nn=Ln(zn);function Ln(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Un(e){return e&&e.__esModule?e:{default:e}}var Je={};Object.defineProperty(Je,"__esModule",{value:!0});Je.default=function(e,t,r){var a=Yn.get("gl");return a.hexagonalPixelate=a.hexagonalPixelate||new Gn.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 tex = (texCoord * texSize - center) / scale;      tex.y /= 0.866025404;      tex.x -= tex.y * 0.5;            vec2 a;      if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));      else a = vec2(ceil(tex.x), ceil(tex.y));      vec2 b = vec2(ceil(tex.x), floor(tex.y));      vec2 c = vec2(floor(tex.x), ceil(tex.y));            vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);      vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);      vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);      vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);            float alen = length(TEX - A);      float blen = length(TEX - B);      float clen = length(TEX - C);            vec2 choice;      if (alen < blen) {        if (alen < clen) choice = a;        else choice = c;      } else {        if (blen < clen) choice = b;        else choice = c;      }            choice.x += choice.y * 0.5;      choice.y *= 0.866025404;      choice *= scale / texSize;      gl_FragColor = texture2D(texture, choice + center / texSize);    }  "),Wn.simpleShader.call(this,a.hexagonalPixelate,{center:[e,t],scale:r,texSize:[this.width,this.height]}),this};var qn=M,Gn=Vn(qn),Wn=E,Xn=T,Yn=Hn(Xn);function Hn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Vn(e){return e&&e.__esModule?e:{default:e}}var je={};Object.defineProperty(je,"__esModule",{value:!0});je.default=function(e){var t=jn.get("gl");return t.ink=t.ink||new Kn.default(null,"    uniform sampler2D texture;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 dx = vec2(1.0 / texSize.x, 0.0);      vec2 dy = vec2(0.0, 1.0 / texSize.y);      vec4 color = texture2D(texture, texCoord);      float bigTotal = 0.0;      float smallTotal = 0.0;      vec3 bigAverage = vec3(0.0);      vec3 smallAverage = vec3(0.0);      for (float x = -2.0; x <= 2.0; x += 1.0) {        for (float y = -2.0; y <= 2.0; y += 1.0) {          vec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;          bigAverage += sample;          bigTotal += 1.0;          if (abs(x) + abs(y) < 2.0) {            smallAverage += sample;            smallTotal += 1.0;          }        }      }      vec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);      gl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);    }  "),Qn.simpleShader.call(this,t.ink,{strength:e*e*e*e*e,texSize:[this.width,this.height]}),this};var Zn=M,Kn=ti(Zn),Qn=E,Jn=T,jn=ei(Jn);function ei(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ti(e){return e&&e.__esModule?e:{default:e}}var et={};Object.defineProperty(et,"__esModule",{value:!0});et.default=function(e,t,r,a){var n=ni.get("gl");return n.bulgePinch=n.bulgePinch||(0,ri.warpShader)("    uniform float radius;    uniform float strength;    uniform vec2 center;  ","    coord -= center;    float distance = length(coord);    if (distance < radius) {      float percent = distance / radius;      if (strength > 0.0) {        coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);      } else {        coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);      }    }    coord += center;  "),Ot.simpleShader.call(this,n.bulgePinch,{radius:r,strength:(0,Ot.clamp)(-1,a,1),center:[e,t],texSize:[this.width,this.height]}),this};var ri=B,Ot=E,ai=T,ni=ii(ai);function ii(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var tt={},le={};Object.defineProperty(le,"__esModule",{value:!0});le.getSquareToQuad=si;le.getInverse=oi;le.multiply=li;function si(e,t,r,a,n,i,s,o){var u=r-n,l=a-i,h=s-n,d=o-i,c=e-r+n-s,v=t-a+i-o,g=u*d-h*l,w=(c*d-h*v)/g,C=(u*v-c*l)/g;return[r-e+w*r,a-t+w*a,w,s-e+C*s,o-t+C*o,C,e,t,1]}function oi(e){var t=e[0],r=e[1],a=e[2],n=e[3],i=e[4],s=e[5],o=e[6],u=e[7],l=e[8],h=t*i*l-t*s*u-r*n*l+r*s*o+a*n*u-a*i*o;return[(i*l-s*u)/h,(a*u-r*l)/h,(r*s-a*i)/h,(s*o-n*l)/h,(t*l-a*o)/h,(a*n-t*s)/h,(n*u-i*o)/h,(r*o-t*u)/h,(t*i-r*n)/h]}function li(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}Object.defineProperty(tt,"__esModule",{value:!0});tt.default=function(e,t,r){var a=di.get("gl");if(a.matrixWarp=a.matrixWarp||(0,ui.warpShader)("    uniform mat3 matrix;    uniform bool useTextureSpace;  ","    if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;    vec3 warp = matrix * vec3(coord, 1.0);    coord = warp.xy / warp.z;    if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;  "),e=Array.prototype.concat.apply([],e),e.length==4)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(e.length!=9)throw"can only warp with 2x2 or 3x3 matrix";return ci.simpleShader.call(this,a.matrixWarp,{matrix:t?(0,hi.getInverse)(e):e,texSize:[this.width,this.height],useTextureSpace:r|0}),this};var ui=B,hi=le,ci=E,fi=T,di=pi(fi);function pi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var rt={};Object.defineProperty(rt,"__esModule",{value:!0});rt.default=function(e,t){var r=ge.getSquareToQuad.apply(null,t),a=ge.getSquareToQuad.apply(null,e),n=(0,ge.multiply)((0,ge.getInverse)(r),a);return this.matrixWarp(n)};var ge=le,at={};Object.defineProperty(at,"__esModule",{value:!0});at.default=function(e,t,r,a){var n=xi.get("gl");return n.swirl=n.swirl||(0,vi.warpShader)("    uniform float radius;    uniform float angle;    uniform vec2 center;  ","    coord -= center;    float distance = length(coord);    if (distance < radius) {      float percent = (radius - distance) / radius;      float theta = percent * percent * angle;      float s = sin(theta);      float c = cos(theta);      coord = vec2(        coord.x * c - coord.y * s,        coord.x * s + coord.y * c      );    }    coord += center;  "),gi.simpleShader.call(this,n.swirl,{radius:r,center:[e,t],angle:a,texSize:[this.width,this.height]}),this};var vi=B,gi=E,mi=T,xi=yi(mi);function yi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=$e;Object.defineProperty(e,"brightnessContrast",{enumerable:!0,get:function(){return x(t).default}});var r=Be;Object.defineProperty(e,"curves",{enumerable:!0,get:function(){return x(r).default}});var a=ze;Object.defineProperty(e,"denoise",{enumerable:!0,get:function(){return x(a).default}});var n=Ne;Object.defineProperty(e,"hueSaturation",{enumerable:!0,get:function(){return x(n).default}});var i=Le;Object.defineProperty(e,"noise",{enumerable:!0,get:function(){return x(i).default}});var s=Ue;Object.defineProperty(e,"sepia",{enumerable:!0,get:function(){return x(s).default}});var o=qe;Object.defineProperty(e,"unsharpMask",{enumerable:!0,get:function(){return x(o).default}});var u=Ge;Object.defineProperty(e,"vibrance",{enumerable:!0,get:function(){return x(u).default}});var l=We;Object.defineProperty(e,"vignette",{enumerable:!0,get:function(){return x(l).default}});var h=Xe;Object.defineProperty(e,"lensBlur",{enumerable:!0,get:function(){return x(h).default}});var d=Ye;Object.defineProperty(e,"tiltShift",{enumerable:!0,get:function(){return x(d).default}});var c=He;Object.defineProperty(e,"triangleBlur",{enumerable:!0,get:function(){return x(c).default}});var v=Ve;Object.defineProperty(e,"zoomBlur",{enumerable:!0,get:function(){return x(v).default}});var g=Ze;Object.defineProperty(e,"colorHalftone",{enumerable:!0,get:function(){return x(g).default}});var w=Ke;Object.defineProperty(e,"dotScreen",{enumerable:!0,get:function(){return x(w).default}});var C=Qe;Object.defineProperty(e,"edgeWork",{enumerable:!0,get:function(){return x(C).default}});var P=Je;Object.defineProperty(e,"hexagonalPixelate",{enumerable:!0,get:function(){return x(P).default}});var I=je;Object.defineProperty(e,"ink",{enumerable:!0,get:function(){return x(I).default}});var k=et;Object.defineProperty(e,"bulgePinch",{enumerable:!0,get:function(){return x(k).default}});var y=tt;Object.defineProperty(e,"matrixWarp",{enumerable:!0,get:function(){return x(y).default}});var O=rt;Object.defineProperty(e,"perspective",{enumerable:!0,get:function(){return x(O).default}});var f=at;Object.defineProperty(e,"swirl",{enumerable:!0,get:function(){return x(f).default}});function x(m){return m&&m.__esModule?m:{default:m}}})(Lt);(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.splineInterpolate=void 0;var t=E;Object.defineProperty(e,"splineInterpolate",{enumerable:!0,get:function(){return t.splineInterpolate}}),e.canvas=O;var r=T,a=d(r),n=De,i=h(n),s=M,o=h(s),u=Lt,l=d(u);function h(f){return f&&f.__esModule?f:{default:f}}function d(f){if(f&&f.__esModule)return f;var x={};if(f!=null)for(var m in f)Object.prototype.hasOwnProperty.call(f,m)&&(x[m]=f[m]);return x.default=f,x}function c(f){return{_:f,loadContentsOf:function(m){a.set({gl:this._.gl}),this._.loadContentsOf(m)},destroy:function(){a.set({gl:this._.gl}),this._.destroy()}}}function v(f){return c(i.default.fromElement(f))}function g(f,x){var m=a.get("gl"),D=m.UNSIGNED_BYTE;if(m.getExtension("OES_texture_float")&&m.getExtension("OES_texture_float_linear")){var V=new i.default(100,100,m.RGBA,m.FLOAT);try{V.drawTo(function(){D=m.FLOAT})}catch{}V.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=f,this.height=x,this._.texture=new i.default(f,x,m.RGBA,D),this._.spareTexture=new i.default(f,x,m.RGBA,D),this._.extraTexture=this._.extraTexture||new i.default(0,0,m.RGBA,D),this._.flippedShader=this._.flippedShader||new o.default(null,"	    uniform sampler2D texture;	    varying vec2 texCoord;	    void main() {	      gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));	    }	  "),this._.isInitialized=!0}function w(f,x,m){return(!this._.isInitialized||f._.width!=this.width||f._.height!=this.height)&&g.call(this,x||f._.width,m||f._.height),f._.use(),this._.texture.drawTo(function(){o.default.getDefaultShader().drawRect()}),this}function C(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function P(f){return f.parentNode.insertBefore(this,f),f.parentNode.removeChild(f),this}function I(){var f=a.get("gl"),x=new i.default(this._.texture.width,this._.texture.height,f.RGBA,f.UNSIGNED_BYTE);return this._.texture.use(),x.drawTo(function(){o.default.getDefaultShader().drawRect()}),c(x)}function k(){var f=a.get("gl"),x=this._.texture.width,m=this._.texture.height,D=new Uint8Array(x*m*4);return this._.texture.drawTo(function(){f.readPixels(0,0,x,m,f.RGBA,f.UNSIGNED_BYTE,D)}),D}function y(f){return function(){return a.set({gl:this._.gl}),f.apply(this,arguments)}}function O(){var f=arguments.length>0&&arguments[0]!==void 0?arguments[0]:document.createElement("canvas");try{a.set({gl:f.getContext("experimental-webgl",{premultipliedAlpha:!1})})}catch{a.set({gl:null})}var x=a.get("gl");if(!x)throw"This browser does not support WebGL";return f._={gl:x,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},f.texture=y(v),f.draw=y(w),f.update=y(C),f.replace=y(P),f.contents=y(I),f.getPixelArray=y(k),f.brightnessContrast=y(l.brightnessContrast),f.hexagonalPixelate=y(l.hexagonalPixelate),f.hueSaturation=y(l.hueSaturation),f.colorHalftone=y(l.colorHalftone),f.triangleBlur=y(l.triangleBlur),f.unsharpMask=y(l.unsharpMask),f.perspective=y(l.perspective),f.matrixWarp=y(l.matrixWarp),f.bulgePinch=y(l.bulgePinch),f.tiltShift=y(l.tiltShift),f.dotScreen=y(l.dotScreen),f.edgeWork=y(l.edgeWork),f.lensBlur=y(l.lensBlur),f.zoomBlur=y(l.zoomBlur),f.noise=y(l.noise),f.denoise=y(l.denoise),f.curves=y(l.curves),f.swirl=y(l.swirl),f.ink=y(l.ink),f.vignette=y(l.vignette),f.vibrance=y(l.vibrance),f.sepia=y(l.sepia),f}})(zt);class wi{constructor(t=!0){p(this,"fxCanvas",zt.canvas());p(this,"textureMap",new Map);p(this,"cache");this.cache=t}draw(t,r,a){const n=this.cache&&this.textureMap.has(r)?this.textureMap.get(r):this.fxCanvas.texture(r);this.cache&&!this.textureMap.has(r)&&this.textureMap.set(r,n);let[i,s]=a[0],[o,u]=a[1],[l,h]=a[2],[d,c]=a[3];const[v,g]=a[4];i+=v,o+=v,l+=v,d+=v,s+=g,u+=g,h+=g,c+=g;const w=t.canvas;this.fxCanvas.draw(n,w.width,w.height).perspective([0,0,w.width,0,0,w.height,w.width,w.height],[i,s,d,c,o,u,l,h]).update(),t.drawImage(this.fxCanvas,0,0),this.cache||n.destroy()}destroy(){if(this.cache)for(const t of[...this.textureMap.values()])t.destroy()}}function _i(e){const t=document.createElement("canvas"),r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.translate(e.width,0),r.scale(-1,1),r.drawImage(e,0,0),t}function Ti(e){const t=document.createElement("canvas"),r=t.getContext("2d"),a=e.width,n=e.height;t.width=a,t.height=n,r.drawImage(e,0,0);const i=r.getImageData(0,0,a,n),s=i.data;for(let o=0;o<s.length;o+=4){const u=s[o],l=s[o+1],h=s[o+2];u+l+h>383?(s[o]=255,s[o+1]=255,s[o+2]=255):(s[o]=0,s[o+1]=0,s[o+2]=0)}return r.putImageData(i,0,0),t}function Ci(e){const t=document.createElement("canvas"),r=t.getContext("2d"),a=Math.min(e.width,e.height)/2;return t.width=a*2,t.height=a*2,r.save(),r.beginPath(),r.arc(a,a,a,0,2*Math.PI),r.closePath(),r.clip(),r.drawImage(e,a-e.width/2,a-e.height/2),r.restore(),t}var $="INUMBER",ue="IOP1",he="IOP2",ce="IOP3",W="IVAR",ee="IVARNAME",ie="IFUNCALL",xe="IFUNDEF",F="IEXPR",nt="IEXPREVAL",te="IMEMBER",ye="IENDSTATEMENT",se="IARRAY";function _(e,t){this.type=e,this.value=t??0}_.prototype.toString=function(){switch(this.type){case $:case ue:case he:case ce:case W:case ee:case ye:return this.value;case ie:return"CALL "+this.value;case xe:return"DEF "+this.value;case se:return"ARRAY "+this.value;case te:return"."+this.value;default:return"Invalid Instruction"}};function we(e){return new _(ue,e)}function H(e){return new _(he,e)}function Ut(e){return new _(ce,e)}function Ie(e,t,r,a,n){for(var i=[],s=[],o,u,l,h,d=0;d<e.length;d++){var c=e[d],v=c.type;if(v===$||v===ee)Array.isArray(c.value)?i.push.apply(i,Ie(c.value.map(function(g){return new _($,g)}).concat(new _(se,c.value.length)),t,r,a,n)):i.push(c);else if(v===W&&n.hasOwnProperty(c.value))c=new _($,n[c.value]),i.push(c);else if(v===he&&i.length>1)u=i.pop(),o=i.pop(),h=r[c.value],c=new _($,h(o.value,u.value)),i.push(c);else if(v===ce&&i.length>2)l=i.pop(),u=i.pop(),o=i.pop(),c.value==="?"?i.push(o.value?u.value:l.value):(h=a[c.value],c=new _($,h(o.value,u.value,l.value)),i.push(c));else if(v===ue&&i.length>0)o=i.pop(),h=t[c.value],c=new _($,h(o.value)),i.push(c);else if(v===F){for(;i.length>0;)s.push(i.shift());s.push(new _(F,Ie(c.value,t,r,a,n)))}else if(v===te&&i.length>0)o=i.pop(),i.push(new _($,o.value[c.value]));else{for(;i.length>0;)s.push(i.shift());s.push(c)}}for(;i.length>0;)s.push(i.shift());return s}function qt(e,t,r){for(var a=[],n=0;n<e.length;n++){var i=e[n],s=i.type;if(s===W&&i.value===t)for(var o=0;o<r.tokens.length;o++){var u=r.tokens[o],l;u.type===ue?l=we(u.value):u.type===he?l=H(u.value):u.type===ce?l=Ut(u.value):l=new _(u.type,u.value),a.push(l)}else s===F?a.push(new _(F,qt(i.value,t,r))):a.push(i)}return a}function K(e,t,r){var a=[],n,i,s,o,u,l;if(it(e))return U(e,r);for(var h=e.length,d=0;d<h;d++){var c=e[d],v=c.type;if(v===$||v===ee)a.push(c.value);else if(v===he)i=a.pop(),n=a.pop(),c.value==="and"?a.push(n?!!K(i,t,r):!1):c.value==="or"?a.push(n?!0:!!K(i,t,r)):c.value==="="?(o=t.binaryOps[c.value],a.push(o(n,K(i,t,r),r))):(o=t.binaryOps[c.value],a.push(o(U(n,r),U(i,r))));else if(v===ce)s=a.pop(),i=a.pop(),n=a.pop(),c.value==="?"?a.push(K(n?i:s,t,r)):(o=t.ternaryOps[c.value],a.push(o(U(n,r),U(i,r),U(s,r))));else if(v===W)if(c.value in t.functions)a.push(t.functions[c.value]);else if(c.value in t.unaryOps&&t.parser.isOperatorEnabled(c.value))a.push(t.unaryOps[c.value]);else{var g=r[c.value];if(g!==void 0)a.push(g);else throw new Error("undefined variable: "+c.value)}else if(v===ue)n=a.pop(),o=t.unaryOps[c.value],a.push(o(U(n,r)));else if(v===ie){for(l=c.value,u=[];l-- >0;)u.unshift(U(a.pop(),r));if(o=a.pop(),o.apply&&o.call)a.push(o.apply(void 0,u));else throw new Error(o+" is not a function")}else if(v===xe)a.push(function(){for(var w=a.pop(),C=[],P=c.value;P-- >0;)C.unshift(a.pop());var I=a.pop(),k=function(){for(var y=Object.assign({},r),O=0,f=C.length;O<f;O++)y[C[O]]=arguments[O];return K(w,t,y)};return Object.defineProperty(k,"name",{value:I,writable:!1}),r[I]=k,k}());else if(v===F)a.push(Ai(c,t));else if(v===nt)a.push(c);else if(v===te)n=a.pop(),a.push(n[c.value]);else if(v===ye)a.pop();else if(v===se){for(l=c.value,u=[];l-- >0;)u.unshift(a.pop());a.push(u)}else throw new Error("invalid Expression")}if(a.length>1)throw new Error("invalid Expression (parity)");return a[0]===0?0:U(a[0],r)}function Ai(e,t,r){return it(e)?e:{type:nt,value:function(a){return K(e.value,t,a)}}}function it(e){return e&&e.type===nt}function U(e,t){return it(e)?e.value(t):e}function st(e,t){for(var r=[],a,n,i,s,o,u,l=0;l<e.length;l++){var h=e[l],d=h.type;if(d===$)typeof h.value=="number"&&h.value<0?r.push("("+h.value+")"):Array.isArray(h.value)?r.push("["+h.value.map(Rt).join(", ")+"]"):r.push(Rt(h.value));else if(d===he)n=r.pop(),a=r.pop(),s=h.value,t?s==="^"?r.push("Math.pow("+a+", "+n+")"):s==="and"?r.push("(!!"+a+" && !!"+n+")"):s==="or"?r.push("(!!"+a+" || !!"+n+")"):s==="||"?r.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+a+"),("+n+")))"):s==="=="?r.push("("+a+" === "+n+")"):s==="!="?r.push("("+a+" !== "+n+")"):s==="["?r.push(a+"[("+n+") | 0]"):r.push("("+a+" "+s+" "+n+")"):s==="["?r.push(a+"["+n+"]"):r.push("("+a+" "+s+" "+n+")");else if(d===ce)if(i=r.pop(),n=r.pop(),a=r.pop(),s=h.value,s==="?")r.push("("+a+" ? "+n+" : "+i+")");else throw new Error("invalid Expression");else if(d===W||d===ee)r.push(h.value);else if(d===ue)a=r.pop(),s=h.value,s==="-"||s==="+"?r.push("("+s+a+")"):t?s==="not"?r.push("(!"+a+")"):s==="!"?r.push("fac("+a+")"):r.push(s+"("+a+")"):s==="!"?r.push("("+a+"!)"):r.push("("+s+" "+a+")");else if(d===ie){for(u=h.value,o=[];u-- >0;)o.unshift(r.pop());s=r.pop(),r.push(s+"("+o.join(", ")+")")}else if(d===xe){for(n=r.pop(),u=h.value,o=[];u-- >0;)o.unshift(r.pop());a=r.pop(),t?r.push("("+a+" = function("+o.join(", ")+") { return "+n+" })"):r.push("("+a+"("+o.join(", ")+") = "+n+")")}else if(d===te)a=r.pop(),r.push(a+"."+h.value);else if(d===se){for(u=h.value,o=[];u-- >0;)o.unshift(r.pop());r.push("["+o.join(", ")+"]")}else if(d===F)r.push("("+st(h.value,t)+")");else if(d!==ye)throw new Error("invalid Expression")}return r.length>1&&(t?r=[r.join(",")]:r=[r.join(";")]),String(r[0])}function Rt(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function ne(e,t){for(var r=0;r<e.length;r++)if(e[r]===t)return!0;return!1}function ot(e,t,r){r=r||{};for(var a=!!r.withMembers,n=null,i=0;i<e.length;i++){var s=e[i];s.type===W||s.type===ee?!a&&!ne(t,s.value)?t.push(s.value):(n!==null&&(ne(t,n)||t.push(n)),n=s.value):s.type===te&&a&&n!==null?n+="."+s.value:s.type===F?ot(s.value,t,r):n!==null&&(ne(t,n)||t.push(n),n=null)}n!==null&&!ne(t,n)&&t.push(n)}function L(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}L.prototype.simplify=function(e){return e=e||{},new L(Ie(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};L.prototype.substitute=function(e,t){return t instanceof L||(t=this.parser.parse(String(t))),new L(qt(this.tokens,e,t),this.parser)};L.prototype.evaluate=function(e){return e=e||{},K(this.tokens,this,e)};L.prototype.toString=function(){return st(this.tokens,!1)};L.prototype.symbols=function(e){e=e||{};var t=[];return ot(this.tokens,t,e),t};L.prototype.variables=function(e){e=e||{};var t=[];ot(this.tokens,t,e);var r=this.functions;return t.filter(function(a){return!(a in r)})};L.prototype.toJSFunction=function(e,t){var r=this,a=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+st(this.simplify(t).tokens,!0)+"; }");return function(){return a.apply(r,arguments)}};var de="TEOF",A="TOP",_e="TNUMBER",Gt="TSTRING",X="TPAREN",oe="TBRACKET",Te="TCOMMA",lt="TNAME",ut="TSEMICOLON";function Wt(e,t,r){this.type=e,this.value=t,this.index=r}Wt.prototype.toString=function(){return this.type+": "+this.value};function R(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}R.prototype.newToken=function(e,t,r){return new Wt(e,t,r??this.pos)};R.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};R.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};R.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(de,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};R.prototype.isString=function(){var e=!1,t=this.pos,r=this.expression.charAt(t);if(r==="'"||r==='"')for(var a=this.expression.indexOf(r,t+1);a>=0&&this.pos<this.expression.length;){if(this.pos=a+1,this.expression.charAt(a-1)!=="\\"){var n=this.expression.substring(t+1,a);this.current=this.newToken(Gt,this.unescape(n),t),e=!0;break}a=this.expression.indexOf(r,a+1)}return e};R.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(X,e),this.pos++,!0):!1};R.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(oe,e),this.pos++,!0):!1};R.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(Te,","),this.pos++,!0):!1};R.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(ut,";"),this.pos++,!0):!1};R.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&r!=="."&&(r<"0"||r>"9")))break}if(t>e){var a=this.expression.substring(e,t);if(a in this.consts)return this.current=this.newToken(_e,this.consts[a]),this.pos+=a.length,!0}return!1};R.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&(r<"0"||r>"9")))break}if(t>e){var a=this.expression.substring(e,t);if(this.isOperatorEnabled(a)&&(a in this.binaryOps||a in this.unaryOps||a in this.ternaryOps))return this.current=this.newToken(A,a),this.pos+=a.length,!0}return!1};R.prototype.isName=function(){for(var e=this.pos,t=e,r=!1;t<this.expression.length;t++){var a=this.expression.charAt(t);if(a.toUpperCase()===a.toLowerCase()){if(t===this.pos&&(a==="$"||a==="_")){a==="_"&&(r=!0);continue}else if(t===this.pos||!r||a!=="_"&&(a<"0"||a>"9"))break}else r=!0}if(r){var n=this.expression.substring(e,t);return this.current=this.newToken(lt,n),this.pos+=n.length,!0}return!1};R.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var Ei=/^[0-9a-f]{4}$/i;R.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var r=e.substring(0,t);t>=0;){var a=e.charAt(++t);switch(a){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+=`
`;break;case"r":r+="\r";break;case"t":r+="	";break;case"u":var n=e.substring(t+1,t+5);Ei.test(n)||this.parseError("Illegal escape sequence: \\u"+n),r+=String.fromCharCode(parseInt(n,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+a+'"')}++t;var i=e.indexOf("\\",t);r+=e.substring(t,i<0?e.length:i),t=i}return r};R.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};R.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,r;if(this.expression.charAt(e)==="x")t=16,r=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,r=/^[01]$/i,++e;else return!1;for(var a=!1,n=e;e<this.expression.length;){var i=this.expression.charAt(e);if(r.test(i))e++,a=!0;else break}return a&&(this.current=this.newToken(_e,parseInt(this.expression.substring(n,e),t)),this.pos=e),a};R.prototype.isNumber=function(){for(var e=!1,t=this.pos,r=t,a=t,n=!1,i=!1,s;t<this.expression.length&&(s=this.expression.charAt(t),s>="0"&&s<="9"||!n&&s===".");)s==="."?n=!0:i=!0,t++,e=i;if(e&&(a=t),s==="e"||s==="E"){t++;for(var o=!0,u=!1;t<this.expression.length;){if(s=this.expression.charAt(t),o&&(s==="+"||s==="-"))o=!1;else if(s>="0"&&s<="9")u=!0,o=!1;else break;t++}u||(t=a)}return e?(this.current=this.newToken(_e,parseFloat(this.expression.substring(r,t))),this.pos=t):this.pos=a,e};R.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(A,t);else if(t==="∙"||t==="•")this.current=this.newToken(A,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(A,">="),this.pos++):this.current=this.newToken(A,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(A,"<="),this.pos++):this.current=this.newToken(A,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(A,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(A,"=="),this.pos++):this.current=this.newToken(A,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(A,"!="),this.pos++):this.current=this.newToken(A,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};R.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};R.prototype.getCoordinates=function(){var e=0,t,r=-1;do e++,t=this.pos-r,r=this.expression.indexOf(`
`,r+1);while(r>=0&&r<this.pos);return{line:e,column:t}};R.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function S(e,t,r){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=r.allowMemberAccess!==!1}S.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};S.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?ne(t,e.value):typeof t=="function"?t(e):e.value===t};S.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};S.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};S.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};S.prototype.expect=function(e,t){if(!this.accept(e,t)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(t||e))}};S.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function r(n){return n.value in t}if(this.accept(lt)||this.accept(A,r))e.push(new _(W,this.current.value));else if(this.accept(_e))e.push(new _($,this.current.value));else if(this.accept(Gt))e.push(new _($,this.current.value));else if(this.accept(X,"("))this.parseExpression(e),this.expect(X,")");else if(this.accept(oe,"["))if(this.accept(oe,"]"))e.push(new _(se,0));else{var a=this.parseArrayList(e);e.push(new _(se,a))}else throw new Error("unexpected "+this.nextToken)};S.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};S.prototype.pushExpression=function(e,t){for(var r=0,a=t.length;r<a;r++)e.push(t[r])};S.prototype.parseUntilEndStatement=function(e,t){return this.accept(ut)?(this.nextToken&&this.nextToken.type!==de&&!(this.nextToken.type===X&&this.nextToken.value===")")&&t.push(new _(ye)),this.nextToken.type!==de&&this.parseExpression(t),e.push(new _(F,t)),!0):!1};S.prototype.parseArrayList=function(e){for(var t=0;!this.accept(oe,"]");)for(this.parseExpression(e),++t;this.accept(Te);)this.parseExpression(e),++t;return t};S.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(A,"=");){var t=e.pop(),r=[],a=e.length-1;if(t.type===ie){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var n=0,i=t.value+1;n<i;n++){var s=a-n;e[s].type===W&&(e[s]=new _(ee,e[s].value))}this.parseVariableAssignmentExpression(r),e.push(new _(F,r)),e.push(new _(xe,t.value));continue}if(t.type!==W&&t.type!==te)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),e.push(new _(ee,t.value)),e.push(new _(F,r)),e.push(H("="))}};S.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(A,"?");){var t=[],r=[];this.parseConditionalExpression(t),this.expect(A,":"),this.parseConditionalExpression(r),e.push(new _(F,t)),e.push(new _(F,r)),e.push(Ut("?"))}};S.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(A,"or");){var t=[];this.parseAndExpression(t),e.push(new _(F,t)),e.push(H("or"))}};S.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(A,"and");){var t=[];this.parseComparison(t),e.push(new _(F,t)),e.push(H("and"))}};var Si=["==","!=","<","<=",">=",">","in"];S.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(A,Si);){var t=this.current;this.parseAddSub(e),e.push(H(t.value))}};var Mi=["+","-","||"];S.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(A,Mi);){var t=this.current;this.parseTerm(e),e.push(H(t.value))}};var Oi=["*","/","%"];S.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(A,Oi);){var t=this.current;this.parseFactor(e),e.push(H(t.value))}};S.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function r(n){return n.value in t}if(this.save(),this.accept(A,r)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===X&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===ut||this.nextToken.type===Te||this.nextToken.type===de||this.nextToken.type===X&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var a=this.current;this.parseFactor(e),e.push(we(a.value))}else this.parseExponential(e)};S.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(A,"^");)this.parseFactor(e),e.push(H("^"))};S.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(A,"!");)e.push(we("!"))};S.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.accept(A,r)){var a=this.current;this.parseAtom(e),e.push(we(a.value))}else for(this.parseMemberExpression(e);this.accept(X,"(");)if(this.accept(X,")"))e.push(new _(ie,0));else{var n=this.parseArgumentList(e);e.push(new _(ie,n))}};S.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(X,")");)for(this.parseExpression(e),++t;this.accept(Te);)this.parseExpression(e),++t;return t};S.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(A,".")||this.accept(oe,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(lt),e.push(new _(te,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(oe,"]"),e.push(H("["))}else throw new Error("unexpected symbol: "+t.value)}};function Ri(e,t){return Number(e)+Number(t)}function Pi(e,t){return e-t}function bi(e,t){return e*t}function ki(e,t){return e/t}function Ii(e,t){return e%t}function Fi(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function Di(e,t){return e===t}function $i(e,t){return e!==t}function Bi(e,t){return e>t}function zi(e,t){return e<t}function Ni(e,t){return e>=t}function Li(e,t){return e<=t}function Ui(e,t){return!!(e&&t)}function qi(e,t){return!!(e||t)}function Gi(e,t){return ne(t,e)}function Wi(e){return(Math.exp(e)-Math.exp(-e))/2}function Xi(e){return(Math.exp(e)+Math.exp(-e))/2}function Yi(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function Hi(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function Vi(e){return Math.log(e+Math.sqrt(e*e-1))}function Zi(e){return Math.log((1+e)/(1-e))/2}function Pt(e){return Math.log(e)*Math.LOG10E}function Ki(e){return-e}function Qi(e){return!e}function Ji(e){return e<0?Math.ceil(e):Math.floor(e)}function ji(e){return Math.random()*(e||1)}function bt(e){return ht(e+1)}function es(e){return isFinite(e)&&e===Math.round(e)}var ts=4.7421875,Pe=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function ht(e){var t,r;if(es(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var a=e-2,n=e-1;a>1;)n*=a,a--;return n===0&&(n=1),n}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*ht(1-e));if(e>=171.35)return 1/0;if(e>85){var i=e*e,s=i*e,o=s*e,u=o*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*i)-139/(51840*s)-571/(2488320*o)+163879/(209018880*u)+5246819/(75246796800*u*e))}--e,r=Pe[0];for(var l=1;l<Pe.length;++l)r+=Pe[l]/(e+l);return t=e+ts+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*r}function rs(e){return Array.isArray(e)?e.length:String(e).length}function kt(){for(var e=0,t=0,r=0;r<arguments.length;r++){var a=Math.abs(arguments[r]),n;t<a?(n=t/a,e=e*n*n+1,t=a):a>0?(n=a/t,e+=n*n):e+=a}return t===1/0?1/0:t*Math.sqrt(e)}function It(e,t,r){return e?t:r}function as(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function ns(e,t,r){return r&&(r[e]=t),t}function is(e,t){return e[t|0]}function ss(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function os(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function ls(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(r,a){return e(r,a)})}function us(e,t,r){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce(function(a,n,i){return e(a,n,i)},t)}function hs(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(r,a){return e(r,a)})}function cs(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function fs(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function ds(e){return(e>0)-(e<0)||+e}var Ft=1/3;function ps(e){return e<0?-Math.pow(-e,Ft):Math.pow(e,Ft)}function vs(e){return Math.exp(e)-1}function gs(e){return Math.log(1+e)}function ms(e){return Math.log(e)/Math.LN2}function Y(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Wi,cosh:Math.cosh||Xi,tanh:Math.tanh||Yi,asinh:Math.asinh||Hi,acosh:Math.acosh||Vi,atanh:Math.atanh||Zi,sqrt:Math.sqrt,cbrt:Math.cbrt||ps,log:Math.log,log2:Math.log2||ms,ln:Math.log,lg:Math.log10||Pt,log10:Math.log10||Pt,expm1:Math.expm1||vs,log1p:Math.log1p||gs,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Ji,"-":Ki,"+":Number,exp:Math.exp,not:Qi,length:rs,"!":bt,sign:Math.sign||ds},this.binaryOps={"+":Ri,"-":Pi,"*":bi,"/":ki,"%":Ii,"^":Math.pow,"||":Fi,"==":Di,"!=":$i,">":Bi,"<":zi,">=":Ni,"<=":Li,and:Ui,or:qi,in:Gi,"=":ns,"[":is},this.ternaryOps={"?":It},this.functions={random:ji,fac:bt,min:os,max:ss,hypot:Math.hypot||kt,pyt:Math.hypot||kt,pow:Math.pow,atan2:Math.atan2,if:It,gamma:ht,roundTo:as,map:ls,fold:us,filter:hs,indexOf:cs,join:fs},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Y.prototype.parse=function(e){var t=[],r=new S(this,new R(this,e),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(t),r.expect(de,"EOF"),new L(t,this)};Y.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Xt=new Y;Y.parse=function(e){return Xt.parse(e)};Y.evaluate=function(e,t){return Xt.parse(e).evaluate(t)};var Dt={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function xs(e){return Dt.hasOwnProperty(e)?Dt[e]:e}Y.prototype.isOperatorEnabled=function(e){var t=xs(e),r=this.options.operators||{};return!(t in r)||!!r[t]};var j={},Yt={},G={};Object.defineProperty(G,"__esModule",{value:!0});G.loop=G.conditional=G.parse=void 0;var ys=function e(t,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:a;if(Array.isArray(r))r.forEach(function(s){return e(t,s,a,n)});else if(typeof r=="function")r(t,a,n,e);else{var i=Object.keys(r)[0];Array.isArray(r[i])?(n[i]={},e(t,r[i],a,n[i])):n[i]=r[i](t,a,n,e)}return a};G.parse=ys;var ws=function(t,r){return function(a,n,i,s){r(a,n,i)&&s(a,t,n,i)}};G.conditional=ws;var _s=function(t,r){return function(a,n,i,s){for(var o=[],u=a.pos;r(a,n,i);){var l={};if(s(a,t,n,l),a.pos===u)break;u=a.pos,o.push(l)}return o}};G.loop=_s;var b={};Object.defineProperty(b,"__esModule",{value:!0});b.readBits=b.readArray=b.readUnsigned=b.readString=b.peekBytes=b.readBytes=b.peekByte=b.readByte=b.buildStream=void 0;var Ts=function(t){return{data:t,pos:0}};b.buildStream=Ts;var Ht=function(){return function(t){return t.data[t.pos++]}};b.readByte=Ht;var Cs=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(r){return r.data[r.pos+t]}};b.peekByte=Cs;var Ce=function(t){return function(r){return r.data.subarray(r.pos,r.pos+=t)}};b.readBytes=Ce;var As=function(t){return function(r){return r.data.subarray(r.pos,r.pos+t)}};b.peekBytes=As;var Es=function(t){return function(r){return Array.from(Ce(t)(r)).map(function(a){return String.fromCharCode(a)}).join("")}};b.readString=Es;var Ss=function(t){return function(r){var a=Ce(2)(r);return t?(a[1]<<8)+a[0]:(a[0]<<8)+a[1]}};b.readUnsigned=Ss;var Ms=function(t,r){return function(a,n,i){for(var s=typeof r=="function"?r(a,n,i):r,o=Ce(t),u=new Array(s),l=0;l<s;l++)u[l]=o(a);return u}};b.readArray=Ms;var Os=function(t,r,a){for(var n=0,i=0;i<a;i++)n+=t[r+i]&&Math.pow(2,a-i-1);return n},Rs=function(t){return function(r){for(var a=Ht()(r),n=new Array(8),i=0;i<8;i++)n[7-i]=!!(a&1<<i);return Object.keys(t).reduce(function(s,o){var u=t[o];return u.length?s[o]=Os(n,u.index,u.length):s[o]=n[u.index],s},{})}};b.readBits=Rs;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=G,r=b,a={blocks:function(c){for(var v=0,g=[],w=c.data.length,C=0,P=(0,r.readByte)()(c);P!==v&&P;P=(0,r.readByte)()(c)){if(c.pos+P>=w){var I=w-c.pos;g.push((0,r.readBytes)(I)(c)),C+=I;break}g.push((0,r.readBytes)(P)(c)),C+=P}for(var k=new Uint8Array(C),y=0,O=0;O<g.length;O++)k.set(g[O],y),y+=g[O].length;return k}},n=(0,t.conditional)({gce:[{codes:(0,r.readBytes)(2)},{byteSize:(0,r.readByte)()},{extras:(0,r.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,r.readUnsigned)(!0)},{transparentColorIndex:(0,r.readByte)()},{terminator:(0,r.readByte)()}]},function(d){var c=(0,r.peekBytes)(2)(d);return c[0]===33&&c[1]===249}),i=(0,t.conditional)({image:[{code:(0,r.readByte)()},{descriptor:[{left:(0,r.readUnsigned)(!0)},{top:(0,r.readUnsigned)(!0)},{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{lct:(0,r.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,t.conditional)({lct:(0,r.readArray)(3,function(d,c,v){return Math.pow(2,v.descriptor.lct.size+1)})},function(d,c,v){return v.descriptor.lct.exists}),{data:[{minCodeSize:(0,r.readByte)()},a]}]},function(d){return(0,r.peekByte)()(d)===44}),s=(0,t.conditional)({text:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{preData:function(c,v,g){return(0,r.readBytes)(g.text.blockSize)(c)}},a]},function(d){var c=(0,r.peekBytes)(2)(d);return c[0]===33&&c[1]===1}),o=(0,t.conditional)({application:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{id:function(c,v,g){return(0,r.readString)(g.blockSize)(c)}},a]},function(d){var c=(0,r.peekBytes)(2)(d);return c[0]===33&&c[1]===255}),u=(0,t.conditional)({comment:[{codes:(0,r.readBytes)(2)},a]},function(d){var c=(0,r.peekBytes)(2)(d);return c[0]===33&&c[1]===254}),l=[{header:[{signature:(0,r.readString)(3)},{version:(0,r.readString)(3)}]},{lsd:[{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{gct:(0,r.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,r.readByte)()},{pixelAspectRatio:(0,r.readByte)()}]},(0,t.conditional)({gct:(0,r.readArray)(3,function(d,c){return Math.pow(2,c.lsd.gct.size+1)})},function(d,c){return c.lsd.gct.exists}),{frames:(0,t.loop)([n,o,u,i,s],function(d){var c=(0,r.peekByte)()(d);return c===33||c===44})}],h=l;e.default=h})(Yt);var Ae={};Object.defineProperty(Ae,"__esModule",{value:!0});Ae.deinterlace=void 0;var Ps=function(t,r){for(var a=new Array(t.length),n=t.length/r,i=function(c,v){var g=t.slice(v*r,(v+1)*r);a.splice.apply(a,[c*r,r].concat(g))},s=[0,4,2,1],o=[8,8,4,2],u=0,l=0;l<4;l++)for(var h=s[l];h<n;h+=o[l])i(h,u),u++;return a};Ae.deinterlace=Ps;var Ee={};Object.defineProperty(Ee,"__esModule",{value:!0});Ee.lzw=void 0;var bs=function(t,r,a){var n=4096,i=-1,s=a,o,u,l,h,d,c,v,f,g,w,O,C,x,m,V,D,P=new Array(a),I=new Array(n),k=new Array(n),y=new Array(n+1);for(C=t,u=1<<C,d=u+1,o=u+2,v=i,h=C+1,l=(1<<h)-1,g=0;g<u;g++)I[g]=0,k[g]=g;var O,f,x,m,D,V;for(O=f=x=m=D=V=0,w=0;w<s;){if(m===0){if(f<h){O+=r[V]<<f,f+=8,V++;continue}if(g=O&l,O>>=h,f-=h,g>o||g==d)break;if(g==u){h=C+1,l=(1<<h)-1,o=u+2,v=i;continue}if(v==i){y[m++]=k[g],v=g,x=g;continue}for(c=g,g==o&&(y[m++]=x,g=v);g>u;)y[m++]=k[g],g=I[g];x=k[g]&255,y[m++]=x,o<n&&(I[o]=v,k[o]=x,o++,!(o&l)&&o<n&&(h++,l+=o)),v=c}m--,P[D++]=y[m],w++}for(w=D;w<s;w++)P[w]=0;return P};Ee.lzw=bs;Object.defineProperty(j,"__esModule",{value:!0});var Vt=j.decompressFrames=j.decompressFrame=Zt=j.parseGIF=void 0,ks=Bs(Yt),Is=G,Fs=b,Ds=Ae,$s=Ee;function Bs(e){return e&&e.__esModule?e:{default:e}}var zs=function(t){var r=new Uint8Array(t);return(0,Is.parse)((0,Fs.buildStream)(r),ks.default)},Zt=j.parseGIF=zs,Ns=function(t){for(var r=t.pixels.length,a=new Uint8ClampedArray(r*4),n=0;n<r;n++){var i=n*4,s=t.pixels[n],o=t.colorTable[s]||[0,0,0];a[i]=o[0],a[i+1]=o[1],a[i+2]=o[2],a[i+3]=s!==t.transparentIndex?255:0}return a},Kt=function(t,r,a){if(!t.image){console.warn("gif frame does not have associated image.");return}var n=t.image,i=n.descriptor.width*n.descriptor.height,s=(0,$s.lzw)(n.data.minCodeSize,n.data.blocks,i);n.descriptor.lct.interlaced&&(s=(0,Ds.deinterlace)(s,n.descriptor.width));var o={pixels:s,dims:{top:t.image.descriptor.top,left:t.image.descriptor.left,width:t.image.descriptor.width,height:t.image.descriptor.height}};return n.descriptor.lct&&n.descriptor.lct.exists?o.colorTable=n.lct:o.colorTable=r,t.gce&&(o.delay=(t.gce.delay||10)*10,o.disposalType=t.gce.extras.disposal,t.gce.extras.transparentColorGiven&&(o.transparentIndex=t.gce.transparentColorIndex)),a&&(o.patch=Ns(o)),o};j.decompressFrame=Kt;var Ls=function(t,r){return t.frames.filter(function(a){return a.image}).map(function(a){return Kt(a,t.gct,r)})};Vt=j.decompressFrames=Ls;function Us(e){const t=Zt(e),r=Vt(t,!0),a=[];for(let n of r){const{width:i,height:s,left:o,top:u}=n.dims,l=document.createElement("canvas"),h=l.getContext("2d");l.width=i,l.height=s,h.putImageData(new ImageData(n.patch,i,s),o,u),a.push(l)}return a}async function qs(e){const t=new ImageDecoder({data:e,type:"image/gif"});await t.tracks.ready,await t.completed;const r=t.tracks.selectedTrack.frameCount,a=[];for(let n=0;n<r;n++){const i=(await t.decode({frameIndex:n})).image;i.width=i.codedWidth,i.height=i.codedHeight,a.push(fe(i)),i.close()}return a}async function Gs(e){const t=await e.arrayBuffer();return window.ImageDecoder?qs(t):Us(t)}const Ws={frameCount:0,startTime:0};class Xs{constructor(t,r=1){p(this,"blob");p(this,"video");p(this,"length");p(this,"frames");p(this,"initPromise");this.blob=t,this.length=r,this.initPromise=this.init()}setFrameCount(t){return this.length=t,this.initPromise=this.init(),this}async init(){this.frames=[];const t=document.createElement("video");t.src=URL.createObjectURL(this.blob)+"#t=0.0001",await new Promise(n=>t.addEventListener("loadeddata",n));const{startTime:r}=Ws,a=(this.video.duration-r)/this.length;for(let n=0;n<this.length;n++)this.video.currentTime=n*a+r,await new Promise(i=>this.video.oncanplay=i),this.frames[n]=fe(this.video)}async getFrames(){return await this.initPromise,this.frames}}async function Ys(e,t){if(t=t,t<0)throw new Error(`video frame count ${t} must >1`);return new Xs(e,t).getFrames()}var Hs=(e=>(e.FROM="FROM",e.TO="TO",e.GROUP="GROUP",e.BOT="BOT",e.RANDOM="RANDOM",e))(Hs||{}),Vs=(e=>(e.ZOOM="ZOOM",e.DEFORM="DEFORM",e))(Vs||{}),Zs=(e=>(e.NONE="NONE",e.PIXEL="PIXEL",e.PERCENT="PERCENT",e))(Zs||{}),Ks=(e=>(e.CONTAIN="CONTAIN",e.COVER="COVER",e.FILL="FILL",e))(Ks||{}),Qs=(e=>(e.MIRROR="MIRROR",e.FLIP="FLIP",e.GRAY="GRAY",e.BINARIZATION="BINARIZATION",e))(Qs||{});const Js={type:void 0,pos:void 0,posType:"ZOOM",crop:null,cropType:"NONE",style:[],fit:"FILL",round:!1,rotate:!1,avatarOnTop:!0,antialias:!0,resampling:!1,angle:0,opacity:1};function js(e){if(e.compiled)return e;const t={...Js,...e},r=t.pos;let a;switch(t.posType){case"ZOOM":a=typeof r[0]!="object"?[re(r,4)]:r.map(n=>re(n,4)),t.pos=a.map(n=>n.map(i=>typeof i=="number"?i:Y.parse(i)));break;case"DEFORM":try{a=r.map(n=>re(n,5).map(i=>re(i,2)))}catch{a=[re(r,5).map(i=>re(i,2))]}t.pos=a.map(n=>n.map(i=>i.map(s=>typeof s=="number"?s:Y.parse(s))));break}return t.compiled=!0,t}class eo extends vr{constructor(r,a,n){super();p(this,"type");p(this,"template");p(this,"originBlob");p(this,"frames");p(this,"pos");p(this,"initPromise");p(this,"deformer");this.type=r.type;const i=n&&n[this.type.toString().toLowerCase()];if(this.template=js(i?{...r,...i}:r),this.originBlob=a[this.type.toString().toLowerCase()],!this.originBlob)throw new Error(`no ${this.type} image`);this.initPromise=this.init()}async init(){await this.loadFile(),await this.updateTemplate()}async updateTemplate(){await this.setCrop(),await this.setStyle(),await this.setRound(),await this.setPos()}async loadFile(){const r=this.originBlob;if(r.type.startsWith("video/"))this.frames=await Ys(r,this.template.pos.length);else if(!r.type.startsWith("image"))throw new Error("不支持的格式: "+r.type);r.type==="image/gif"?this.frames=await Gs(r):this.frames=[await me(r)]}setCrop(){const r=this.template.cropType;r!=="NONE"&&(this.frames=this.frames.map(a=>pt(a,this.template.crop,r==="PERCENT")))}setStyle(){for(const r of this.template.style)switch(r){case"FLIP":this.frames=this.frames.map(gr);break;case"MIRROR":this.frames=this.frames.map(_i);break;case"GRAY":this.frames=this.frames.map(mr);break;case"BINARIZATION":this.frames=this.frames.map(Ti);break;default:throw new Error("unknown style "+r)}}setRound(){this.template.round&&(this.frames=this.frames.map(Ci))}async setPos(){switch(this.template.posType){case"ZOOM":this.pos=this.template.pos.map(r=>r.map(this.evalExpression));break;case"DEFORM":this.deformer=new wi,this.pos=this.template.pos.map(r=>r.map(a=>a.map(this.evalExpression)));break}}evalExpression(r){return typeof r=="number"?r:r.evaluate({height:this.frames[0].height,width:this.frames[0].width})}getFrame(r){return r<this.frames.length?this.frames[r]:this.frames.at(-1)}getPos(r){return r<this.pos.length?this.pos[r]:this.pos.at(-1)}async getLength(){return await this.initPromise,{posLength:this.pos.length,frameLength:this.frames.length}}async draw(r,a=0){await this.initPromise;let n=this.getFrame(a);const i=this.getPos(a);let{angle:s,opacity:o,rotate:u}=this.template;switch(r.globalAlpha=o,u&&(s+=360/this.pos.length*a),this.template.posType){case"ZOOM":const[l,h,d,c]=i;switch(s&&(r.save(),r.translate(l+d/2,h+c/2),r.rotate(s*Math.PI/180),r.translate(-l-d/2,-h-c/2)),this.template.fit){case"FILL":r.drawImage(n,l,h,d,c);break;default:const v=Math[this.template.fit==="CONTAIN"?"min":"max"](d/n.width,c/n.height),g=n.width*v,w=n.height*v,C=l+(d-g)/2,P=h+(c-w)/2;if(this.template.fit==="CONTAIN")r.drawImage(n,C,P,g,w);else{const I=g-d,k=w-c,y=I/v/2,O=k/v/2;r.drawImage(pt(n,[y,O,n.width-y,n.height-O]),C+I/2,P+k/2,g-I,w-k)}break}r.restore();break;case"DEFORM":this.deformer.draw(r,n,i);break}r.globalAlpha=1}get onTop(){return this.template.avatarOnTop}async getSize(){await this.initPromise;const r=this.frames[0];return{width:r.width,height:r.height}}}class ct{constructor(t){p(this,"arr");p(this,"initPromise");p(this,"topAvatars",[]);p(this,"bottomAvatars",[]);p(this,"sizeMap",Object.create(null));p(this,"maxLength");this.arr=t,this.initPromise=this.init()}async init(){return Promise.all(this.arr.map(async(t,r)=>{t.onTop?this.topAvatars.push(t):this.bottomAvatars.push(t);const a=await t.getSize();this.sizeMap[`avatar${r}Width`]=a.width,this.sizeMap[`avatar${r}Height`]=a.height,this.maxLength=await t.getLength()}))}async getSizeMap(){return await this.initPromise,this.sizeMap}async getMaxLength(){return await this.initPromise,this.maxLength||{posLength:0,frameLength:void 0}}static createFrom(t,r,a){return new ct(t.map(n=>new eo(n,r,a)))}}const to=pr();class Qt{constructor(t,r,a){p(this,"obj");p(this,"container");p(this,"attrMap");if(this.obj=t,this.container=document.createElement(a?"fieldset":"div"),a&&this.container.appendChild(er(a,"legend")),this.container.classList.add("setting-container"),this.attrMap=r??{},this.obj._delete){const n=this.obj._delete;delete this.obj._delete,this.obj.delete=()=>{typeof n=="function"&&n(),this.container.remove()}}for(const[n,i]of Object.entries(this.obj)){if(i==null)continue;const s=this.createElement(n,i);this.container.appendChild(s)}}createElement(t,r){const a=this.attrMap[t]??{};let n=document.createElement("div");const i=document.createElement("label");switch(i.textContent=to[t]??t,n.appendChild(i),a.type){case"font":const o=document.createElement("select");return o.addEventListener("change",()=>this.obj[t]=o.value),document.fonts.forEach(l=>{const h=l.family,d=document.createElement("option");d.style.fontFamily=h,d.value=h,d.textContent=h,d.selected=h===this.obj[t],o.appendChild(d)}),n.appendChild(o),n;case"select":const u=document.createElement("select");return u.addEventListener("change",()=>this.obj[t]=u.value),a.options.forEach(l=>{const h=document.createElement("option");h.value=l,h.textContent=l,h.selected=l===r,u.appendChild(h)}),n.appendChild(u),n}let s=typeof r;switch(s){case"object":n=new Qt(r,a[t],t).render();break;case"function":const o=document.createElement("button");o.textContent=t,o.addEventListener("click",async()=>{o.disabled=!0,o.style.cursor="progress";try{await r()}finally{o.disabled=!1,o.style.cursor="pointer"}}),n.appendChild(o);break;default:const u=document.createElement("input");let l=()=>this.obj[t]=u.value;switch(typeof r){case"number":l=()=>this.obj[t]=parseFloat(u.value);break;case"string":s=/^#([A-Fa-f0-9]{6})$/.test(r)?"color":"text";break;case"boolean":s="checkbox",u.checked=r,l=()=>this.obj[t]=u.checked;break}u.type=s;for(let[h,d]of Object.entries(a))u[h]=d;u.value=r.toString(),u.addEventListener("input",l),n.appendChild(u);break}return n}render(){return this.container}}const ro=6;class ft{constructor(t){p(this,"hasTemplate",!1);p(this,"width");p(this,"height");p(this,"color");p(this,"frames");p(this,"loadingPromise");t&&([this.width,this.height]=t.size.map(r=>typeof r=="number"?r:Y.parse(r)),this.color=Bt(this.color),this.hasTemplate=!0)}setUrl(t,r){this.loadingPromise=ft.fetchImages(t,r).then(a=>this.frames=a)}set images(t){this.frames=t}async generate(t){if(await this.loadingPromise,this.frames)return this.hasTemplate?this.frames.map(r=>{const a=this.getCtx(t);return a.drawImage(r,0,0),a.canvas}):this.frames;if(this.hasTemplate)return[this.getCtx(t).canvas];throw new Error("can not load background")}getCtx(t){const r=document.createElement("canvas"),a=i=>typeof i=="number"?i:i.evaluate(t);r.width=a(this.width),r.height=a(this.height);const n=r.getContext("2d");return n.fillStyle=this.color,n.fillRect(0,0,r.width,r.height),n}static async fetchImages(t,r){if(r!==void 0){if(r<=0)return[];const o=[];for(let u=0;u<r;u++)o.push(fetch(`${t}/${u}.png`).then(l=>l.blob()).then(me));return Promise.all(o)}let a=!1,n=new Set;const i=[];let s=0;for(;!a;){n.size>=ro&&await Promise.race(n);const o=s++,l=fetch(`${t}/${o}.png`).then(h=>h.blob()).then(me).then(h=>{i[o]=h}).catch(()=>a=!0).then(()=>n.delete(l));n.add(l)}return await Promise.all(n),i}}const ao=document.createElement("canvas"),N=ao.getContext("2d");N.textBaseline="alphabetic";N.textAlign="left";const $t={text:"default text",color:"#191919",pos:[50,50],size:16,font:"arial",style:"PLAIN",wrap:"NONE",align:"CENTER",position:["LEFT","TOP"],strokeColor:"#ffffff",strokeSize:0},J=class{constructor(t=$t){p(this,"template");p(this,"fontStyle");p(this,"pixelSize");p(this,"defaultPixelSize");p(this,"width");p(this,"height");p(this,"backgroundSize");p(this,"drawOptions");p(this,"onChangeCallback");p(this,"disabled",!1);this.template={...$t,...t},this.defaultPixelSize=t.size*J.dpiScale,this.pixelSize=this.defaultPixelSize,this.template.color=Bt(this.template.color),this.fontStyle=this.template.style==="PLAIN"?"normal":this.template.style.toLowerCase(),this.template.font=this.template.font.replace(" ","-"),this.template.text=this.template.text.replace(J.TEXT_VAR_REGEX,(r,a)=>a),this.setDrawOptions()}set size(t){this.pixelSize=t*J.dpiScale,this.setDrawOptions()}setDrawOptions(){let{font:t,wrap:r}=this.template;N.font=`${this.fontStyle} ${this.pixelSize}px ${t.replace(" ","-")}`,this.width=0,this.height=0;const a=this.template.text.split(`
`),n=[];let i=0;switch(r){case"NONE":{for(const s of a){const[o,u,l,h]=this.getPosition(N.measureText(s),i++);this.width=Math.max(this.width,l),this.height=h,n.push([s,o,u])}break}case"BREAK":{const s=this.template.pos[2]||J.DEFAULT_MAX_WIDTH;let o,u;for(let l of a)if(o=N.measureText(l),u=o.width,u>s){let h,d,c;for(;u>s;){for(h=0,d=0,c="";d<s;)h++,c=l.substr(0,h),d=N.measureText(l.substr(0,h)).width;h--,c=c.substr(0,h);const v=h;if(l.substr(h,1)!=" "){for(;l.substr(h,1)!=" "&&h!=0;)h--;h==0&&(h=v),c=l.substr(0,h)}l=l.substr(h);const[g,w,C,P]=this.getPosition(N.measureText(c),i++);this.width=Math.max(this.width,C),this.height=P,u=C,n.push([c,g,w])}}else{const[h,d,c,v]=this.getPosition(o,i++);this.width=Math.max(this.width,c),this.height=v,n.push([l,h,d])}break}case"ZOOM":{const s=this.template.pos[2]||J.DEFAULT_MAX_WIDTH;N.font=`${this.fontStyle} ${this.defaultPixelSize}px ${t}`;let o=Math.max(...a.map(h=>N.measureText(h).width));const l=s/(o||1)*this.defaultPixelSize;this.pixelSize=l,N.font=`${this.fontStyle} ${l}px ${t}`;for(const h of a){const[d,c,v,g]=this.getPosition(N.measureText(h),i++);this.width=Math.max(this.width,v),this.height=g,n.push([h,d,c])}break}}return this.drawOptions=n,n}getPosition(t,r){const[a,n]=this.template.pos,i=t.width,s=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent,o=s*r,u=s*(r+1);switch(this.template.align){case"LEFT":return[a,n+o,i,u];case"RIGHT":return[a-i,n+o,i,u];case"CENTER":return[a-i/2,n+o,i,u]}}get hidden(){return this.disabled}set hidden(t){this.disabled=t,this.onChangeCallback&&this.onChangeCallback(this)}get size(){return this.template.size}draw(t){if(this.disabled)return;let{color:r,align:a,font:n,strokeColor:i,strokeSize:s}=this.template;t.font=`${this.fontStyle} ${this.pixelSize}px ${n}`,t.fillStyle=r,t.textBaseline=a==="CENTER"?"middle":"alphabetic";for(let o of this.drawOptions)t.fillText(...o);if(i&&s){t.strokeStyle=i,t.lineWidth=s;for(let o of this.drawOptions)t.strokeText(...o)}}get settingObject(){const t=this;return new Proxy({get x(){return t.template.pos[0]},set x(r){t.template.pos[0]=r},get y(){return t.template.pos[1]},set y(r){t.template.pos[1]=r},text:t.template.text,color:t.template.color,get size(){return t.template.wrap==="ZOOM"?void 0:t.pixelSize},set size(r){t.pixelSize=r},font:t.template.font,set fontStyle(r){t.fontStyle=r},get fontStyle(){return t.fontStyle},strokeSize:t.template.strokeSize,strokeColor:t.template.strokeColor,get hidden(){return t.disabled},set hidden(r){t.hidden=r},_delete:()=>t.hidden=!0},{set:(r,a,n)=>(r[a]=n,t.template[a]=n,t.disabled||(this.setDrawOptions(),t.onChangeCallback&&t.onChangeCallback(this)),!0)})}get settingAttributes(){const t={type:"range",min:0,step:1};return{x:{...t,max:this.backgroundSize?this.backgroundSize[0]:1e3},y:{...t,max:this.backgroundSize?this.backgroundSize[1]:1e3},size:{...t,max:256},fontStyle:{type:"select",options:["normal","bold","italic","bold italic"]},strokeSize:{...t,max:16},font:{type:"font"}}}set onchange(t){this.onChangeCallback=t}};let Q=J;p(Q,"TEXT_VAR_REGEX",/\$txt\d+\[(.*?)]/g),p(Q,"DEFAULT_MAX_WIDTH",300),p(Q,"dpiScale",(window.devicePixelRatio||1)*96/72);class dt{constructor(t){p(this,"arr");p(this,"cacheCtx");p(this,"topAvatars",[]);p(this,"bottomAvatars",[]);p(this,"sizeMap",Object.create(null));p(this,"needUpdate",!1);p(this,"cacheCount",0);if(this.arr=t,!(t!=null&&t.length))return;let r=0;for(const a of t)a.onchange=()=>this.needUpdate=!0,this.sizeMap[`text${r}Width`]=a.width,this.sizeMap[`text${r}Height`]=a.height,r++}draw(t){for(const r of this.arr)r.draw(t)}setCacheArea(t,r){for(const n of this.arr)n.backgroundSize=[t,r];const a=document.createElement("canvas");a.width=t,a.height=r,this.cacheCtx=a.getContext("2d"),this.drawCache()}drawCache(){this.draw(this.cacheCtx)}updateCache(){this.cacheCtx.clearRect(0,0,this.cacheCtx.canvas.width,this.cacheCtx.canvas.height),this.drawCache(),this.needUpdate=!1,this.cacheCount++}get cacheCanvas(){return this.needUpdate&&this.updateCache(),this.cacheCtx.canvas}addTextModel(){const t=new Q;return this.arr.push(t),this.needUpdate=!0,t.onchange=()=>this.needUpdate=!0,t.backgroundSize=[this.cacheCtx.canvas.width,this.cacheCtx.canvas.height],t}get texts(){return this.arr}static createFrom(t){return new dt(t.map(r=>new Q(r)))}}var no=(e=>(e.IMG="IMG",e.GIF="GIF",e))(no||{});const io={type:void 0,avatar:[],text:[],background:void 0,delay:65,alias:[],inRandomList:!0,reverse:!1,hidden:!1};class po{constructor(t,r){p(this,"type");p(this,"template");p(this,"initPromise");p(this,"avatarList");p(this,"backgroundModel");p(this,"textModelList");p(this,"backgroundLength");this.template={...io,...t},this.type=t.type,this.textModelList=dt.createFrom(this.template.text),this.backgroundModel=new ft(this.template.background),r&&(this.background=r),this.initPromise=this.init()}set background(t){if(typeof t=="string")this.backgroundModel.setUrl(t,this.backgroundLength);else if(Array.isArray(t))this.backgroundModel.images=t;else throw new Error("unknown background",t)}async init(){}async generate(t,r){const a=ct.createFrom(this.template.avatar,t,r),n=await a.getSizeMap(),i=await this.backgroundModel.generate(n);return new so(this.template,i,a,this.textModelList)}}class so{constructor(t,r,a,n){p(this,"template");p(this,"canvas");p(this,"ctx");p(this,"backgrounds");p(this,"avatars");p(this,"texts");p(this,"length");p(this,"intervalId");p(this,"initPromise");p(this,"userDelay");p(this,"i",0);p(this,"framesCache",[]);p(this,"resolveFramesCachedPromise");p(this,"framesCachedPromise",new Promise(t=>this.resolveFramesCachedPromise=t));p(this,"prevTextCacheCount");p(this,"prevTextedFramesCache");const i=document.createElement("canvas");this.canvas=i,i.width=r[0].width,i.height=r[0].height,this.ctx=i.getContext("2d"),this.template=t,this.backgrounds=r,this.avatars=a,this.texts=n,this.texts.setCacheArea(i.width,i.height),this.initPromise=this.init()}async init(){const{posLength:t,frameLength:r=this.backgrounds.length}=await this.avatars.getMaxLength();this.length=this.template.type==="IMG"?r:this.backgrounds.length}async replay(){return this.i=0,await this.play(),new Promise(t=>setTimeout(t,this.delay*this.length))}async play(){if(await this.stop(),this.template.reverse)return this.playReverse();this.intervalId=window.setInterval(async()=>{await this.drawAvatarsCache(this.i++%this.length),this.drawTextsCache()},Math.abs(this.delay))}playReverse(){this.intervalId=window.setInterval(async()=>{await this.drawAvatarsCache(this.length-1-this.i++%this.length),this.drawTextsCache()},Math.abs(this.delay))}async stop(){await this.initPromise,clearInterval(this.intervalId)}set delay(t){if(!t){this.stop();return}this.userDelay=t,t>0?this.play():this.stop().then(()=>this.playReverse())}get delay(){return this.userDelay||this.template.delay}getBackground(t){return t<this.backgrounds.length?this.backgrounds[t]:this.backgrounds.at(-1)}async getFrames(){return await this.framesCachedPromise,this.framesCache}async getTextedFrames(){const t=await this.getFrames();return this.texts.texts.length===0?t:this.prevTextCacheCount===this.texts.cacheCount?this.prevTextedFramesCache:(this.prevTextedFramesCache=t.map(r=>{const a=fe(r);return a.getContext("2d").drawImage(this.texts.cacheCanvas,0,0),a}),this.prevTextCacheCount=this.texts.cacheCount,this.prevTextedFramesCache)}drawTextsCache(){this.ctx.drawImage(this.texts.cacheCanvas,0,0)}drawTexts(){this.texts.draw(this.ctx)}async drawAvatarsCache(t){if(this.framesCache[t]){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.framesCache[t],0,0);return}await this.drawAvatars(t),this.framesCache[t]=fe(this.canvas,!0),this.framesCache.length===this.length&&this.resolveFramesCachedPromise()}async drawAvatars(t){await this.initPromise,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const r of this.avatars.bottomAvatars)await r.draw(this.ctx,t);this.ctx.drawImage(this.getBackground(t),0,0);for(const r of this.avatars.topAvatars)await r.draw(this.ctx,t)}get settingObject(){const t=this;return this.length===1?{}:{set delay(r){t.delay=r},get delay(){return t.delay},play:()=>this.play(),stop:()=>this.stop()}}async destroy(){await this.stop(),this.canvas.remove()}}export{Hs as A,no as P,Qt as S,fo as a,Js as b,er as c,Gs as d,Ks as e,Vs as f,uo as g,Qs as h,io as i,ho as j,co as k,po as l,pr as m,me as n,Zs as o,cr as p};
