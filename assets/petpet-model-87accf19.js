var Jt=Object.defineProperty;var jt=(e,t,r)=>t in e?Jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var p=(e,t,r)=>(jt(e,typeof t!="symbol"?t+"":t,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function r(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(i){if(i.ep)return;i.ep=!0;const n=r(i);fetch(i.href,n)}})();function er(e,t="h3"){const r=document.createElement(t);return r.textContent=e,r}const tr={selectTemplate:"Select template",uploadAvatar:"Upload avatar",setText:"Set text",result:"Result",typeToSearch:"Type to search",cancel:"Cancel",save:"Save",add:"Add",x:"X",y:"Y",text:"Text",color:"Color",size:"Size",font:"Font",strokeSize:"Stroke Size",strokeColor:"Stroke Color",hidden:"Hidden",delete:"Delete",delay:"Delay",play:"Play",stop:"Stop",workers:"Workers",quality:"Quality",background:"Background",dither:"Dither",download:"Download",copy:"Copy",share:"Share",notSelected:"Not Selected",noAvatar:"No Avatar",rightClickOrLongPress:"Right Click or Long Press"},rr={selectTemplate:"選擇模板",uploadAvatar:"上傳頭像",setText:"設置文字",result:"結果",typeToSearch:"檢索文字",cancel:"取消",save:"保存",add:"添加",x:"X",y:"Y",text:"文字",color:"顏色",size:"大小",font:"字型",strokeSize:"描邊大小",strokeColor:"描邊顏色",hidden:"隱藏",delete:"刪除",delay:"延遲",play:"播放",stop:"停止",workers:"線程數",quality:"質量",background:"背景",dither:"抖動",download:"下載",copy:"複製",share:"分享",notSelected:"未選擇",noAvatar:"無頭像",rightClickOrLongPress:"右鍵或長按"},ar={selectTemplate:"选择模板",uploadAvatar:"上传头像",setText:"设置文字",result:"结果",typeToSearch:"搜索文字",cancel:"取消",save:"保存",add:"添加",x:"X",y:"Y",text:"文字",color:"颜色",size:"大小",font:"字体",strokeSize:"描边大小",strokeColor:"描边颜色",hidden:"隐藏",delete:"删除",delay:"延迟",play:"播放",stop:"停止",workers:"线程数",quality:"质量",background:"背景",dither:"抖动",download:"下载",copy:"复制",share:"分享",notSelected:"未选择",noAvatar:"无头像",rightClickOrLongPress:"右键或长按"},ir={selectTemplate:"Template auswählen",uploadAvatar:"Avatar hochladen",setText:"Text setzen",result:"Ergebnis",typeToSearch:"Suche",cancel:"Abbrechen",save:"Speichern",add:"Hinzufügen",x:"X",y:"Y",text:"Text",color:"Farbe",size:"Größe",font:"Schriftart",strokeSize:"Konturgröße",strokeColor:"Konturfarbe",hidden:"Verstecken",delete:"Löschen",delay:"Verzögerung",play:"Abspielen",stop:"Stoppen",workers:"Anzahl der Threads",quality:"Qualität",background:"Hintergrund",dither:"Dither",download:"Download",copy:"Kopieren",share:"Teilen",notSelected:"Nicht ausgewählt",noAvatar:"Keine Avatar",rightClickOrLongPress:"Rechtsklick oder Doppelklick"},nr={selectTemplate:"テンプレートを選択",uploadAvatar:"アバターをアップロード",setText:"テキストを設定",result:"結果",typeToSearch:"検索",cancel:"キャンセル",save:"保存",add:"追加",x:"X",y:"Y",text:"テキスト",color:"色",size:"サイズ",font:"フォント",strokeSize:"線の太さ",strokeColor:"線の色",hidden:"隠す",delete:"削除",delay:"遅延",play:"再生",stop:"停止",workers:"線程数",quality:"質量",background:"背景色",dither:"抖動",download:"ダウンロード",copy:"コピー",share:"シェア",notSelected:"未選択",noAvatar:"アバターなし",rightClickOrLongPress:"右クリックまたは長押し"},sr={selectTemplate:"템플릿 선택",uploadAvatar:"아바타 업로드",setText:"텍스트 설정",result:"결과",typeToSearch:"검색",cancel:"취소",save:"저장",add:"추가",x:"X",y:"Y",text:"텍스트",color:"색",size:"크기",font:"글꼴",strokeSize:"선 굵기",strokeColor:"선 색상",hidden:"숨김",delete:"삭제",delay:"연속",play:"재생",stop:"중지",workers:"쓰레드 수",quality:"질량",background:"배경색",dither:"쓰레드",download:"다운로드",copy:"복사",share:"공유",notSelected:"선택되지 않음",noAvatar:"아바타 없음",rightClickOrLongPress:"마우스 오른쪽클릭"},or={selectTemplate:"Выберите шаблон",uploadAvatar:"Загрузить аватар",setText:"Установить текст",result:"Результат",typeToSearch:"Поиск",cancel:"Отмена",save:"Сохранить",add:"Добавить",x:"X",y:"Y",text:"Текст",color:"Цвет",size:"Размер",font:"Шрифт",strokeSize:"Толщина обводки",strokeColor:"Цвет обводки",hidden:"Скрыть",delete:"Удалить",delay:"Задержка",play:"Воспроизведение",stop:"Остановить",workers:"Количество нитей",quality:"Качество",background:"Фон",dither:"Контроль",download:"Скачать",copy:"Копировать",share:"Поделиться",notSelected:"Не выбрано",noAvatar:"Нет аватара",rightClickOrLongPress:"Кликните или перетащите мышкой"},lr={selectTemplate:"Sélectionnez un modèle",uploadAvatar:"Télécharger avatar",setText:"Définir le texte",result:"Résultat",typeToSearch:"Rechercher",cancel:"Annuler",save:"Enregistrer",add:"Ajouter",x:"X",y:"Y",text:"Texte",color:"Couleur",size:"Taille",font:"Police",strokeSize:"Taille du contour",strokeColor:"Couleur du contour",hidden:"Cacher",delete:"Supprimer",delay:"Délai",play:"Lecture",stop:"Arrêter",workers:"Nombre de nœuds",quality:"Qualité",background:"Fond",dither:"Dither",download:"Télécharger",copy:"Copier",share:"Partager",notSelected:"Non sélectionné",noAvatar:"Aucun avatar",rightClickOrLongPress:"Cliquer ou longue-cliquer pour sélectionner"},ur=[{id:"zh-CN",text:"简体中文",alias:["zh"]},{id:"zh-TW",text:"繁體中文",alias:["zh-HK","zh-SG"]},{id:"en-US",text:"English",alias:["en","en-EG","en-AU","en-GB","en-CA","en-NZ","en-IE","en-ZA","en-JM","en-BZ","en-TT"]},{id:"ru",text:"русский язык",alias:["ru-RU"]},{id:"de",text:"Deutsch",alias:["de-CH","de-AT","de-LU","de-LI"]},{id:"es",text:"español",alias:["es-AR","es-GT","es-CR","es-PA","es-DO","es-MX","es-VE","es-CO","es-PE","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"]},{id:"fr",text:"Français",alias:["fr-BE","fr-CA","fr-CH","fr-LU"]},{id:"ja",text:"日本語",alias:["ja-JP"]},{id:"ko",text:"한국어",alias:["ko-KR"]}];let Me;function hr(){if(Me)return Me;const e=navigator.language;let t="en-US";for(const r of ur){if(e===r.id){t=r.id;break}r.alias.forEach(a=>{a===e&&(t=r.id)})}return t=t.replace("-","_"),Me=dt[t],dt[t]}const dt={en_US:tr,zh_TW:rr,zh_CN:ar,de:ir,fr:lr,ja:nr,ko:sr,ru:or};class cr{static from(){throw new Error}}function re(e,t){if(e.length!==t)throw new Error("array.length != "+t);return e}function fe(e,t=!1){const r=document.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:t});return r.width=e.width,r.height=e.height,a.drawImage(e,0,0),r}async function no(e){const t=await me(e);return fe(t)}async function me(e){return new Promise((t,r)=>{const a=new Image;a.onload=()=>t(a),a.onerror=i=>r(i),a.src=URL.createObjectURL(e)})}function Bt(e="#ffffff00"){if(typeof e=="string")return e.startsWith("#")?e:e.length<<2?"#"+e:e;if(e.length&&e.length>=3&&e.length<=4){const[t,r,a,i=1]=e;return`rgba(${t}, ${r}, ${a}, ${i})`}throw new Error("cannot load color "+e)}function pt(e,t,r=!1){const a=document.createElement("canvas"),i=a.getContext("2d"),[n,s,o,l]=t.length===2?[0,0,t[0],t[1]]:t;let u=r?(o-n)/100*e.width:o-n,c=r?(l-s)/100*e.height:l-s;return a.width=r?u/100*e.width:u,a.height=r?c/100*e.height:c,i.drawImage(e,n,s,u,c,0,0,u,c),a}function fr(e){const t=document.createElement("canvas"),r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.translate(0,e.height),r.scale(1,-1),r.drawImage(e,0,0),t}function dr(e){const t=document.createElement("canvas"),r=t.getContext("2d");t.width=e.width,t.height=e.height,r.drawImage(e,0,0);const a=r.getImageData(0,0,t.width,t.height),i=a.data;for(let n=0;n<i.length;n+=4){const s=i[n],o=i[n+1],l=i[n+2],u=(s+o+l)/3;i[n]=u,i[n+1]=u,i[n+2]=u}return r.putImageData(a,0,0),t}var so=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function oo(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function lo(e){if(e.__esModule)return e;var t=e.default;if(typeof t=="function"){var r=function a(){if(this instanceof a){var i=[null];i.push.apply(i,arguments);var n=Function.bind.apply(t,i);return new n}return t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(a){var i=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(r,a,i.get?i:{enumerable:!0,get:function(){return e[a]}})}),r}var zt={},E={},Ie={};Object.defineProperty(Ie,"__esModule",{value:!0});var pr=function(){function e(t,r){for(var a=0;a<r.length;a++){var i=r[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}();function vr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var gr=function(){function e(t){vr(this,e);var r=t.length;this.xa=[],this.ya=[],this.u=[],this.y2=[],t.sort(function(l,u){return l[0]-u[0]});for(var a=0;a<r;a++)this.xa.push(t[a][0]),this.ya.push(t[a][1]);this.u[0]=0,this.y2[0]=0;for(var a=1;a<r-1;++a){var i=this.xa[a+1]-this.xa[a-1],n=(this.xa[a]-this.xa[a-1])/i,s=n*this.y2[a-1]+2;this.y2[a]=(n-1)/s;var o=(this.ya[a+1]-this.ya[a])/(this.xa[a+1]-this.xa[a])-(this.ya[a]-this.ya[a-1])/(this.xa[a]-this.xa[a-1]);this.u[a]=(6*o/i-n*this.u[a-1])/s}this.y2[r-1]=0;for(var a=r-2;a>=0;--a)this.y2[a]=this.y2[a]*this.y2[a+1]+this.u[a]}return pr(e,[{key:"interpolate",value:function(r){for(var a=this.ya.length,i=0,n=a-1;n-i>1;){var s=n+i>>1;this.xa[s]>r?n=s:i=s}var o=this.xa[n]-this.xa[i],l=(this.xa[n]-r)/o,u=(r-this.xa[i])/o;return l*this.ya[i]+u*this.ya[n]+((l*l*l-l)*this.y2[i]+(u*u*u-u)*this.y2[n])*(o*o)/6}}]),e}();Ie.default=gr;Object.defineProperty(E,"__esModule",{value:!0});E.simpleShader=wr;E.clamp=Lt;E.splineInterpolate=_r;var mr=Ie,xr=yr(mr);function yr(e){return e&&e.__esModule?e:{default:e}}function wr(e,t,r,a){(r||this._.texture).use(),this._.spareTexture.drawTo(function(){e.uniforms(t).drawRect()}),this._.spareTexture.swapWith(a||this._.texture)}function Lt(e,t,r){return Math.max(e,Math.min(t,r))}function _r(e){for(var t=new xr.default(e),r=[],a=0;a<256;a++)r.push(Lt(0,Math.floor(t.interpolate(a/255)*256),255));return r}var T={};Object.defineProperty(T,"__esModule",{value:!0});T.set=Tr;T.get=Cr;var Re={};function Tr(e){Re=Object.assign(Re,e)}function Cr(e){return Re[e]}var $e={},S={};Object.defineProperty(S,"__esModule",{value:!0});var vt=function(){function e(t,r){for(var a=0;a<r.length;a++){var i=r[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),Er=T,Z=Ar(Er);function Ar(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Mr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Sr="attribute vec2 vertex;attribute vec2 _texCoord;varying vec2 texCoord;void main() {  texCoord = _texCoord;  gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);}",Pr="uniform sampler2D texture;varying vec2 texCoord;void main() {  gl_FragColor = texture2D(texture, texCoord);}",br=function(){vt(e,null,[{key:"getDefaultShader",value:function(){var r=Z.get("gl");return r.defaultShader=r.defaultShader||new e,r.defaultShader}}]);function e(t,r){Mr(this,e);var a=Z.get("gl");if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=a.createProgram(),t=t||Sr,r=r||Pr,r="precision highp float;"+r,a.attachShader(this.program,gt(a.VERTEX_SHADER,t)),a.attachShader(this.program,gt(a.FRAGMENT_SHADER,r)),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program)}return vt(e,[{key:"destroy",value:function(){var r=Z.get("gl");r.deleteProgram(this.program),this.program=null}},{key:"uniforms",value:function(r){var a=Z.get("gl");a.useProgram(this.program);for(var i in r)if(r.hasOwnProperty(i)){var n=a.getUniformLocation(this.program,i);if(n!==null){var s=r[i];if(Or(s))switch(s.length){case 1:a.uniform1fv(n,new Float32Array(s));break;case 2:a.uniform2fv(n,new Float32Array(s));break;case 3:a.uniform3fv(n,new Float32Array(s));break;case 4:a.uniform4fv(n,new Float32Array(s));break;case 9:a.uniformMatrix3fv(n,!1,new Float32Array(s));break;case 16:a.uniformMatrix4fv(n,!1,new Float32Array(s));break;default:throw`dont't know how to load uniform "`+i+'" of length '+s.length}else if(Rr(s))a.uniform1f(n,s);else throw'attempted to set uniform "'+i+'" to invalid value '+(s||"undefined").toString()}}return this}},{key:"textures",value:function(r){var a=Z.get("gl");a.useProgram(this.program);for(var i in r)r.hasOwnProperty(i)&&a.uniform1i(a.getUniformLocation(this.program,i),r[i]);return this}},{key:"drawRect",value:function(r,a,i,n){var s=Z.get("gl"),o=s.getParameter(s.VIEWPORT);a=a!==void 0?(a-o[1])/o[3]:0,r=r!==void 0?(r-o[0])/o[2]:0,i=i!==void 0?(i-o[0])/o[2]:1,n=n!==void 0?(n-o[1])/o[3]:1,s.vertexBuffer==null&&(s.vertexBuffer=s.createBuffer()),s.bindBuffer(s.ARRAY_BUFFER,s.vertexBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([r,a,r,n,i,a,i,n]),s.STATIC_DRAW),s.texCoordBuffer==null&&(s.texCoordBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,s.texCoordBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),s.STATIC_DRAW)),this.vertexAttribute==null&&(this.vertexAttribute=s.getAttribLocation(this.program,"vertex"),s.enableVertexAttribArray(this.vertexAttribute)),this.texCoordAttribute==null&&(this.texCoordAttribute=s.getAttribLocation(this.program,"_texCoord"),s.enableVertexAttribArray(this.texCoordAttribute)),s.useProgram(this.program),s.bindBuffer(s.ARRAY_BUFFER,s.vertexBuffer),s.vertexAttribPointer(this.vertexAttribute,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,s.texCoordBuffer),s.vertexAttribPointer(this.texCoordAttribute,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4)}}]),e}();S.default=br;function Or(e){return Object.prototype.toString.call(e)=="[object Array]"}function Rr(e){return Object.prototype.toString.call(e)=="[object Number]"}function gt(e,t){var r=Z.get("gl"),a=r.createShader(e);if(r.shaderSource(a,t),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS))throw"compile error: "+r.getShaderInfoLog(a);return a}Object.defineProperty($e,"__esModule",{value:!0});var mt=function(){function e(t,r){for(var a=0;a<r.length;a++){var i=r[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),kr=T,z=Fr(kr),Ir=S,$r=Dr(Ir);function Dr(e){return e&&e.__esModule?e:{default:e}}function Fr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Br(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var q=null,zr=function(){mt(e,null,[{key:"fromElement",value:function(r){var a=z.get("gl"),i=new e(0,0,a.RGBA,a.UNSIGNED_BYTE);return i.loadContentsOf(r),i}}]);function e(t,r,a,i){Br(this,e);var n=z.get("gl");this.gl=n,this.id=n.createTexture(),this.width=t,this.height=r,this.format=a,this.type=i,n.bindTexture(n.TEXTURE_2D,this.id),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),t&&r&&n.texImage2D(n.TEXTURE_2D,0,this.format,t,r,0,this.format,this.type,null)}return mt(e,[{key:"loadContentsOf",value:function(r){var a=z.get("gl");this.width=r.width||r.videoWidth,this.height=r.height||r.videoHeight,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,this.format,this.format,this.type,r)}},{key:"initFromBytes",value:function(r,a,i){var n=z.get("gl");this.width=r,this.height=a,this.format=n.RGBA,this.type=n.UNSIGNED_BYTE,n.bindTexture(n.TEXTURE_2D,this.id),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,r,a,0,n.RGBA,this.type,new Uint8Array(i))}},{key:"destroy",value:function(){var r=z.get("gl");r.deleteTexture(this.id),this.id=null}},{key:"use",value:function(r){var a=z.get("gl");a.activeTexture(a.TEXTURE0+(r||0)),a.bindTexture(a.TEXTURE_2D,this.id)}},{key:"unuse",value:function(r){var a=z.get("gl");a.activeTexture(a.TEXTURE0+(r||0)),a.bindTexture(a.TEXTURE_2D,null)}},{key:"ensureFormat",value:function(r,a,i,n){if(arguments.length==1){var s=arguments[0];r=s.width,a=s.height,i=s.format,n=s.type}if(r!=this.width||a!=this.height||i!=this.format||n!=this.type){var o=z.get("gl");this.width=r,this.height=a,this.format=i,this.type=n,o.bindTexture(o.TEXTURE_2D,this.id),o.texImage2D(o.TEXTURE_2D,0,this.format,r,a,0,this.format,this.type,null)}}},{key:"drawTo",value:function(r){var a=z.get("gl");if(a.framebuffer=a.framebuffer||a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,a.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.id,0),a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");a.viewport(0,0,this.width,this.height),r(),a.bindFramebuffer(a.FRAMEBUFFER,null)}},{key:"fillUsingCanvas",value:function(r){r(xt(this));var a=z.get("gl");return this.format=a.RGBA,this.type=a.UNSIGNED_BYTE,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,q),this}},{key:"toImage",value:function(r){this.use(),$r.default.getDefaultShader().drawRect();var a=z.get("gl"),i=this.width*this.height*4,n=new Uint8Array(i),s=xt(this),o=s.createImageData(this.width,this.height);a.readPixels(0,0,this.width,this.height,a.RGBA,a.UNSIGNED_BYTE,n);for(var l=0;l<i;l++)o.data[l]=n[l];s.putImageData(o,0,0),r.src=q.toDataURL()}},{key:"swapWith",value:function(r){var a;a=r.id,r.id=this.id,this.id=a,a=r.width,r.width=this.width,this.width=a,a=r.height,r.height=this.height,this.height=a,a=r.format,r.format=this.format,this.format=a}}]),e}();$e.default=zr;function xt(e){q==null&&(q=document.createElement("canvas")),q.width=e.width,q.height=e.height;var t=q.getContext("2d");return t.clearRect(0,0,q.width,q.height),t}var Nt={},De={};Object.defineProperty(De,"__esModule",{value:!0});De.default=function(e,t){var r=qr.get("gl");return r.brightnessContrast=r.brightnessContrast||new Nr.default(null,"    uniform sampler2D texture;    uniform float brightness;    uniform float contrast;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color.rgb += brightness;      if (contrast > 0.0) {        color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;      } else {        color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;      }      gl_FragColor = color;    }  "),Se.simpleShader.call(this,r.brightnessContrast,{brightness:(0,Se.clamp)(-1,e,1),contrast:(0,Se.clamp)(-1,t,1)}),this};var Lr=S,Nr=Gr(Lr),Se=E,Ur=T,qr=Wr(Ur);function Wr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Gr(e){return e&&e.__esModule?e:{default:e}}var Fe={};Object.defineProperty(Fe,"__esModule",{value:!0});Fe.default=function(e,t,r){var a=Vr.get("gl");e=(0,pe.splineInterpolate)(e),arguments.length==1?t=r=e:(t=(0,pe.splineInterpolate)(t),r=(0,pe.splineInterpolate)(r));for(var i=[],n=0;n<256;n++)i.splice(i.length,0,e[n],t[n],r[n],255);return this._.extraTexture.initFromBytes(256,1,i),this._.extraTexture.use(1),a.curves=a.curves||new Hr.default(null,"    uniform sampler2D texture;    uniform sampler2D map;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color.r = texture2D(map, vec2(color.r)).r;      color.g = texture2D(map, vec2(color.g)).g;      color.b = texture2D(map, vec2(color.b)).b;      gl_FragColor = color;    }  "),a.curves.textures({map:1}),pe.simpleShader.call(this,a.curves,{}),this};var Xr=S,Hr=Kr(Xr),pe=E,Yr=T,Vr=Zr(Yr);function Zr(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Kr(e){return e&&e.__esModule?e:{default:e}}var Be={};Object.defineProperty(Be,"__esModule",{value:!0});Be.default=function(e){var t=ta.get("gl");t.denoise=t.denoise||new Jr.default(null,"    uniform sampler2D texture;    uniform float exponent;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec4 center = texture2D(texture, texCoord);      vec4 color = vec4(0.0);      float total = 0.0;      for (float x = -4.0; x <= 4.0; x += 1.0) {        for (float y = -4.0; y <= 4.0; y += 1.0) {          vec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);          float weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));          weight = pow(weight, exponent);          color += sample * weight;          total += weight;        }      }      gl_FragColor = color / total;    }  ");for(var r=0;r<2;r++)jr.simpleShader.call(this,t.denoise,{exponent:Math.max(0,e),texSize:[this.width,this.height]});return this};var Qr=S,Jr=aa(Qr),jr=E,ea=T,ta=ra(ea);function ra(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function aa(e){return e&&e.__esModule?e:{default:e}}var ze={};Object.defineProperty(ze,"__esModule",{value:!0});ze.default=function(e,t){var r=oa.get("gl");return r.hueSaturation=r.hueSaturation||new na.default(null,"    uniform sampler2D texture;    uniform float hue;    uniform float saturation;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);            /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */      float angle = hue * 3.14159265;      float s = sin(angle), c = cos(angle);      vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;      float len = length(color.rgb);      color.rgb = vec3(        dot(color.rgb, weights.xyz),        dot(color.rgb, weights.zxy),        dot(color.rgb, weights.yzx)      );            /* saturation adjustment */      float average = (color.r + color.g + color.b) / 3.0;      if (saturation > 0.0) {        color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));      } else {        color.rgb += (average - color.rgb) * (-saturation);      }            gl_FragColor = color;    }  "),Pe.simpleShader.call(this,r.hueSaturation,{hue:(0,Pe.clamp)(-1,e,1),saturation:(0,Pe.clamp)(-1,t,1)}),this};var ia=S,na=ua(ia),Pe=E,sa=T,oa=la(sa);function la(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ua(e){return e&&e.__esModule?e:{default:e}}var Le={};Object.defineProperty(Le,"__esModule",{value:!0});Le.default=function(e){var t=da.get("gl");return t.noise=t.noise||new ca.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    float rand(vec2 co) {      return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);    }    void main() {      vec4 color = texture2D(texture, texCoord);            float diff = (rand(texCoord) - 0.5) * amount;      color.r += diff;      color.g += diff;      color.b += diff;            gl_FragColor = color;    }  "),yt.simpleShader.call(this,t.noise,{amount:(0,yt.clamp)(0,e,1)}),this};var ha=S,ca=va(ha),yt=E,fa=T,da=pa(fa);function pa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function va(e){return e&&e.__esModule?e:{default:e}}var Ne={};Object.defineProperty(Ne,"__esModule",{value:!0});Ne.default=function(e){var t=ya.get("gl");return t.sepia=t.sepia||new ma.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      float r = color.r;      float g = color.g;      float b = color.b;            color.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));      color.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));      color.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));            gl_FragColor = color;    }  "),wt.simpleShader.call(this,t.sepia,{amount:(0,wt.clamp)(0,e,1)}),this};var ga=S,ma=_a(ga),wt=E,xa=T,ya=wa(xa);function wa(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function _a(e){return e&&e.__esModule?e:{default:e}}var Ue={};Object.defineProperty(Ue,"__esModule",{value:!0});Ue.default=function(e,t){var r=Aa.get("gl");return r.unsharpMask=r.unsharpMask||new _t.default(null,"    uniform sampler2D blurredTexture;    uniform sampler2D originalTexture;    uniform float strength;    uniform float threshold;    varying vec2 texCoord;    void main() {      vec4 blurred = texture2D(blurredTexture, texCoord);      vec4 original = texture2D(originalTexture, texCoord);      gl_FragColor = mix(blurred, original, 1.0 + strength);    }  "),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo(function(){_t.default.getDefaultShader().drawRect()}),this._.extraTexture.use(1),this.triangleBlur(e),r.unsharpMask.textures({originalTexture:1}),Ca.simpleShader.call(this,r.unsharpMask,{strength:t}),this._.extraTexture.unuse(1),this};var Ta=S,_t=Sa(Ta),Ca=E,Ea=T,Aa=Ma(Ea);function Ma(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Sa(e){return e&&e.__esModule?e:{default:e}}var qe={};Object.defineProperty(qe,"__esModule",{value:!0});qe.default=function(e){var t=Ra.get("gl");return t.vibrance=t.vibrance||new ba.default(null,"    uniform sampler2D texture;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      float average = (color.r + color.g + color.b) / 3.0;      float mx = max(color.r, max(color.g, color.b));      float amt = (mx - average) * (-amount * 3.0);      color.rgb = mix(color.rgb, vec3(mx), amt);      gl_FragColor = color;    }  "),Tt.simpleShader.call(this,t.vibrance,{amount:(0,Tt.clamp)(-1,e,1)}),this};var Pa=S,ba=Ia(Pa),Tt=E,Oa=T,Ra=ka(Oa);function ka(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ia(e){return e&&e.__esModule?e:{default:e}}var We={};Object.defineProperty(We,"__esModule",{value:!0});We.default=function(e,t){var r=Ba.get("gl");return r.vignette=r.vignette||new Da.default(null,"    uniform sampler2D texture;    uniform float size;    uniform float amount;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);            float dist = distance(texCoord, vec2(0.5, 0.5));      color.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));            gl_FragColor = color;    }  "),be.simpleShader.call(this,r.vignette,{size:(0,be.clamp)(0,e,1),amount:(0,be.clamp)(0,t,1)}),this};var $a=S,Da=La($a),be=E,Fa=T,Ba=za(Fa);function za(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function La(e){return e&&e.__esModule?e:{default:e}}var Ge={},B={};Object.defineProperty(B,"__esModule",{value:!0});B.randomShaderFunc=void 0;B.warpShader=Wa;var Na=S,Ua=qa(Na);function qa(e){return e&&e.__esModule?e:{default:e}}function Wa(e,t){return new Ua.default(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 coord = texCoord * texSize;      "+t+"      gl_FragColor = texture2D(texture, coord / texSize);      vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);      if (coord != clampedCoord) {        /* fade to transparent if we are outside the image */        gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));      }    }")}B.randomShaderFunc="  float random(vec3 scale, float seed) {    /* use the fragment position for a different seed per-pixel */    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);  }";Object.defineProperty(Ge,"__esModule",{value:!0});Ge.default=function(e,t,r){var a=Ya.get("gl");a.lensBlurPrePass=a.lensBlurPrePass||new ve.default(null,"    uniform sampler2D texture;    uniform float power;    varying vec2 texCoord;    void main() {      vec4 color = texture2D(texture, texCoord);      color = pow(color, vec4(power));      gl_FragColor = vec4(color);    }  ");var i="    uniform sampler2D texture0;    uniform sampler2D texture1;    uniform vec2 delta0;    uniform vec2 delta1;    uniform float power;    varying vec2 texCoord;    "+Xa.randomShaderFunc+"    vec4 sample(vec2 delta) {      /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(delta, 151.7182), 0.0);            vec4 color = vec4(0.0);      float total = 0.0;      for (float t = 0.0; t <= 30.0; t++) {        float percent = (t + offset) / 30.0;        color += texture2D(texture0, texCoord + delta * percent);        total += 1.0;      }      return color / total;    }  ";a.lensBlur0=a.lensBlur0||new ve.default(null,i+"    void main() {      gl_FragColor = sample(delta0);    }  "),a.lensBlur1=a.lensBlur1||new ve.default(null,i+"    void main() {      gl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;    }  "),a.lensBlur2=a.lensBlur2||new ve.default(null,i+"    void main() {      vec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;      gl_FragColor = pow(color, vec4(power));    }  ").textures({texture1:1});for(var n=[],s=0;s<3;s++){var o=r+s*Math.PI*2/3;n.push([e*Math.sin(o)/this.width,e*Math.cos(o)/this.height])}var l=Math.pow(10,(0,ae.clamp)(-1,t,1));return ae.simpleShader.call(this,a.lensBlurPrePass,{power:l}),this._.extraTexture.ensureFormat(this._.texture),ae.simpleShader.call(this,a.lensBlur0,{delta0:n[0]},this._.texture,this._.extraTexture),ae.simpleShader.call(this,a.lensBlur1,{delta0:n[1],delta1:n[2]},this._.extraTexture,this._.extraTexture),ae.simpleShader.call(this,a.lensBlur0,{delta0:n[1]}),this._.extraTexture.use(1),ae.simpleShader.call(this,a.lensBlur2,{power:1/l,delta0:n[2]}),this};var Ga=S,ve=Za(Ga),ae=E,Xa=B,Ha=T,Ya=Va(Ha);function Va(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Za(e){return e&&e.__esModule?e:{default:e}}var Xe={};Object.defineProperty(Xe,"__esModule",{value:!0});Xe.default=function(e,t,r,a,i,n){var s=ei.get("gl");s.tiltShift=s.tiltShift||new Qa.default(null,"    uniform sampler2D texture;    uniform float blurRadius;    uniform float gradientRadius;    uniform vec2 start;    uniform vec2 end;    uniform vec2 delta;    uniform vec2 texSize;    varying vec2 texCoord;    "+Ja.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));      float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;      for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  ");var o=r-e,l=a-t,u=Math.sqrt(o*o+l*l);return Ct.simpleShader.call(this,s.tiltShift,{blurRadius:i,gradientRadius:n,start:[e,t],end:[r,a],delta:[o/u,l/u],texSize:[this.width,this.height]}),Ct.simpleShader.call(this,s.tiltShift,{blurRadius:i,gradientRadius:n,start:[e,t],end:[r,a],delta:[-l/u,o/u],texSize:[this.width,this.height]}),this};var Ka=S,Qa=ri(Ka),Ct=E,Ja=B,ja=T,ei=ti(ja);function ti(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ri(e){return e&&e.__esModule?e:{default:e}}var He={};Object.defineProperty(He,"__esModule",{value:!0});He.default=function(e){var t=oi.get("gl");return t.triangleBlur=t.triangleBlur||new ii.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+ni.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec4 sample = texture2D(texture, texCoord + delta * percent);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  "),Et.simpleShader.call(this,t.triangleBlur,{delta:[e/this.width,0]}),Et.simpleShader.call(this,t.triangleBlur,{delta:[0,e/this.height]}),this};var ai=S,ii=ui(ai),Et=E,ni=B,si=T,oi=li(si);function li(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function ui(e){return e&&e.__esModule?e:{default:e}}var Ye={};Object.defineProperty(Ye,"__esModule",{value:!0});Ye.default=function(e,t,r){var a=vi.get("gl");return a.zoomBlur=a.zoomBlur||new ci.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    "+di.randomShaderFunc+"    void main() {      vec4 color = vec4(0.0);      float total = 0.0;      vec2 toCenter = center - texCoord * texSize;            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = 0.0; t <= 40.0; t++) {        float percent = (t + offset) / 40.0;        float weight = 4.0 * (percent - percent * percent);        vec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);                /* switch to pre-multiplied alpha to correctly blur transparent images */        sample.rgb *= sample.a;                color += sample * weight;        total += weight;      }            gl_FragColor = color / total;            /* switch back from pre-multiplied alpha */      gl_FragColor.rgb /= gl_FragColor.a + 0.00001;    }  "),fi.simpleShader.call(this,a.zoomBlur,{center:[e,t],strength:r,texSize:[this.width,this.height]}),this};var hi=S,ci=mi(hi),fi=E,di=B,pi=T,vi=gi(pi);function gi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function mi(e){return e&&e.__esModule?e:{default:e}}var Ve={};Object.defineProperty(Ve,"__esModule",{value:!0});Ve.default=function(e,t,r,a){var i=Ti.get("gl");return i.colorHalftone=i.colorHalftone||new yi.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float angle;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;        float pattern(float angle) {      float s = sin(angle), c = cos(angle);      vec2 tex = texCoord * texSize - center;      vec2 point = vec2(        c * tex.x - s * tex.y,        s * tex.x + c * tex.y      ) * scale;      return (sin(point.x) * sin(point.y)) * 4.0;    }        void main() {      vec4 color = texture2D(texture, texCoord);      vec3 cmy = 1.0 - color.rgb;      float k = min(cmy.x, min(cmy.y, cmy.z));      cmy = (cmy - k) / (1.0 - k);      cmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);      k = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);      gl_FragColor = vec4(1.0 - cmy - k, color.a);    }  "),wi.simpleShader.call(this,i.colorHalftone,{center:[e,t],angle:r,scale:Math.PI/a,texSize:[this.width,this.height]}),this};var xi=S,yi=Ei(xi),wi=E,_i=T,Ti=Ci(_i);function Ci(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ei(e){return e&&e.__esModule?e:{default:e}}var Ze={};Object.defineProperty(Ze,"__esModule",{value:!0});Ze.default=function(e,t,r,a){var i=bi.get("gl");return i.dotScreen=i.dotScreen||new Mi.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float angle;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;        float pattern() {      float s = sin(angle), c = cos(angle);      vec2 tex = texCoord * texSize - center;      vec2 point = vec2(        c * tex.x - s * tex.y,        s * tex.x + c * tex.y      ) * scale;      return (sin(point.x) * sin(point.y)) * 4.0;    }        void main() {      vec4 color = texture2D(texture, texCoord);      float average = (color.r + color.g + color.b) / 3.0;      gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);    }  "),Si.simpleShader.call(this,i.dotScreen,{center:[e,t],angle:r,scale:Math.PI/a,texSize:[this.width,this.height]}),this};var Ai=S,Mi=Ri(Ai),Si=E,Pi=T,bi=Oi(Pi);function Oi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ri(e){return e&&e.__esModule?e:{default:e}}var Ke={};Object.defineProperty(Ke,"__esModule",{value:!0});Ke.default=function(e){var t=$i.get("gl");return t.edgeWork1=t.edgeWork1||new At.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+St.randomShaderFunc+"    void main() {      vec2 color = vec2(0.0);      vec2 total = vec2(0.0);            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec3 sample = texture2D(texture, texCoord + delta * percent).rgb;        float average = (sample.r + sample.g + sample.b) / 3.0;        color.x += average * weight;        total.x += weight;        if (abs(t) < 15.0) {          weight = weight * 2.0 - 1.0;          color.y += average * weight;          total.y += weight;        }      }      gl_FragColor = vec4(color / total, 0.0, 1.0);    }  "),t.edgeWork2=t.edgeWork2||new At.default(null,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 texCoord;    "+St.randomShaderFunc+"    void main() {      vec2 color = vec2(0.0);      vec2 total = vec2(0.0);            /* randomize the lookup values to hide the fixed number of samples */      float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);            for (float t = -30.0; t <= 30.0; t++) {        float percent = (t + offset - 0.5) / 30.0;        float weight = 1.0 - abs(percent);        vec2 sample = texture2D(texture, texCoord + delta * percent).xy;        color.x += sample.x * weight;        total.x += weight;        if (abs(t) < 15.0) {          weight = weight * 2.0 - 1.0;          color.y += sample.y * weight;          total.y += weight;        }      }      float c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);      gl_FragColor = vec4(c, c, c, 1.0);    }  "),Mt.simpleShader.call(this,t.edgeWork1,{delta:[e/this.width,0]}),Mt.simpleShader.call(this,t.edgeWork2,{delta:[0,e/this.height]}),this};var ki=S,At=Fi(ki),Mt=E,St=B,Ii=T,$i=Di(Ii);function Di(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Fi(e){return e&&e.__esModule?e:{default:e}}var Qe={};Object.defineProperty(Qe,"__esModule",{value:!0});Qe.default=function(e,t,r){var a=Ui.get("gl");return a.hexagonalPixelate=a.hexagonalPixelate||new zi.default(null,"    uniform sampler2D texture;    uniform vec2 center;    uniform float scale;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 tex = (texCoord * texSize - center) / scale;      tex.y /= 0.866025404;      tex.x -= tex.y * 0.5;            vec2 a;      if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));      else a = vec2(ceil(tex.x), ceil(tex.y));      vec2 b = vec2(ceil(tex.x), floor(tex.y));      vec2 c = vec2(floor(tex.x), ceil(tex.y));            vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);      vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);      vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);      vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);            float alen = length(TEX - A);      float blen = length(TEX - B);      float clen = length(TEX - C);            vec2 choice;      if (alen < blen) {        if (alen < clen) choice = a;        else choice = c;      } else {        if (blen < clen) choice = b;        else choice = c;      }            choice.x += choice.y * 0.5;      choice.y *= 0.866025404;      choice *= scale / texSize;      gl_FragColor = texture2D(texture, choice + center / texSize);    }  "),Li.simpleShader.call(this,a.hexagonalPixelate,{center:[e,t],scale:r,texSize:[this.width,this.height]}),this};var Bi=S,zi=Wi(Bi),Li=E,Ni=T,Ui=qi(Ni);function qi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Wi(e){return e&&e.__esModule?e:{default:e}}var Je={};Object.defineProperty(Je,"__esModule",{value:!0});Je.default=function(e){var t=Vi.get("gl");return t.ink=t.ink||new Xi.default(null,"    uniform sampler2D texture;    uniform float strength;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {      vec2 dx = vec2(1.0 / texSize.x, 0.0);      vec2 dy = vec2(0.0, 1.0 / texSize.y);      vec4 color = texture2D(texture, texCoord);      float bigTotal = 0.0;      float smallTotal = 0.0;      vec3 bigAverage = vec3(0.0);      vec3 smallAverage = vec3(0.0);      for (float x = -2.0; x <= 2.0; x += 1.0) {        for (float y = -2.0; y <= 2.0; y += 1.0) {          vec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;          bigAverage += sample;          bigTotal += 1.0;          if (abs(x) + abs(y) < 2.0) {            smallAverage += sample;            smallTotal += 1.0;          }        }      }      vec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);      gl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);    }  "),Hi.simpleShader.call(this,t.ink,{strength:e*e*e*e*e,texSize:[this.width,this.height]}),this};var Gi=S,Xi=Ki(Gi),Hi=E,Yi=T,Vi=Zi(Yi);function Zi(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function Ki(e){return e&&e.__esModule?e:{default:e}}var je={};Object.defineProperty(je,"__esModule",{value:!0});je.default=function(e,t,r,a){var i=ji.get("gl");return i.bulgePinch=i.bulgePinch||(0,Qi.warpShader)("    uniform float radius;    uniform float strength;    uniform vec2 center;  ","    coord -= center;    float distance = length(coord);    if (distance < radius) {      float percent = distance / radius;      if (strength > 0.0) {        coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);      } else {        coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);      }    }    coord += center;  "),Pt.simpleShader.call(this,i.bulgePinch,{radius:r,strength:(0,Pt.clamp)(-1,a,1),center:[e,t],texSize:[this.width,this.height]}),this};var Qi=B,Pt=E,Ji=T,ji=en(Ji);function en(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var et={},le={};Object.defineProperty(le,"__esModule",{value:!0});le.getSquareToQuad=tn;le.getInverse=rn;le.multiply=an;function tn(e,t,r,a,i,n,s,o){var l=r-i,u=a-n,c=s-i,f=o-n,h=e-r+i-s,v=t-a+n-o,g=l*f-c*u,w=(h*f-c*v)/g,A=(l*v-h*u)/g;return[r-e+w*r,a-t+w*a,w,s-e+A*s,o-t+A*o,A,e,t,1]}function rn(e){var t=e[0],r=e[1],a=e[2],i=e[3],n=e[4],s=e[5],o=e[6],l=e[7],u=e[8],c=t*n*u-t*s*l-r*i*u+r*s*o+a*i*l-a*n*o;return[(n*u-s*l)/c,(a*l-r*u)/c,(r*s-a*n)/c,(s*o-i*u)/c,(t*u-a*o)/c,(a*i-t*s)/c,(i*l-n*o)/c,(r*o-t*l)/c,(t*n-r*i)/c]}function an(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}Object.defineProperty(et,"__esModule",{value:!0});et.default=function(e,t,r){var a=un.get("gl");if(a.matrixWarp=a.matrixWarp||(0,nn.warpShader)("    uniform mat3 matrix;    uniform bool useTextureSpace;  ","    if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;    vec3 warp = matrix * vec3(coord, 1.0);    coord = warp.xy / warp.z;    if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;  "),e=Array.prototype.concat.apply([],e),e.length==4)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(e.length!=9)throw"can only warp with 2x2 or 3x3 matrix";return on.simpleShader.call(this,a.matrixWarp,{matrix:t?(0,sn.getInverse)(e):e,texSize:[this.width,this.height],useTextureSpace:r|0}),this};var nn=B,sn=le,on=E,ln=T,un=hn(ln);function hn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var tt={};Object.defineProperty(tt,"__esModule",{value:!0});tt.default=function(e,t){var r=ge.getSquareToQuad.apply(null,t),a=ge.getSquareToQuad.apply(null,e),i=(0,ge.multiply)((0,ge.getInverse)(r),a);return this.matrixWarp(i)};var ge=le,rt={};Object.defineProperty(rt,"__esModule",{value:!0});rt.default=function(e,t,r,a){var i=pn.get("gl");return i.swirl=i.swirl||(0,cn.warpShader)("    uniform float radius;    uniform float angle;    uniform vec2 center;  ","    coord -= center;    float distance = length(coord);    if (distance < radius) {      float percent = (radius - distance) / radius;      float theta = percent * percent * angle;      float s = sin(theta);      float c = cos(theta);      coord = vec2(        coord.x * c - coord.y * s,        coord.x * s + coord.y * c      );    }    coord += center;  "),fn.simpleShader.call(this,i.swirl,{radius:r,center:[e,t],angle:a,texSize:[this.width,this.height]}),this};var cn=B,fn=E,dn=T,pn=vn(dn);function vn(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=De;Object.defineProperty(e,"brightnessContrast",{enumerable:!0,get:function(){return x(t).default}});var r=Fe;Object.defineProperty(e,"curves",{enumerable:!0,get:function(){return x(r).default}});var a=Be;Object.defineProperty(e,"denoise",{enumerable:!0,get:function(){return x(a).default}});var i=ze;Object.defineProperty(e,"hueSaturation",{enumerable:!0,get:function(){return x(i).default}});var n=Le;Object.defineProperty(e,"noise",{enumerable:!0,get:function(){return x(n).default}});var s=Ne;Object.defineProperty(e,"sepia",{enumerable:!0,get:function(){return x(s).default}});var o=Ue;Object.defineProperty(e,"unsharpMask",{enumerable:!0,get:function(){return x(o).default}});var l=qe;Object.defineProperty(e,"vibrance",{enumerable:!0,get:function(){return x(l).default}});var u=We;Object.defineProperty(e,"vignette",{enumerable:!0,get:function(){return x(u).default}});var c=Ge;Object.defineProperty(e,"lensBlur",{enumerable:!0,get:function(){return x(c).default}});var f=Xe;Object.defineProperty(e,"tiltShift",{enumerable:!0,get:function(){return x(f).default}});var h=He;Object.defineProperty(e,"triangleBlur",{enumerable:!0,get:function(){return x(h).default}});var v=Ye;Object.defineProperty(e,"zoomBlur",{enumerable:!0,get:function(){return x(v).default}});var g=Ve;Object.defineProperty(e,"colorHalftone",{enumerable:!0,get:function(){return x(g).default}});var w=Ze;Object.defineProperty(e,"dotScreen",{enumerable:!0,get:function(){return x(w).default}});var A=Ke;Object.defineProperty(e,"edgeWork",{enumerable:!0,get:function(){return x(A).default}});var P=Qe;Object.defineProperty(e,"hexagonalPixelate",{enumerable:!0,get:function(){return x(P).default}});var I=Je;Object.defineProperty(e,"ink",{enumerable:!0,get:function(){return x(I).default}});var k=je;Object.defineProperty(e,"bulgePinch",{enumerable:!0,get:function(){return x(k).default}});var y=et;Object.defineProperty(e,"matrixWarp",{enumerable:!0,get:function(){return x(y).default}});var b=tt;Object.defineProperty(e,"perspective",{enumerable:!0,get:function(){return x(b).default}});var d=rt;Object.defineProperty(e,"swirl",{enumerable:!0,get:function(){return x(d).default}});function x(m){return m&&m.__esModule?m:{default:m}}})(Nt);(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.splineInterpolate=void 0;var t=E;Object.defineProperty(e,"splineInterpolate",{enumerable:!0,get:function(){return t.splineInterpolate}}),e.canvas=b;var r=T,a=f(r),i=$e,n=c(i),s=S,o=c(s),l=Nt,u=f(l);function c(d){return d&&d.__esModule?d:{default:d}}function f(d){if(d&&d.__esModule)return d;var x={};if(d!=null)for(var m in d)Object.prototype.hasOwnProperty.call(d,m)&&(x[m]=d[m]);return x.default=d,x}function h(d){return{_:d,loadContentsOf:function(m){a.set({gl:this._.gl}),this._.loadContentsOf(m)},destroy:function(){a.set({gl:this._.gl}),this._.destroy()}}}function v(d){return h(n.default.fromElement(d))}function g(d,x){var m=a.get("gl"),D=m.UNSIGNED_BYTE;if(m.getExtension("OES_texture_float")&&m.getExtension("OES_texture_float_linear")){var V=new n.default(100,100,m.RGBA,m.FLOAT);try{V.drawTo(function(){D=m.FLOAT})}catch{}V.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=d,this.height=x,this._.texture=new n.default(d,x,m.RGBA,D),this._.spareTexture=new n.default(d,x,m.RGBA,D),this._.extraTexture=this._.extraTexture||new n.default(0,0,m.RGBA,D),this._.flippedShader=this._.flippedShader||new o.default(null,"	    uniform sampler2D texture;	    varying vec2 texCoord;	    void main() {	      gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));	    }	  "),this._.isInitialized=!0}function w(d,x,m){return(!this._.isInitialized||d._.width!=this.width||d._.height!=this.height)&&g.call(this,x||d._.width,m||d._.height),d._.use(),this._.texture.drawTo(function(){o.default.getDefaultShader().drawRect()}),this}function A(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function P(d){return d.parentNode.insertBefore(this,d),d.parentNode.removeChild(d),this}function I(){var d=a.get("gl"),x=new n.default(this._.texture.width,this._.texture.height,d.RGBA,d.UNSIGNED_BYTE);return this._.texture.use(),x.drawTo(function(){o.default.getDefaultShader().drawRect()}),h(x)}function k(){var d=a.get("gl"),x=this._.texture.width,m=this._.texture.height,D=new Uint8Array(x*m*4);return this._.texture.drawTo(function(){d.readPixels(0,0,x,m,d.RGBA,d.UNSIGNED_BYTE,D)}),D}function y(d){return function(){return a.set({gl:this._.gl}),d.apply(this,arguments)}}function b(){var d=arguments.length>0&&arguments[0]!==void 0?arguments[0]:document.createElement("canvas");try{a.set({gl:d.getContext("experimental-webgl",{premultipliedAlpha:!1})})}catch{a.set({gl:null})}var x=a.get("gl");if(!x)throw"This browser does not support WebGL";return d._={gl:x,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},d.texture=y(v),d.draw=y(w),d.update=y(A),d.replace=y(P),d.contents=y(I),d.getPixelArray=y(k),d.brightnessContrast=y(u.brightnessContrast),d.hexagonalPixelate=y(u.hexagonalPixelate),d.hueSaturation=y(u.hueSaturation),d.colorHalftone=y(u.colorHalftone),d.triangleBlur=y(u.triangleBlur),d.unsharpMask=y(u.unsharpMask),d.perspective=y(u.perspective),d.matrixWarp=y(u.matrixWarp),d.bulgePinch=y(u.bulgePinch),d.tiltShift=y(u.tiltShift),d.dotScreen=y(u.dotScreen),d.edgeWork=y(u.edgeWork),d.lensBlur=y(u.lensBlur),d.zoomBlur=y(u.zoomBlur),d.noise=y(u.noise),d.denoise=y(u.denoise),d.curves=y(u.curves),d.swirl=y(u.swirl),d.ink=y(u.ink),d.vignette=y(u.vignette),d.vibrance=y(u.vibrance),d.sepia=y(u.sepia),d}})(zt);class gn{constructor(t=!0){p(this,"fxCanvas",zt.canvas());p(this,"textureMap",new Map);p(this,"cache");this.cache=t}draw(t,r,a){const i=this.cache&&this.textureMap.has(r)?this.textureMap.get(r):this.fxCanvas.texture(r);this.cache&&!this.textureMap.has(r)&&this.textureMap.set(r,i);let[n,s]=a[0],[o,l]=a[1],[u,c]=a[2],[f,h]=a[3];const[v,g]=a[4];n+=v,o+=v,u+=v,f+=v,s+=g,l+=g,c+=g,h+=g;const w=t.canvas;this.fxCanvas.draw(i,w.width,w.height).perspective([0,0,w.width,0,0,w.height,w.width,w.height],[n,s,f,h,o,l,u,c]).update(),t.drawImage(this.fxCanvas,0,0),this.cache||i.destroy()}destroy(){if(this.cache)for(const t of[...this.textureMap.values()])t.destroy()}}function mn(e){const t=document.createElement("canvas"),r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.translate(e.width,0),r.scale(-1,1),r.drawImage(e,0,0),t}function xn(e){const t=document.createElement("canvas"),r=t.getContext("2d"),a=e.width,i=e.height;t.width=a,t.height=i,r.drawImage(e,0,0);const n=r.getImageData(0,0,a,i),s=n.data;for(let o=0;o<s.length;o+=4){const l=s[o],u=s[o+1],c=s[o+2];l+u+c>383?(s[o]=255,s[o+1]=255,s[o+2]=255):(s[o]=0,s[o+1]=0,s[o+2]=0)}return r.putImageData(n,0,0),t}function yn(e){const t=document.createElement("canvas"),r=t.getContext("2d"),a=Math.min(e.width,e.height)/2;return t.width=a*2,t.height=a*2,r.save(),r.beginPath(),r.arc(a,a,a,0,2*Math.PI),r.closePath(),r.clip(),r.drawImage(e,a-e.width/2,a-e.height/2),r.restore(),t}var F="INUMBER",ue="IOP1",he="IOP2",ce="IOP3",G="IVAR",ee="IVARNAME",ne="IFUNCALL",xe="IFUNDEF",$="IEXPR",at="IEXPREVAL",te="IMEMBER",ye="IENDSTATEMENT",se="IARRAY";function _(e,t){this.type=e,this.value=t??0}_.prototype.toString=function(){switch(this.type){case F:case ue:case he:case ce:case G:case ee:case ye:return this.value;case ne:return"CALL "+this.value;case xe:return"DEF "+this.value;case se:return"ARRAY "+this.value;case te:return"."+this.value;default:return"Invalid Instruction"}};function we(e){return new _(ue,e)}function Y(e){return new _(he,e)}function Ut(e){return new _(ce,e)}function ke(e,t,r,a,i){for(var n=[],s=[],o,l,u,c,f=0;f<e.length;f++){var h=e[f],v=h.type;if(v===F||v===ee)Array.isArray(h.value)?n.push.apply(n,ke(h.value.map(function(g){return new _(F,g)}).concat(new _(se,h.value.length)),t,r,a,i)):n.push(h);else if(v===G&&i.hasOwnProperty(h.value))h=new _(F,i[h.value]),n.push(h);else if(v===he&&n.length>1)l=n.pop(),o=n.pop(),c=r[h.value],h=new _(F,c(o.value,l.value)),n.push(h);else if(v===ce&&n.length>2)u=n.pop(),l=n.pop(),o=n.pop(),h.value==="?"?n.push(o.value?l.value:u.value):(c=a[h.value],h=new _(F,c(o.value,l.value,u.value)),n.push(h));else if(v===ue&&n.length>0)o=n.pop(),c=t[h.value],h=new _(F,c(o.value)),n.push(h);else if(v===$){for(;n.length>0;)s.push(n.shift());s.push(new _($,ke(h.value,t,r,a,i)))}else if(v===te&&n.length>0)o=n.pop(),n.push(new _(F,o.value[h.value]));else{for(;n.length>0;)s.push(n.shift());s.push(h)}}for(;n.length>0;)s.push(n.shift());return s}function qt(e,t,r){for(var a=[],i=0;i<e.length;i++){var n=e[i],s=n.type;if(s===G&&n.value===t)for(var o=0;o<r.tokens.length;o++){var l=r.tokens[o],u;l.type===ue?u=we(l.value):l.type===he?u=Y(l.value):l.type===ce?u=Ut(l.value):u=new _(l.type,l.value),a.push(u)}else s===$?a.push(new _($,qt(n.value,t,r))):a.push(n)}return a}function K(e,t,r){var a=[],i,n,s,o,l,u;if(it(e))return U(e,r);for(var c=e.length,f=0;f<c;f++){var h=e[f],v=h.type;if(v===F||v===ee)a.push(h.value);else if(v===he)n=a.pop(),i=a.pop(),h.value==="and"?a.push(i?!!K(n,t,r):!1):h.value==="or"?a.push(i?!0:!!K(n,t,r)):h.value==="="?(o=t.binaryOps[h.value],a.push(o(i,K(n,t,r),r))):(o=t.binaryOps[h.value],a.push(o(U(i,r),U(n,r))));else if(v===ce)s=a.pop(),n=a.pop(),i=a.pop(),h.value==="?"?a.push(K(i?n:s,t,r)):(o=t.ternaryOps[h.value],a.push(o(U(i,r),U(n,r),U(s,r))));else if(v===G)if(h.value in t.functions)a.push(t.functions[h.value]);else if(h.value in t.unaryOps&&t.parser.isOperatorEnabled(h.value))a.push(t.unaryOps[h.value]);else{var g=r[h.value];if(g!==void 0)a.push(g);else throw new Error("undefined variable: "+h.value)}else if(v===ue)i=a.pop(),o=t.unaryOps[h.value],a.push(o(U(i,r)));else if(v===ne){for(u=h.value,l=[];u-- >0;)l.unshift(U(a.pop(),r));if(o=a.pop(),o.apply&&o.call)a.push(o.apply(void 0,l));else throw new Error(o+" is not a function")}else if(v===xe)a.push(function(){for(var w=a.pop(),A=[],P=h.value;P-- >0;)A.unshift(a.pop());var I=a.pop(),k=function(){for(var y=Object.assign({},r),b=0,d=A.length;b<d;b++)y[A[b]]=arguments[b];return K(w,t,y)};return Object.defineProperty(k,"name",{value:I,writable:!1}),r[I]=k,k}());else if(v===$)a.push(wn(h,t));else if(v===at)a.push(h);else if(v===te)i=a.pop(),a.push(i[h.value]);else if(v===ye)a.pop();else if(v===se){for(u=h.value,l=[];u-- >0;)l.unshift(a.pop());a.push(l)}else throw new Error("invalid Expression")}if(a.length>1)throw new Error("invalid Expression (parity)");return a[0]===0?0:U(a[0],r)}function wn(e,t,r){return it(e)?e:{type:at,value:function(a){return K(e.value,t,a)}}}function it(e){return e&&e.type===at}function U(e,t){return it(e)?e.value(t):e}function nt(e,t){for(var r=[],a,i,n,s,o,l,u=0;u<e.length;u++){var c=e[u],f=c.type;if(f===F)typeof c.value=="number"&&c.value<0?r.push("("+c.value+")"):Array.isArray(c.value)?r.push("["+c.value.map(bt).join(", ")+"]"):r.push(bt(c.value));else if(f===he)i=r.pop(),a=r.pop(),s=c.value,t?s==="^"?r.push("Math.pow("+a+", "+i+")"):s==="and"?r.push("(!!"+a+" && !!"+i+")"):s==="or"?r.push("(!!"+a+" || !!"+i+")"):s==="||"?r.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+a+"),("+i+")))"):s==="=="?r.push("("+a+" === "+i+")"):s==="!="?r.push("("+a+" !== "+i+")"):s==="["?r.push(a+"[("+i+") | 0]"):r.push("("+a+" "+s+" "+i+")"):s==="["?r.push(a+"["+i+"]"):r.push("("+a+" "+s+" "+i+")");else if(f===ce)if(n=r.pop(),i=r.pop(),a=r.pop(),s=c.value,s==="?")r.push("("+a+" ? "+i+" : "+n+")");else throw new Error("invalid Expression");else if(f===G||f===ee)r.push(c.value);else if(f===ue)a=r.pop(),s=c.value,s==="-"||s==="+"?r.push("("+s+a+")"):t?s==="not"?r.push("(!"+a+")"):s==="!"?r.push("fac("+a+")"):r.push(s+"("+a+")"):s==="!"?r.push("("+a+"!)"):r.push("("+s+" "+a+")");else if(f===ne){for(l=c.value,o=[];l-- >0;)o.unshift(r.pop());s=r.pop(),r.push(s+"("+o.join(", ")+")")}else if(f===xe){for(i=r.pop(),l=c.value,o=[];l-- >0;)o.unshift(r.pop());a=r.pop(),t?r.push("("+a+" = function("+o.join(", ")+") { return "+i+" })"):r.push("("+a+"("+o.join(", ")+") = "+i+")")}else if(f===te)a=r.pop(),r.push(a+"."+c.value);else if(f===se){for(l=c.value,o=[];l-- >0;)o.unshift(r.pop());r.push("["+o.join(", ")+"]")}else if(f===$)r.push("("+nt(c.value,t)+")");else if(f!==ye)throw new Error("invalid Expression")}return r.length>1&&(t?r=[r.join(",")]:r=[r.join(";")]),String(r[0])}function bt(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function ie(e,t){for(var r=0;r<e.length;r++)if(e[r]===t)return!0;return!1}function st(e,t,r){r=r||{};for(var a=!!r.withMembers,i=null,n=0;n<e.length;n++){var s=e[n];s.type===G||s.type===ee?!a&&!ie(t,s.value)?t.push(s.value):(i!==null&&(ie(t,i)||t.push(i)),i=s.value):s.type===te&&a&&i!==null?i+="."+s.value:s.type===$?st(s.value,t,r):i!==null&&(ie(t,i)||t.push(i),i=null)}i!==null&&!ie(t,i)&&t.push(i)}function N(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}N.prototype.simplify=function(e){return e=e||{},new N(ke(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};N.prototype.substitute=function(e,t){return t instanceof N||(t=this.parser.parse(String(t))),new N(qt(this.tokens,e,t),this.parser)};N.prototype.evaluate=function(e){return e=e||{},K(this.tokens,this,e)};N.prototype.toString=function(){return nt(this.tokens,!1)};N.prototype.symbols=function(e){e=e||{};var t=[];return st(this.tokens,t,e),t};N.prototype.variables=function(e){e=e||{};var t=[];st(this.tokens,t,e);var r=this.functions;return t.filter(function(a){return!(a in r)})};N.prototype.toJSFunction=function(e,t){var r=this,a=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+nt(this.simplify(t).tokens,!0)+"; }");return function(){return a.apply(r,arguments)}};var de="TEOF",C="TOP",_e="TNUMBER",Wt="TSTRING",X="TPAREN",oe="TBRACKET",Te="TCOMMA",ot="TNAME",lt="TSEMICOLON";function Gt(e,t,r){this.type=e,this.value=t,this.index=r}Gt.prototype.toString=function(){return this.type+": "+this.value};function O(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}O.prototype.newToken=function(e,t,r){return new Gt(e,t,r??this.pos)};O.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};O.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};O.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(de,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};O.prototype.isString=function(){var e=!1,t=this.pos,r=this.expression.charAt(t);if(r==="'"||r==='"')for(var a=this.expression.indexOf(r,t+1);a>=0&&this.pos<this.expression.length;){if(this.pos=a+1,this.expression.charAt(a-1)!=="\\"){var i=this.expression.substring(t+1,a);this.current=this.newToken(Wt,this.unescape(i),t),e=!0;break}a=this.expression.indexOf(r,a+1)}return e};O.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(X,e),this.pos++,!0):!1};O.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(oe,e),this.pos++,!0):!1};O.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(Te,","),this.pos++,!0):!1};O.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(lt,";"),this.pos++,!0):!1};O.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&r!=="."&&(r<"0"||r>"9")))break}if(t>e){var a=this.expression.substring(e,t);if(a in this.consts)return this.current=this.newToken(_e,this.consts[a]),this.pos+=a.length,!0}return!1};O.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&(r<"0"||r>"9")))break}if(t>e){var a=this.expression.substring(e,t);if(this.isOperatorEnabled(a)&&(a in this.binaryOps||a in this.unaryOps||a in this.ternaryOps))return this.current=this.newToken(C,a),this.pos+=a.length,!0}return!1};O.prototype.isName=function(){for(var e=this.pos,t=e,r=!1;t<this.expression.length;t++){var a=this.expression.charAt(t);if(a.toUpperCase()===a.toLowerCase()){if(t===this.pos&&(a==="$"||a==="_")){a==="_"&&(r=!0);continue}else if(t===this.pos||!r||a!=="_"&&(a<"0"||a>"9"))break}else r=!0}if(r){var i=this.expression.substring(e,t);return this.current=this.newToken(ot,i),this.pos+=i.length,!0}return!1};O.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var _n=/^[0-9a-f]{4}$/i;O.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var r=e.substring(0,t);t>=0;){var a=e.charAt(++t);switch(a){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+=`
`;break;case"r":r+="\r";break;case"t":r+="	";break;case"u":var i=e.substring(t+1,t+5);_n.test(i)||this.parseError("Illegal escape sequence: \\u"+i),r+=String.fromCharCode(parseInt(i,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+a+'"')}++t;var n=e.indexOf("\\",t);r+=e.substring(t,n<0?e.length:n),t=n}return r};O.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};O.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,r;if(this.expression.charAt(e)==="x")t=16,r=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,r=/^[01]$/i,++e;else return!1;for(var a=!1,i=e;e<this.expression.length;){var n=this.expression.charAt(e);if(r.test(n))e++,a=!0;else break}return a&&(this.current=this.newToken(_e,parseInt(this.expression.substring(i,e),t)),this.pos=e),a};O.prototype.isNumber=function(){for(var e=!1,t=this.pos,r=t,a=t,i=!1,n=!1,s;t<this.expression.length&&(s=this.expression.charAt(t),s>="0"&&s<="9"||!i&&s===".");)s==="."?i=!0:n=!0,t++,e=n;if(e&&(a=t),s==="e"||s==="E"){t++;for(var o=!0,l=!1;t<this.expression.length;){if(s=this.expression.charAt(t),o&&(s==="+"||s==="-"))o=!1;else if(s>="0"&&s<="9")l=!0,o=!1;else break;t++}l||(t=a)}return e?(this.current=this.newToken(_e,parseFloat(this.expression.substring(r,t))),this.pos=t):this.pos=a,e};O.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(C,t);else if(t==="∙"||t==="•")this.current=this.newToken(C,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,">="),this.pos++):this.current=this.newToken(C,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,"<="),this.pos++):this.current=this.newToken(C,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(C,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,"=="),this.pos++):this.current=this.newToken(C,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(C,"!="),this.pos++):this.current=this.newToken(C,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};O.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};O.prototype.getCoordinates=function(){var e=0,t,r=-1;do e++,t=this.pos-r,r=this.expression.indexOf(`
`,r+1);while(r>=0&&r<this.pos);return{line:e,column:t}};O.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function M(e,t,r){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=r.allowMemberAccess!==!1}M.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};M.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?ie(t,e.value):typeof t=="function"?t(e):e.value===t};M.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};M.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};M.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};M.prototype.expect=function(e,t){if(!this.accept(e,t)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(t||e))}};M.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.accept(ot)||this.accept(C,r))e.push(new _(G,this.current.value));else if(this.accept(_e))e.push(new _(F,this.current.value));else if(this.accept(Wt))e.push(new _(F,this.current.value));else if(this.accept(X,"("))this.parseExpression(e),this.expect(X,")");else if(this.accept(oe,"["))if(this.accept(oe,"]"))e.push(new _(se,0));else{var a=this.parseArrayList(e);e.push(new _(se,a))}else throw new Error("unexpected "+this.nextToken)};M.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};M.prototype.pushExpression=function(e,t){for(var r=0,a=t.length;r<a;r++)e.push(t[r])};M.prototype.parseUntilEndStatement=function(e,t){return this.accept(lt)?(this.nextToken&&this.nextToken.type!==de&&!(this.nextToken.type===X&&this.nextToken.value===")")&&t.push(new _(ye)),this.nextToken.type!==de&&this.parseExpression(t),e.push(new _($,t)),!0):!1};M.prototype.parseArrayList=function(e){for(var t=0;!this.accept(oe,"]");)for(this.parseExpression(e),++t;this.accept(Te);)this.parseExpression(e),++t;return t};M.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(C,"=");){var t=e.pop(),r=[],a=e.length-1;if(t.type===ne){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var i=0,n=t.value+1;i<n;i++){var s=a-i;e[s].type===G&&(e[s]=new _(ee,e[s].value))}this.parseVariableAssignmentExpression(r),e.push(new _($,r)),e.push(new _(xe,t.value));continue}if(t.type!==G&&t.type!==te)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),e.push(new _(ee,t.value)),e.push(new _($,r)),e.push(Y("="))}};M.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(C,"?");){var t=[],r=[];this.parseConditionalExpression(t),this.expect(C,":"),this.parseConditionalExpression(r),e.push(new _($,t)),e.push(new _($,r)),e.push(Ut("?"))}};M.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(C,"or");){var t=[];this.parseAndExpression(t),e.push(new _($,t)),e.push(Y("or"))}};M.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(C,"and");){var t=[];this.parseComparison(t),e.push(new _($,t)),e.push(Y("and"))}};var Tn=["==","!=","<","<=",">=",">","in"];M.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(C,Tn);){var t=this.current;this.parseAddSub(e),e.push(Y(t.value))}};var Cn=["+","-","||"];M.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(C,Cn);){var t=this.current;this.parseTerm(e),e.push(Y(t.value))}};var En=["*","/","%"];M.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(C,En);){var t=this.current;this.parseFactor(e),e.push(Y(t.value))}};M.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.save(),this.accept(C,r)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===X&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===lt||this.nextToken.type===Te||this.nextToken.type===de||this.nextToken.type===X&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var a=this.current;this.parseFactor(e),e.push(we(a.value))}else this.parseExponential(e)};M.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(C,"^");)this.parseFactor(e),e.push(Y("^"))};M.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(C,"!");)e.push(we("!"))};M.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function r(n){return n.value in t}if(this.accept(C,r)){var a=this.current;this.parseAtom(e),e.push(we(a.value))}else for(this.parseMemberExpression(e);this.accept(X,"(");)if(this.accept(X,")"))e.push(new _(ne,0));else{var i=this.parseArgumentList(e);e.push(new _(ne,i))}};M.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(X,")");)for(this.parseExpression(e),++t;this.accept(Te);)this.parseExpression(e),++t;return t};M.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(C,".")||this.accept(oe,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(ot),e.push(new _(te,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(oe,"]"),e.push(Y("["))}else throw new Error("unexpected symbol: "+t.value)}};function An(e,t){return Number(e)+Number(t)}function Mn(e,t){return e-t}function Sn(e,t){return e*t}function Pn(e,t){return e/t}function bn(e,t){return e%t}function On(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function Rn(e,t){return e===t}function kn(e,t){return e!==t}function In(e,t){return e>t}function $n(e,t){return e<t}function Dn(e,t){return e>=t}function Fn(e,t){return e<=t}function Bn(e,t){return!!(e&&t)}function zn(e,t){return!!(e||t)}function Ln(e,t){return ie(t,e)}function Nn(e){return(Math.exp(e)-Math.exp(-e))/2}function Un(e){return(Math.exp(e)+Math.exp(-e))/2}function qn(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function Wn(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function Gn(e){return Math.log(e+Math.sqrt(e*e-1))}function Xn(e){return Math.log((1+e)/(1-e))/2}function Ot(e){return Math.log(e)*Math.LOG10E}function Hn(e){return-e}function Yn(e){return!e}function Vn(e){return e<0?Math.ceil(e):Math.floor(e)}function Zn(e){return Math.random()*(e||1)}function Rt(e){return ut(e+1)}function Kn(e){return isFinite(e)&&e===Math.round(e)}var Qn=4.7421875,Oe=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function ut(e){var t,r;if(Kn(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var a=e-2,i=e-1;a>1;)i*=a,a--;return i===0&&(i=1),i}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*ut(1-e));if(e>=171.35)return 1/0;if(e>85){var n=e*e,s=n*e,o=s*e,l=o*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*n)-139/(51840*s)-571/(2488320*o)+163879/(209018880*l)+5246819/(75246796800*l*e))}--e,r=Oe[0];for(var u=1;u<Oe.length;++u)r+=Oe[u]/(e+u);return t=e+Qn+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*r}function Jn(e){return Array.isArray(e)?e.length:String(e).length}function kt(){for(var e=0,t=0,r=0;r<arguments.length;r++){var a=Math.abs(arguments[r]),i;t<a?(i=t/a,e=e*i*i+1,t=a):a>0?(i=a/t,e+=i*i):e+=a}return t===1/0?1/0:t*Math.sqrt(e)}function It(e,t,r){return e?t:r}function jn(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function es(e,t,r){return r&&(r[e]=t),t}function ts(e,t){return e[t|0]}function rs(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function as(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function is(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(r,a){return e(r,a)})}function ns(e,t,r){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce(function(a,i,n){return e(a,i,n)},t)}function ss(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(r,a){return e(r,a)})}function os(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function ls(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function us(e){return(e>0)-(e<0)||+e}var $t=1/3;function hs(e){return e<0?-Math.pow(-e,$t):Math.pow(e,$t)}function cs(e){return Math.exp(e)-1}function fs(e){return Math.log(1+e)}function ds(e){return Math.log(e)/Math.LN2}function H(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Nn,cosh:Math.cosh||Un,tanh:Math.tanh||qn,asinh:Math.asinh||Wn,acosh:Math.acosh||Gn,atanh:Math.atanh||Xn,sqrt:Math.sqrt,cbrt:Math.cbrt||hs,log:Math.log,log2:Math.log2||ds,ln:Math.log,lg:Math.log10||Ot,log10:Math.log10||Ot,expm1:Math.expm1||cs,log1p:Math.log1p||fs,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Vn,"-":Hn,"+":Number,exp:Math.exp,not:Yn,length:Jn,"!":Rt,sign:Math.sign||us},this.binaryOps={"+":An,"-":Mn,"*":Sn,"/":Pn,"%":bn,"^":Math.pow,"||":On,"==":Rn,"!=":kn,">":In,"<":$n,">=":Dn,"<=":Fn,and:Bn,or:zn,in:Ln,"=":es,"[":ts},this.ternaryOps={"?":It},this.functions={random:Zn,fac:Rt,min:as,max:rs,hypot:Math.hypot||kt,pyt:Math.hypot||kt,pow:Math.pow,atan2:Math.atan2,if:It,gamma:ut,roundTo:jn,map:is,fold:ns,filter:ss,indexOf:os,join:ls},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}H.prototype.parse=function(e){var t=[],r=new M(this,new O(this,e),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(t),r.expect(de,"EOF"),new N(t,this)};H.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Xt=new H;H.parse=function(e){return Xt.parse(e)};H.evaluate=function(e,t){return Xt.parse(e).evaluate(t)};var Dt={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function ps(e){return Dt.hasOwnProperty(e)?Dt[e]:e}H.prototype.isOperatorEnabled=function(e){var t=ps(e),r=this.options.operators||{};return!(t in r)||!!r[t]};var j={},Ht={},W={};Object.defineProperty(W,"__esModule",{value:!0});W.loop=W.conditional=W.parse=void 0;var vs=function e(t,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:a;if(Array.isArray(r))r.forEach(function(s){return e(t,s,a,i)});else if(typeof r=="function")r(t,a,i,e);else{var n=Object.keys(r)[0];Array.isArray(r[n])?(i[n]={},e(t,r[n],a,i[n])):i[n]=r[n](t,a,i,e)}return a};W.parse=vs;var gs=function(t,r){return function(a,i,n,s){r(a,i,n)&&s(a,t,i,n)}};W.conditional=gs;var ms=function(t,r){return function(a,i,n,s){for(var o=[],l=a.pos;r(a,i,n);){var u={};if(s(a,t,i,u),a.pos===l)break;l=a.pos,o.push(u)}return o}};W.loop=ms;var R={};Object.defineProperty(R,"__esModule",{value:!0});R.readBits=R.readArray=R.readUnsigned=R.readString=R.peekBytes=R.readBytes=R.peekByte=R.readByte=R.buildStream=void 0;var xs=function(t){return{data:t,pos:0}};R.buildStream=xs;var Yt=function(){return function(t){return t.data[t.pos++]}};R.readByte=Yt;var ys=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(r){return r.data[r.pos+t]}};R.peekByte=ys;var Ce=function(t){return function(r){return r.data.subarray(r.pos,r.pos+=t)}};R.readBytes=Ce;var ws=function(t){return function(r){return r.data.subarray(r.pos,r.pos+t)}};R.peekBytes=ws;var _s=function(t){return function(r){return Array.from(Ce(t)(r)).map(function(a){return String.fromCharCode(a)}).join("")}};R.readString=_s;var Ts=function(t){return function(r){var a=Ce(2)(r);return t?(a[1]<<8)+a[0]:(a[0]<<8)+a[1]}};R.readUnsigned=Ts;var Cs=function(t,r){return function(a,i,n){for(var s=typeof r=="function"?r(a,i,n):r,o=Ce(t),l=new Array(s),u=0;u<s;u++)l[u]=o(a);return l}};R.readArray=Cs;var Es=function(t,r,a){for(var i=0,n=0;n<a;n++)i+=t[r+n]&&Math.pow(2,a-n-1);return i},As=function(t){return function(r){for(var a=Yt()(r),i=new Array(8),n=0;n<8;n++)i[7-n]=!!(a&1<<n);return Object.keys(t).reduce(function(s,o){var l=t[o];return l.length?s[o]=Es(i,l.index,l.length):s[o]=i[l.index],s},{})}};R.readBits=As;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=W,r=R,a={blocks:function(h){for(var v=0,g=[],w=h.data.length,A=0,P=(0,r.readByte)()(h);P!==v&&P;P=(0,r.readByte)()(h)){if(h.pos+P>=w){var I=w-h.pos;g.push((0,r.readBytes)(I)(h)),A+=I;break}g.push((0,r.readBytes)(P)(h)),A+=P}for(var k=new Uint8Array(A),y=0,b=0;b<g.length;b++)k.set(g[b],y),y+=g[b].length;return k}},i=(0,t.conditional)({gce:[{codes:(0,r.readBytes)(2)},{byteSize:(0,r.readByte)()},{extras:(0,r.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,r.readUnsigned)(!0)},{transparentColorIndex:(0,r.readByte)()},{terminator:(0,r.readByte)()}]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===249}),n=(0,t.conditional)({image:[{code:(0,r.readByte)()},{descriptor:[{left:(0,r.readUnsigned)(!0)},{top:(0,r.readUnsigned)(!0)},{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{lct:(0,r.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,t.conditional)({lct:(0,r.readArray)(3,function(f,h,v){return Math.pow(2,v.descriptor.lct.size+1)})},function(f,h,v){return v.descriptor.lct.exists}),{data:[{minCodeSize:(0,r.readByte)()},a]}]},function(f){return(0,r.peekByte)()(f)===44}),s=(0,t.conditional)({text:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{preData:function(h,v,g){return(0,r.readBytes)(g.text.blockSize)(h)}},a]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===1}),o=(0,t.conditional)({application:[{codes:(0,r.readBytes)(2)},{blockSize:(0,r.readByte)()},{id:function(h,v,g){return(0,r.readString)(g.blockSize)(h)}},a]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===255}),l=(0,t.conditional)({comment:[{codes:(0,r.readBytes)(2)},a]},function(f){var h=(0,r.peekBytes)(2)(f);return h[0]===33&&h[1]===254}),u=[{header:[{signature:(0,r.readString)(3)},{version:(0,r.readString)(3)}]},{lsd:[{width:(0,r.readUnsigned)(!0)},{height:(0,r.readUnsigned)(!0)},{gct:(0,r.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,r.readByte)()},{pixelAspectRatio:(0,r.readByte)()}]},(0,t.conditional)({gct:(0,r.readArray)(3,function(f,h){return Math.pow(2,h.lsd.gct.size+1)})},function(f,h){return h.lsd.gct.exists}),{frames:(0,t.loop)([i,o,l,n,s],function(f){var h=(0,r.peekByte)()(f);return h===33||h===44})}],c=u;e.default=c})(Ht);var Ee={};Object.defineProperty(Ee,"__esModule",{value:!0});Ee.deinterlace=void 0;var Ms=function(t,r){for(var a=new Array(t.length),i=t.length/r,n=function(h,v){var g=t.slice(v*r,(v+1)*r);a.splice.apply(a,[h*r,r].concat(g))},s=[0,4,2,1],o=[8,8,4,2],l=0,u=0;u<4;u++)for(var c=s[u];c<i;c+=o[u])n(c,l),l++;return a};Ee.deinterlace=Ms;var Ae={};Object.defineProperty(Ae,"__esModule",{value:!0});Ae.lzw=void 0;var Ss=function(t,r,a){var i=4096,n=-1,s=a,o,l,u,c,f,h,v,d,g,w,b,A,x,m,V,D,P=new Array(a),I=new Array(i),k=new Array(i),y=new Array(i+1);for(A=t,l=1<<A,f=l+1,o=l+2,v=n,c=A+1,u=(1<<c)-1,g=0;g<l;g++)I[g]=0,k[g]=g;var b,d,x,m,D,V;for(b=d=x=m=D=V=0,w=0;w<s;){if(m===0){if(d<c){b+=r[V]<<d,d+=8,V++;continue}if(g=b&u,b>>=c,d-=c,g>o||g==f)break;if(g==l){c=A+1,u=(1<<c)-1,o=l+2,v=n;continue}if(v==n){y[m++]=k[g],v=g,x=g;continue}for(h=g,g==o&&(y[m++]=x,g=v);g>l;)y[m++]=k[g],g=I[g];x=k[g]&255,y[m++]=x,o<i&&(I[o]=v,k[o]=x,o++,!(o&u)&&o<i&&(c++,u+=o)),v=h}m--,P[D++]=y[m],w++}for(w=D;w<s;w++)P[w]=0;return P};Ae.lzw=Ss;Object.defineProperty(j,"__esModule",{value:!0});var Vt=j.decompressFrames=j.decompressFrame=Zt=j.parseGIF=void 0,Ps=Is(Ht),bs=W,Os=R,Rs=Ee,ks=Ae;function Is(e){return e&&e.__esModule?e:{default:e}}var $s=function(t){var r=new Uint8Array(t);return(0,bs.parse)((0,Os.buildStream)(r),Ps.default)},Zt=j.parseGIF=$s,Ds=function(t){for(var r=t.pixels.length,a=new Uint8ClampedArray(r*4),i=0;i<r;i++){var n=i*4,s=t.pixels[i],o=t.colorTable[s]||[0,0,0];a[n]=o[0],a[n+1]=o[1],a[n+2]=o[2],a[n+3]=s!==t.transparentIndex?255:0}return a},Kt=function(t,r,a){if(!t.image){console.warn("gif frame does not have associated image.");return}var i=t.image,n=i.descriptor.width*i.descriptor.height,s=(0,ks.lzw)(i.data.minCodeSize,i.data.blocks,n);i.descriptor.lct.interlaced&&(s=(0,Rs.deinterlace)(s,i.descriptor.width));var o={pixels:s,dims:{top:t.image.descriptor.top,left:t.image.descriptor.left,width:t.image.descriptor.width,height:t.image.descriptor.height}};return i.descriptor.lct&&i.descriptor.lct.exists?o.colorTable=i.lct:o.colorTable=r,t.gce&&(o.delay=(t.gce.delay||10)*10,o.disposalType=t.gce.extras.disposal,t.gce.extras.transparentColorGiven&&(o.transparentIndex=t.gce.transparentColorIndex)),a&&(o.patch=Ds(o)),o};j.decompressFrame=Kt;var Fs=function(t,r){return t.frames.filter(function(a){return a.image}).map(function(a){return Kt(a,t.gct,r)})};Vt=j.decompressFrames=Fs;function Bs(e){const t=Zt(e),r=Vt(t,!0),a=[];for(let i of r){const{width:n,height:s,left:o,top:l}=i.dims,u=document.createElement("canvas"),c=u.getContext("2d");u.width=n,u.height=s,c.putImageData(new ImageData(i.patch,n,s),o,l),a.push(u)}return a}async function zs(e){const t=new ImageDecoder({data:e,type:"image/gif"});await t.tracks.ready,await t.completed;const r=t.tracks.selectedTrack.frameCount,a=[];for(let i=0;i<r;i++){const n=(await t.decode({frameIndex:i})).image;n.width=n.codedWidth,n.height=n.codedHeight,a.push(fe(n)),n.close()}return a}async function Ls(e){const t=await e.arrayBuffer();return window.ImageDecoder?zs(t):Bs(t)}const Ns={frameCount:0,startTime:0};class Us{constructor(t,r=1){p(this,"blob");p(this,"video");p(this,"length");p(this,"frames");p(this,"initPromise");this.blob=t,this.length=r,this.initPromise=this.init()}setFrameCount(t){return this.length=t,this.initPromise=this.init(),this}async init(){this.frames=[];const t=document.createElement("video");t.src=URL.createObjectURL(this.blob)+"#t=0.0001",await new Promise(i=>t.addEventListener("loadeddata",i));const{startTime:r}=Ns,a=(this.video.duration-r)/this.length;for(let i=0;i<this.length;i++)this.video.currentTime=i*a+r,await new Promise(n=>this.video.oncanplay=n),this.frames[i]=fe(this.video)}async getFrames(){return await this.initPromise,this.frames}}async function qs(e,t){if(t=t,t<0)throw new Error(`video frame count ${t} must >1`);return new Us(e,t).getFrames()}var Ws=(e=>(e.FROM="FROM",e.TO="TO",e.GROUP="GROUP",e.BOT="BOT",e.RANDOM="RANDOM",e))(Ws||{}),Gs=(e=>(e.ZOOM="ZOOM",e.DEFORM="DEFORM",e))(Gs||{}),Xs=(e=>(e.NONE="NONE",e.PIXEL="PIXEL",e.PERCENT="PERCENT",e))(Xs||{}),Hs=(e=>(e.CONTAIN="CONTAIN",e.COVER="COVER",e.FILL="FILL",e))(Hs||{}),Ys=(e=>(e.MIRROR="MIRROR",e.FLIP="FLIP",e.GRAY="GRAY",e.BINARIZATION="BINARIZATION",e))(Ys||{});const Vs={type:void 0,pos:void 0,posType:"ZOOM",crop:null,cropType:"NONE",style:[],fit:"FILL",round:!1,rotate:!1,avatarOnTop:!0,antialias:!0,resampling:!1,angle:0,opacity:1};function Zs(e){if(e.compiled)return e;const t={...Vs,...e},r=t.pos;let a;switch(t.posType){case"ZOOM":a=typeof r[0]!="object"?[re(r,4)]:r.map(i=>re(i,4)),t.pos=a.map(i=>i.map(n=>typeof n=="number"?n:H.parse(n)));break;case"DEFORM":try{a=r.map(i=>re(i,5).map(n=>re(n,2)))}catch{a=[re(r,5).map(n=>re(n,2))]}t.pos=a.map(i=>i.map(n=>n.map(s=>typeof s=="number"?s:H.parse(s))));break}return t.compiled=!0,t}class Ks extends cr{constructor(r,a,i){super();p(this,"type");p(this,"template");p(this,"originBlob");p(this,"frames");p(this,"pos");p(this,"initPromise");p(this,"deformer");this.type=r.type;const n=i&&i[this.type.toString().toLowerCase()];if(this.template=Zs(n?{...r,...n}:r),this.originBlob=a[this.type.toString().toLowerCase()],!this.originBlob)throw new Error(`no ${this.type} image`);this.initPromise=this.init()}async init(){await this.loadFile(),await this.updateTemplate()}async updateTemplate(){await this.setCrop(),await this.setStyle(),await this.setRound(),await this.setPos()}async loadFile(){const r=this.originBlob;if(r.type.startsWith("video/"))this.frames=await qs(r,this.template.pos.length);else if(!r.type.startsWith("image"))throw new Error("不支持的格式: "+r.type);r.type==="image/gif"?this.frames=await Ls(r):this.frames=[await me(r)]}setCrop(){const r=this.template.cropType;r!=="NONE"&&(this.frames=this.frames.map(a=>pt(a,this.template.crop,r==="PERCENT")))}setStyle(){for(const r of this.template.style)switch(r){case"FLIP":this.frames=this.frames.map(fr);break;case"MIRROR":this.frames=this.frames.map(mn);break;case"GRAY":this.frames=this.frames.map(dr);break;case"BINARIZATION":this.frames=this.frames.map(xn);break;default:throw new Error("unknown style "+r)}}setRound(){this.template.round&&(this.frames=this.frames.map(yn))}async setPos(){switch(this.template.posType){case"ZOOM":this.pos=this.template.pos.map(r=>r.map(this.evalExpression));break;case"DEFORM":this.deformer=new gn,this.pos=this.template.pos.map(r=>r.map(a=>a.map(this.evalExpression)));break}}evalExpression(r){return typeof r=="number"?r:r.evaluate({height:this.frames[0].height,width:this.frames[0].width})}getFrame(r){return r<this.frames.length?this.frames[r]:this.frames.at(-1)}getPos(r){return r<this.pos.length?this.pos[r]:this.pos.at(-1)}async getLength(){return await this.initPromise,{posLength:this.pos.length,frameLength:this.frames.length}}async draw(r,a=0){await this.initPromise;let i=this.getFrame(a);const n=this.getPos(a);let{angle:s,opacity:o,rotate:l}=this.template;switch(r.globalAlpha=o,l&&(s+=360/this.pos.length*a),this.template.posType){case"ZOOM":const[u,c,f,h]=n;switch(s&&(r.save(),r.translate(u+f/2,c+h/2),r.rotate(s*Math.PI/180),r.translate(-u-f/2,-c-h/2)),this.template.fit){case"FILL":r.drawImage(i,u,c,f,h);break;default:const v=Math[this.template.fit==="CONTAIN"?"min":"max"](f/i.width,h/i.height),g=i.width*v,w=i.height*v,A=u+(f-g)/2,P=c+(h-w)/2;if(this.template.fit==="CONTAIN")r.drawImage(i,A,P,g,w);else{const I=g-f,k=w-h,y=I/v/2,b=k/v/2;r.drawImage(pt(i,[y,b,i.width-y,i.height-b]),A+I/2,P+k/2,g-I,w-k)}break}r.restore();break;case"DEFORM":this.deformer.draw(r,i,n);break}r.globalAlpha=1}get onTop(){return this.template.avatarOnTop}async getSize(){await this.initPromise;const r=this.frames[0];return{width:r.width,height:r.height}}}class ht{constructor(t){p(this,"arr");p(this,"initPromise");p(this,"topAvatars",[]);p(this,"bottomAvatars",[]);p(this,"sizeMap",Object.create(null));p(this,"maxLength");this.arr=t,this.initPromise=this.init()}async init(){return Promise.all(this.arr.map(async(t,r)=>{t.onTop?this.topAvatars.push(t):this.bottomAvatars.push(t);const a=await t.getSize();this.sizeMap[`avatar${r}Width`]=a.width,this.sizeMap[`avatar${r}Height`]=a.height,this.maxLength=await t.getLength()}))}async getSizeMap(){return await this.initPromise,this.sizeMap}async getMaxLength(){return await this.initPromise,this.maxLength||{posLength:0,frameLength:void 0}}static createFrom(t,r,a){return new ht(t.map(i=>new Ks(i,r,a)))}}const Qs=hr();class Qt{constructor(t,r,a){p(this,"obj");p(this,"container");p(this,"attrMap");if(this.obj=t,this.container=document.createElement(a?"fieldset":"div"),a&&this.container.appendChild(er(a,"legend")),this.container.classList.add("setting-container"),this.attrMap=r??{},this.obj._delete){const i=this.obj._delete;delete this.obj._delete,this.obj.delete=()=>{typeof i=="function"&&i(),this.container.remove()}}for(const[i,n]of Object.entries(this.obj)){if(n==null)continue;const s=this.createElement(i,n);this.container.appendChild(s)}}createElement(t,r){const a=this.attrMap[t]??{};let i=document.createElement("div");const n=document.createElement("label");switch(n.textContent=Qs[t]??t,i.appendChild(n),a.type){case"font":const o=document.createElement("select");return o.addEventListener("change",()=>this.obj[t]=o.value),document.fonts.forEach(u=>{const c=u.family,f=document.createElement("option");f.style.fontFamily=c,f.value=c,f.textContent=c,f.selected=c===this.obj[t],o.appendChild(f)}),i.appendChild(o),i;case"select":const l=document.createElement("select");return l.addEventListener("change",()=>this.obj[t]=l.value),a.options.forEach(u=>{const c=document.createElement("option");c.value=u,c.textContent=u,c.selected=u===r,l.appendChild(c)}),i.appendChild(l),i}let s=typeof r;switch(s){case"object":i=new Qt(r,a[t],t).render();break;case"function":const o=document.createElement("button");o.textContent=t,o.addEventListener("click",async()=>{o.disabled=!0,o.style.cursor="progress";try{await r()}finally{o.disabled=!1,o.style.cursor="pointer"}}),i.appendChild(o);break;default:const l=document.createElement("input");let u=()=>this.obj[t]=l.value;switch(typeof r){case"number":u=()=>this.obj[t]=parseFloat(l.value);break;case"string":s=/^#([A-Fa-f0-9]{6})$/.test(r)?"color":"text";break;case"boolean":s="checkbox",l.checked=r,u=()=>this.obj[t]=l.checked;break}l.type=s;for(let[c,f]of Object.entries(a))l[c]=f;l.value=r.toString(),l.addEventListener("input",u),i.appendChild(l);break}return i}render(){return this.container}}const Js=6;class ct{constructor(t){p(this,"hasTemplate",!1);p(this,"width");p(this,"height");p(this,"color");p(this,"frames");p(this,"loadingPromise");t&&([this.width,this.height]=t.size.map(r=>typeof r=="number"?r:H.parse(r)),this.color=Bt(this.color),this.hasTemplate=!0)}setUrl(t,r){this.loadingPromise=ct.fetchImages(t,r).then(a=>this.frames=a)}set images(t){this.frames=t}async generate(t){if(await this.loadingPromise,this.frames)return this.hasTemplate?this.frames.map(r=>{const a=this.getCtx(t);return a.drawImage(r,0,0),a.canvas}):this.frames;if(this.hasTemplate)return[this.getCtx(t).canvas];throw new Error("can not load background")}getCtx(t){const r=document.createElement("canvas"),a=n=>typeof n=="number"?n:n.evaluate(t);r.width=a(this.width),r.height=a(this.height);const i=r.getContext("2d");return i.fillStyle=this.color,i.fillRect(0,0,r.width,r.height),i}static async fetchImages(t,r){if(r!==void 0){if(r<=0)return[];const o=[];for(let l=0;l<r;l++)o.push(fetch(`${t}/${l}.png`).then(u=>u.blob()).then(me));return Promise.all(o)}let a=!1,i=new Set;const n=[];let s=0;for(;!a;){i.size>=Js&&await Promise.race(i);const o=s++,u=fetch(`${t}/${o}.png`).then(c=>c.blob()).then(me).then(c=>{n[o]=c}).catch(()=>a=!0).then(()=>i.delete(u));i.add(u)}return await Promise.all(i),n}}const js=document.createElement("canvas"),L=js.getContext("2d");L.textBaseline="alphabetic";L.textAlign="left";const Ft={text:"default text",color:"#191919",pos:[50,50],size:16,font:"arial",style:"PLAIN",wrap:"NONE",align:"CENTER",position:["LEFT","TOP"],strokeColor:"#ffffff",strokeSize:0},J=class{constructor(t=Ft){p(this,"template");p(this,"textStyle");p(this,"pixelSize");p(this,"defaultPixelSize");p(this,"width");p(this,"height");p(this,"backgroundSize");p(this,"drawOptions");p(this,"onChangeCallback");p(this,"disabled",!1);this.template={...Ft,...t},this.defaultPixelSize=t.size*J.dpiScale,this.pixelSize=this.defaultPixelSize,this.template.color=Bt(this.template.color),this.textStyle=this.template.style==="PLAIN"?"normal":this.template.style.toLowerCase(),this.template.font=this.template.font.replace(" ","-"),this.template.text=this.template.text.replace(J.TEXT_VAR_REGEX,(r,a)=>a),this.setDrawOptions()}set size(t){this.pixelSize=t*J.dpiScale,this.setDrawOptions()}setDrawOptions(){let{font:t,style:r,wrap:a}=this.template;L.font=`${this.textStyle} ${this.pixelSize}px ${t.replace(" ","-")}`,this.width=0,this.height=0;const i=this.template.text.split(`
`),n=[];let s=0;switch(a){case"NONE":{for(const o of i){const[l,u,c,f]=this.getPosition(L.measureText(o),s++);this.width=Math.max(this.width,c),this.height=f,n.push([o,l,u])}break}case"BREAK":{const o=this.template.pos[2]||J.DEFAULT_MAX_WIDTH;let l,u;for(let c of i)if(l=L.measureText(c),u=l.width,u>o){let f,h,v;for(;u>o;){for(f=0,h=0,v="";h<o;)f++,v=c.substr(0,f),h=L.measureText(c.substr(0,f)).width;f--,v=v.substr(0,f);const g=f;if(c.substr(f,1)!=" "){for(;c.substr(f,1)!=" "&&f!=0;)f--;f==0&&(f=g),v=c.substr(0,f)}c=c.substr(f);const[w,A,P,I]=this.getPosition(L.measureText(v),s++);this.width=Math.max(this.width,P),this.height=I,u=P,n.push([v,w,A])}}else{const[f,h,v,g]=this.getPosition(l,s++);this.width=Math.max(this.width,v),this.height=g,n.push([c,f,h])}break}case"ZOOM":{const o=this.template.pos[2]||J.DEFAULT_MAX_WIDTH;L.font=`${this.textStyle} ${this.defaultPixelSize}px ${t}`;let l=Math.max(...i.map(f=>L.measureText(f).width));const c=o/(l||1)*this.defaultPixelSize;this.pixelSize=c,L.font=`${this.textStyle} ${c}px ${t}`;for(const f of i){const[h,v,g,w]=this.getPosition(L.measureText(f),s++);this.width=Math.max(this.width,g),this.height=w,n.push([f,h,v])}break}}return this.drawOptions=n,n}getPosition(t,r){const[a,i]=this.template.pos,n=t.width,s=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent,o=s*r,l=s*(r+1);switch(this.template.align){case"LEFT":return[a,i+o,n,l];case"RIGHT":return[a-n,i+o,n,l];case"CENTER":return[a-n/2,i+o,n,l]}}get hidden(){return this.disabled}set hidden(t){this.disabled=t,this.onChangeCallback&&this.onChangeCallback(this)}get size(){return this.template.size}draw(t){if(this.disabled)return;let{color:r,align:a,font:i,strokeColor:n,strokeSize:s}=this.template;t.font=`${this.textStyle} ${this.pixelSize}px ${i}`,t.fillStyle=r,t.textBaseline=a==="CENTER"?"middle":"alphabetic";for(let o of this.drawOptions)t.fillText(...o);if(n&&s){t.strokeStyle=n,t.lineWidth=s;for(let o of this.drawOptions)t.strokeText(...o)}}get settingObject(){const t=this;return new Proxy({get x(){return t.template.pos[0]},set x(r){t.template.pos[0]=r},get y(){return t.template.pos[1]},set y(r){t.template.pos[1]=r},text:t.template.text,color:t.template.color,get size(){return t.template.wrap==="ZOOM"?void 0:t.pixelSize},set size(r){t.pixelSize=r},font:t.template.font,strokeSize:t.template.strokeSize,strokeColor:t.template.strokeColor,get hidden(){return t.disabled},set hidden(r){t.hidden=r},_delete:()=>t.hidden=!0},{set:(r,a,i)=>(r[a]=i,t.template[a]=i,t.disabled||(this.setDrawOptions(),t.onChangeCallback&&t.onChangeCallback(this)),!0)})}get settingAttributes(){const t={type:"range",min:0,step:1};return{x:{...t,max:this.backgroundSize?this.backgroundSize[0]:1e3},y:{...t,max:this.backgroundSize?this.backgroundSize[1]:1e3},size:{...t,max:256},strokeSize:{...t,max:16},font:{type:"font"}}}set onchange(t){this.onChangeCallback=t}};let Q=J;p(Q,"TEXT_VAR_REGEX",/\$txt\d+\[(.*?)]/g),p(Q,"DEFAULT_MAX_WIDTH",300),p(Q,"dpiScale",(window.devicePixelRatio||1)*96/72);class ft{constructor(t){p(this,"arr");p(this,"cacheCtx");p(this,"topAvatars",[]);p(this,"bottomAvatars",[]);p(this,"sizeMap",Object.create(null));p(this,"needUpdate",!1);p(this,"cacheCount",0);if(this.arr=t,!(t!=null&&t.length))return;let r=0;for(const a of t)a.onchange=()=>this.needUpdate=!0,this.sizeMap[`text${r}Width`]=a.width,this.sizeMap[`text${r}Height`]=a.height,r++}draw(t){for(const r of this.arr)r.draw(t)}setCacheArea(t,r){for(const i of this.arr)i.backgroundSize=[t,r];const a=document.createElement("canvas");a.width=t,a.height=r,this.cacheCtx=a.getContext("2d"),this.drawCache()}drawCache(){this.draw(this.cacheCtx)}updateCache(){this.cacheCtx.clearRect(0,0,this.cacheCtx.canvas.width,this.cacheCtx.canvas.height),this.drawCache(),this.needUpdate=!1,this.cacheCount++}get cacheCanvas(){return this.needUpdate&&this.updateCache(),this.cacheCtx.canvas}addTextModel(){const t=new Q;return this.arr.push(t),this.needUpdate=!0,t.onchange=()=>this.needUpdate=!0,t.backgroundSize=[this.cacheCtx.canvas.width,this.cacheCtx.canvas.height],t}get texts(){return this.arr}static createFrom(t){return new ft(t.map(r=>new Q(r)))}}var eo=(e=>(e.IMG="IMG",e.GIF="GIF",e))(eo||{});const to={type:void 0,avatar:[],text:[],background:void 0,delay:65,alias:[],inRandomList:!0,reverse:!1,hidden:!1};class uo{constructor(t,r){p(this,"type");p(this,"template");p(this,"initPromise");p(this,"avatarList");p(this,"backgroundModel");p(this,"textModelList");p(this,"backgroundLength");this.template={...to,...t},this.type=t.type,this.textModelList=ft.createFrom(this.template.text),this.backgroundModel=new ct(this.template.background),r&&(this.background=r),this.initPromise=this.init()}set background(t){if(typeof t=="string")this.backgroundModel.setUrl(t,this.backgroundLength);else if(Array.isArray(t))this.backgroundModel.images=t;else throw new Error("unknown background",t)}async init(){}async generate(t,r){const a=ht.createFrom(this.template.avatar,t,r),i=await a.getSizeMap(),n=await this.backgroundModel.generate(i);return new ro(this.template,n,a,this.textModelList)}}class ro{constructor(t,r,a,i){p(this,"template");p(this,"canvas");p(this,"ctx");p(this,"backgrounds");p(this,"avatars");p(this,"texts");p(this,"length");p(this,"intervalId");p(this,"initPromise");p(this,"userDelay");p(this,"i",0);p(this,"framesCache",[]);p(this,"resolveFramesCachedPromise");p(this,"framesCachedPromise",new Promise(t=>this.resolveFramesCachedPromise=t));p(this,"prevTextCacheCount");p(this,"prevTextedFramesCache");const n=document.createElement("canvas");this.canvas=n,n.width=r[0].width,n.height=r[0].height,this.ctx=n.getContext("2d"),this.template=t,this.backgrounds=r,this.avatars=a,this.texts=i,this.texts.setCacheArea(n.width,n.height),this.initPromise=this.init()}async init(){const{posLength:t,frameLength:r=this.backgrounds.length}=await this.avatars.getMaxLength();this.length=this.template.type==="IMG"?r:this.backgrounds.length}async replay(){return this.i=0,await this.play(),new Promise(t=>setTimeout(t,this.delay*this.length))}async play(){if(await this.stop(),this.template.reverse)return this.playReverse();this.intervalId=window.setInterval(async()=>{await this.drawAvatarsCache(this.i++%this.length),this.drawTextsCache()},Math.abs(this.delay))}playReverse(){this.intervalId=window.setInterval(async()=>{await this.drawAvatarsCache(this.length-1-this.i++%this.length),this.drawTextsCache()},Math.abs(this.delay))}async stop(){await this.initPromise,clearInterval(this.intervalId)}set delay(t){if(!t){this.stop();return}this.userDelay=t,t>0?this.play():this.stop().then(()=>this.playReverse())}get delay(){return this.userDelay||this.template.delay}getBackground(t){return t<this.backgrounds.length?this.backgrounds[t]:this.backgrounds.at(-1)}async getFrames(){return await this.framesCachedPromise,this.framesCache}async getTextedFrames(){const t=await this.getFrames();return this.texts.texts.length===0?t:this.prevTextCacheCount===this.texts.cacheCount?this.prevTextedFramesCache:(this.prevTextedFramesCache=t.map(r=>{const a=fe(r);return a.getContext("2d").drawImage(this.texts.cacheCanvas,0,0),a}),this.prevTextCacheCount=this.texts.cacheCount,this.prevTextedFramesCache)}drawTextsCache(){this.ctx.drawImage(this.texts.cacheCanvas,0,0)}drawTexts(){this.texts.draw(this.ctx)}async drawAvatarsCache(t){if(this.framesCache[t]){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.framesCache[t],0,0);return}await this.drawAvatars(t),this.framesCache[t]=fe(this.canvas,!0),this.framesCache.length===this.length&&this.resolveFramesCachedPromise()}async drawAvatars(t){await this.initPromise,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const r of this.avatars.bottomAvatars)await r.draw(this.ctx,t);this.ctx.drawImage(this.getBackground(t),0,0);for(const r of this.avatars.topAvatars)await r.draw(this.ctx,t)}get settingObject(){const t=this;return this.length===1?{}:{set delay(r){t.delay=r},get delay(){return t.delay},play:()=>this.play(),stop:()=>this.stop()}}async destroy(){await this.stop(),this.canvas.remove()}}export{Ws as A,eo as P,Qt as S,lo as a,Vs as b,er as c,Ls as d,Hs as e,Gs as f,no as g,Ys as h,to as i,uo as j,hr as k,so as l,oo as m,me as n,Xs as o};
